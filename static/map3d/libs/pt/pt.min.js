"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pt(){}Pt.KeyCodes={DELETE:46},THREE.EventDispatcher.prototype.removeEventListeners=function(e){void 0!==this._listeners&&this._listeners[e]&&delete this._listeners[e]},THREE.PerspectiveCamera.prototype.zoomTo=function(e,t){if(e.geometry||e.boundingSphere||e.boundingBox){e.geometry&&null===e.geometry.boundingSphere&&e.geometry.computeBoundingSphere(),e.updateMatrixWorld();var n=void 0,i=t||1,r=(n=(n=e.boundingSphere?e.boundingSphere:e.geometry&&e.geometry.boundingSphere?e.geometry.boundingSphere:e.boundingBox.getBoundingSphere(new THREE.Sphere)).clone().applyMatrix4(e.matrixWorld)).radius,o=this.fov*Math.PI/180;this.aspect<1&&(o*=this.aspect);var a=Math.abs(r/Math.sin(o/2))*i,s=this.getWorldDirection(new THREE.Vector3).multiplyScalar(-a);this.position.copy(n.center.clone().add(s))}},THREE.OrthographicCamera.prototype.zoomTo=function(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1];(e.geometry||e.boundingBox)&&this.updateProjectionMatrix()},THREE.Ray.prototype.distanceToPlaneWithNegative=function(e){var t=e.normal.dot(this.direction);return 0===t?0===e.distanceToPoint(this.origin)?0:null:-(this.origin.dot(e.normal)+e.constant)/t},Pt.version={major:1,minor:6,suffix:""},Pt.pointBudget=1e6,Pt.framenumber=0,Pt.numNodesLoading=0,Pt.maxNodesLoading=4,Pt.Shaders={},Pt.webgl={shaders:{},vaos:{},vbos:{}},Pt.debug={},Pt.scriptPath=null,document.currentScript.src?(Pt.scriptPath=new URL(document.currentScript.src+"/..").href,"/"===Pt.scriptPath.slice(-1)&&(Pt.scriptPath=Pt.scriptPath.slice(0,-1))):console.error("Pt was unable to find its script path using document.currentScript. Is Pt included with a script tag? Does your browser support this function?"),Pt.resourcePath=Pt.scriptPath+"/resources";var EnumItem=function(){function s(e){_classCallCheck(this,s);var t=!0,n=!1,i=void 0;try{for(var r,o=Object.keys(e)[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;this[a]=e[a]}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}return _createClass(s,[{key:"inspect",value:function(){return"Enum("+this.name+": "+this.value+")"}}]),s}(),Enum=function(){function l(e){_classCallCheck(this,l),this.object=e;var t=!0,n=!1,i=void 0;try{for(var r,o=Object.keys(e)[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value,s=e[a];"object"===(void 0===s?"undefined":_typeof(s))?s.name=a:s={name:a,value:s},this[a]=new EnumItem(s)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}return _createClass(l,[{key:"fromValue",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=Object.keys(this.object)[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;if(this[a].value===e)return this[a]}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}throw new Error("No enum for value: "+e)}}]),l}();Pt.CameraMode={ORTHOGRAPHIC:0,PERSPECTIVE:1},Pt.ClipTask={NONE:0,HIGHLIGHT:1,SHOW_INSIDE:2,SHOW_OUTSIDE:3},Pt.ClipMethod={INSIDE_ANY:0,INSIDE_ALL:1},Pt.MOUSE={LEFT:1,RIGHT:2,MIDDLE:4},Pt.timerQueries={},Pt.measureTimings=!1,Pt.startQuery=function(e,t){var n=t.getExtension("EXT_disjoint_timer_query");if(n){void 0===Pt.timerQueries[e]&&(Pt.timerQueries[e]=[]);var i=n.createQueryEXT();return n.beginQueryEXT(n.TIME_ELAPSED_EXT,i),Pt.timerQueries[e].push(i),i}},Pt.endQuery=function(e,t){var n=t.getExtension("EXT_disjoint_timer_query");n&&n.endQueryEXT(n.TIME_ELAPSED_EXT)},Pt.resolveQueries=function(e){var t=e.getExtension("EXT_disjoint_timer_query"),n=new Map;for(var i in Pt.timerQueries){var r=Pt.timerQueries[i],o=[],a=!0,s=!1,l=void 0;try{for(var u,c=r[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var h=u.value,d=t.getQueryObjectEXT(h,t.QUERY_RESULT_AVAILABLE_EXT),p=e.getParameter(t.GPU_DISJOINT_EXT);if(d&&!p){var v=t.getQueryObjectEXT(h,t.QUERY_RESULT_EXT)/1e6;n.get(i)||n.set(i,[]),n.get(i).push(v)}else o.push(h)}}catch(e){s=!0,l=e}finally{try{!a&&c.return&&c.return()}finally{if(s)throw l}}0===o.length?delete Pt.timerQueries[i]:Pt.timerQueries[i]=o}return n},Pt.toMaterialID=function(e){return"RGB"===e?Pt.PointColorType.RGB:"Color"===e?Pt.PointColorType.COLOR:"Elevation"===e?Pt.PointColorType.HEIGHT:"Intensity"===e?Pt.PointColorType.INTENSITY:"Intensity Gradient"===e?Pt.PointColorType.INTENSITY_GRADIENT:"Classification"===e?Pt.PointColorType.CLASSIFICATION:"Return Number"===e?Pt.PointColorType.RETURN_NUMBER:"Source"===e?Pt.PointColorType.SOURCE:"Level of Detail"===e?Pt.PointColorType.LOD:"Point Index"===e?Pt.PointColorType.POINT_INDEX:"Normal"===e?Pt.PointColorType.NORMAL:"Phong"===e?Pt.PointColorType.PHONG:"Index"===e?Pt.PointColorType.POINT_INDEX:"RGB and Elevation"===e?Pt.PointColorType.RGB_HEIGHT:"Composite"===e?Pt.PointColorType.COMPOSITE:void 0},Pt.toMaterialName=function(e){return e===Pt.PointColorType.RGB?"RGB":e===Pt.PointColorType.COLOR?"Color":e===Pt.PointColorType.HEIGHT?"Elevation":e===Pt.PointColorType.INTENSITY?"Intensity":e===Pt.PointColorType.INTENSITY_GRADIENT?"Intensity Gradient":e===Pt.PointColorType.CLASSIFICATION?"Classification":e===Pt.PointColorType.RETURN_NUMBER?"Return Number":e===Pt.PointColorType.SOURCE?"Source":e===Pt.PointColorType.LOD?"Level of Detail":e===Pt.PointColorType.NORMAL?"Normal":e===Pt.PointColorType.PHONG?"Phong":e===Pt.PointColorType.POINT_INDEX?"Index":e===Pt.PointColorType.RGB_HEIGHT?"RGB and Elevation":e===Pt.PointColorType.COMPOSITE?"Composite":void 0},Pt.getMeasurementIcon=function(e){return e instanceof Pt.Measure?!e.showDistances||e.showArea||e.showAngles?e.showDistances&&e.showArea&&!e.showAngles?Pt.resourcePath+"/icons/area.svg":1===e.maxMarkers?Pt.resourcePath+"/icons/point.svg":e.showDistances||e.showArea||!e.showAngles?e.showHeight?Pt.resourcePath+"/icons/height.svg":Pt.resourcePath+"/icons/distance.svg":Pt.resourcePath+"/icons/angle.png":Pt.resourcePath+"/icons/distance.svg":e instanceof Pt.Profile?Pt.resourcePath+"/icons/profile.svg":e instanceof Pt.Volume?Pt.resourcePath+"/icons/volume.svg":e instanceof Pt.PolygonClipVolume?Pt.resourcePath+"/icons/clip-polygon.svg":void 0},Pt.Points=function(){function e(){_classCallCheck(this,e),this.boundingBox=new THREE.Box3,this.numPoints=0,this.data={}}return _createClass(e,[{key:"add",value:function(e){var t=this.numPoints,n=t+e.numPoints,i=Object.keys(this.data),r=Object.keys(e.data),o=new Set([].concat(_toConsumableArray(i),_toConsumableArray(r))),a=!0,s=!1,l=void 0;try{for(var u,c=o[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var h=u.value;if(i.includes(h)&&r.includes(h)){var d=new this.data[h].constructor(this.data[h].length+e.data[h].length);d.set(this.data[h],0),d.set(e.data[h],this.data[h].length),this.data[h]=d}else if(i.includes(h)&&!r.includes(h)){var p=this.data[h].length/this.numPoints,v=new this.data[h].constructor(p*n);v.set(this.data[h],0),this.data[h]=v}else if(!i.includes(h)&&r.includes(h)){var f=e.data[h].length/e.numPoints,m=new e.data[h].constructor(f*n);m.set(e.data[h],f*t),this.data[h]=m}}}catch(e){s=!0,l=e}finally{try{!a&&c.return&&c.return()}finally{if(s)throw l}}this.numPoints=n,this.boundingBox.union(e.boundingBox)}}]),e}(),Pt.loadPointCloud=function(n,t,i){var r=function(e){e.name=t,i({type:"pointcloud_loaded",pointcloud:e})};n&&(0===n.indexOf("greyhound://")?Pt.GreyhoundLoader.load(n,function(e){if(e){var t=new Pt.PointCloudOctree(e);r(t)}else console.error(new Error("failed to load point cloud from URL: "+n))}):0<n.indexOf("cloud.js")?Pt.POCLoader.load(n,function(e){if(e){var t=new Pt.PointCloudOctree(e);r(t)}else console.error(new Error("failed to load point cloud from URL: "+n))}):0<n.indexOf(".vpc")?Pt.PointCloudArena4DGeometry.load(n,function(e){if(e){var t=new Pt.PointCloudArena4D(e);r(t)}else console.error(new Error("failed to load point cloud from URL: "+n))}):console.error(new Error("failed to load point cloud from URL: "+n)))},Pt.updatePointClouds=function(e,t,n){Pt.lru||(Pt.lru=new LRU);var i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value,u=performance.now(),c=!0,h=!1,d=void 0;try{for(var p,v=l.profileRequests[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){if(p.value.update(),5<performance.now()-u)break}}catch(e){h=!0,d=e}finally{try{!c&&v.return&&v.return()}finally{if(h)throw d}}performance.now()}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}var f=Pt.updateVisibility(e,t,n),m=!0,g=!1,y=void 0;try{for(var E,T=e[Symbol.iterator]();!(m=(E=T.next()).done);m=!0){var P=E.value;P.updateMaterial(P.material,P.visibleNodes,t,n),P.updateVisibleBounds()}}catch(e){g=!0,y=e}finally{try{!m&&T.return&&T.return()}finally{if(g)throw y}}return Pt.getLRU().freeMemory(),f},Pt.getLRU=function(){return Pt.lru||(Pt.lru=new LRU),Pt.lru},Pt.updateVisibilityStructures=function(e,t,n){for(var i=[],r=[],o=new BinaryHeap(function(e){return 1/e.weight}),a=0;a<e.length;a++){var s=e[a];if(s.initialized()){s.numVisibleNodes=0,s.numVisiblePoints=0,s.deepestVisibleLevel=0,s.visibleNodes=[],s.visibleGeometry=[],t.updateMatrixWorld();var l=new THREE.Frustum,u=t.matrixWorldInverse,c=s.matrixWorld,h=t.clone();h.near=Math.min(t.near,.1),h.updateProjectionMatrix();var d=t.projectionMatrix,p=(new THREE.Matrix4).multiply(d).multiply(u).multiply(c);l.setFromMatrix(p),i.push(l);var v=t.matrixWorld,f=(new THREE.Matrix4).getInverse(c),m=(new THREE.Matrix4).multiply(f).multiply(v),g=(new THREE.Vector3).setFromMatrixPosition(m);r.push(g),s.visible&&null!==s.root&&o.push({pointcloud:a,node:s.root,weight:Number.MAX_VALUE}),s.root.isTreeNode()&&s.hideDescendants(s.root.sceneNode);for(var y=0;y<s.boundingBoxNodes.length;y++)s.boundingBoxNodes[y].visible=!1}}return{frustums:i,camObjPositions:r,priorityQueue:o}},Pt.updateVisibility=function(l,e,t){var n=0,i=new Map(l.map(function(e){return[e,0]})),r=[],o=[],a=[],s=1/0,u=Pt.updateVisibilityStructures(l,e,t),c=u.frustums,h=u.camObjPositions,d=u.priorityQueue,p=0,v=(t.domElement.clientWidth,t.domElement.clientHeight);Pt._pointcloudTransformVersion||(Pt._pointcloudTransformVersion=new Map);var f=Pt._pointcloudTransformVersion,m=!0,g=!1,y=void 0;try{for(var E,T=l[Symbol.iterator]();!(m=(E=T.next()).done);m=!0){var P=E.value;if(P.visible)if(P.updateMatrixWorld(),f.has(P)){var b=f.get(P);b.transform.equals(P.matrixWorld)||(b.number++,b.transform.copy(P.matrixWorld),P.dispatchEvent({type:"transformation_changed",target:P}))}else f.set(P,{number:0,transform:P.matrixWorld.clone()})}}catch(e){g=!0,y=e}finally{try{!m&&T.return&&T.return()}finally{if(g)throw y}}for(;0<d.size();){var w=d.pop(),x=w.node,_=w.parent,R=l[w.pointcloud],C=x.getBoundingBox(),S=c[w.pointcloud],A=h[w.pointcloud],H=S.intersectsBox(C),k=R.maxLevel||1/0,L=x.getLevel(),M=H;if(M=(M=(M=M&&!(n+x.getNumPoints()>Pt.pointBudget))&&!(i.get(R)+x.getNumPoints()>R.pointBudget))&&L<k,x.spacing?s=Math.min(s,x.spacing):x.geometryNode&&x.geometryNode.spacing&&(s=Math.min(s,x.geometryNode.spacing)),n+x.getNumPoints()>Pt.pointBudget)break;if(M){n+=x.getNumPoints();var D=i.get(R);if(i.set(R,D+x.getNumPoints()),R.numVisibleNodes++,R.numVisiblePoints+=x.getNumPoints(),!x.isGeometryNode()||_&&!_.isTreeNode()||(x.isLoaded()&&p<2?(x=R.toTreeNode(x,_),p++):(a.push(x),o.push(x))),x.isTreeNode()){Pt.getLRU().touch(x.geometryNode),x.sceneNode.visible=!0,x.sceneNode.material=R.material,r.push(x),R.visibleNodes.push(x),void 0===x._transformVersion&&(x._transformVersion=-1);var B=f.get(R);if(x._transformVersion!==B.number&&(x.sceneNode.updateMatrix(),x.sceneNode.matrixWorld.multiplyMatrices(R.matrixWorld,x.sceneNode.matrix),x._transformVersion=B.number),R.showBoundingBox&&!x.boundingBoxNode&&x.getBoundingBox){var N=new Pt.Box3Helper(x.getBoundingBox());N.matrixAutoUpdate=!1,R.boundingBoxNodes.push(N),x.boundingBoxNode=N,x.boundingBoxNode.matrix.copy(R.matrixWorld)}else R.showBoundingBox?(x.boundingBoxNode.visible=!0,x.boundingBoxNode.matrix.copy(R.matrixWorld)):!R.showBoundingBox&&x.boundingBoxNode&&(x.boundingBoxNode.visible=!1)}for(var I=x.getChildren(),O=0;O<I.length;O++){var V=I[O],z=0;if(e.isPerspectiveCamera){var U=V.getBoundingSphere(),F=U.center,G=A.x-F.x,j=A.y-F.y,W=A.z-F.z,X=G*G+j*j+W*W,Y=Math.sqrt(X),q=U.radius,Q=e.fov*Math.PI/180,K=q*(.5*v/(Math.tan(Q/2)*Y));if(K<R.minimumNodePixelSize)continue;z=K,Y-q<0&&(z=Number.MAX_VALUE)}else{var $=V.getBoundingBox(),Z=V.getBoundingSphere().center.distanceTo(A);z=$.max.clone().sub($.min).length()/Z}d.push({pointcloud:w.pointcloud,node:V,parent:x,weight:z})}}}!function(){var e=l.filter(function(e){return e.generateDEM&&e.dem instanceof Pt.DEM}),t=!0,n=!1,i=void 0;try{for(var r,o=e[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value,s=a.visibleNodes.filter(function(e){return e.getLevel()<=4});a.dem.update(s)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}();for(var J=0;J<Math.min(Pt.maxNodesLoading,a.length);J++)a[J].load();return{visibleNodes:r,numVisiblePoints:n,lowestSpacing:s}},Pt.XHRFactory={config:{withCredentials:!1,customHeaders:[{header:null,value:null}]},createXMLHttpRequest:function(){var t=new XMLHttpRequest;if(this.config.customHeaders&&Array.isArray(this.config.customHeaders)&&0<this.config.customHeaders.length){var e=t.open,n=this.config.customHeaders;t.open=function(){e.apply(this,[].slice.call(arguments)),n.forEach(function(e){e.header&&e.value&&t.setRequestHeader(e.header,e.value)})}}return t}},function(p){p.fn.extend({selectgroup:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},l=p(this),u=""+l.prop("id"),t=void 0!==e.title?e.title:"",c=[];l.find("option").each(function(e,t){var n=p(t).prop("id"),i=p(t).html(),r=p(t).prop("value"),o=p('\n\t\t\t\t\t<span style="flex-grow: 1; display: inherit">\n\t\t\t\t\t<label for="'+n+'" class="ui-button" style="width: 100%; padding: .4em .1em">'+i+'</label>\n\t\t\t\t\t<input type="radio" name="'+u+'" id="'+n+'" value="'+r+'" style="display: none"/>\n\t\t\t\t\t</span>\n\t\t\t\t'),a=o.find("label"),s=o.find("input");s.change(function(){l.find("label").removeClass("ui-state-active"),l.find("label").addClass("ui-state-default"),s.is(":checked")&&a.addClass("ui-state-active")}),c.push(o)});var n=p('\n\t\t\t\t<fieldset style="border: none; margin: 0px; padding: 0px">\n\t\t\t\t\t<legend>'+t+'</legend>\n\t\t\t\t\t<span style="display: flex">\n\n\t\t\t\t\t</span>\n\t\t\t\t</fieldset>\n\t\t\t'),i=n.find("span"),r=!0,o=!1,a=void 0;try{for(var s,h=c[Symbol.iterator]();!(r=(s=h.next()).done);r=!0){var d=s.value;i.append(d)}}catch(e){o=!0,a=e}finally{try{!r&&h.return&&h.return()}finally{if(o)throw a}}i.find("label").each(function(e,t){p(t).css("margin","0px"),p(t).css("border-radius","0px"),p(t).css("border","1px solid black"),p(t).css("border-left","none")}),i.find("label:first").each(function(e,t){p(t).css("border-radius","4px 0px 0px 4px")}),i.find("label:last").each(function(e,t){p(t).css("border-radius","0px 4px 4px 0px"),p(t).css("border-left","none")}),l.empty(),l.append(n)}})}(jQuery),Pt.paramThreeToGL=function(e,t){var n=void 0;if(t===THREE.RepeatWrapping)return e.REPEAT;if(t===THREE.ClampToEdgeWrapping)return e.CLAMP_TO_EDGE;if(t===THREE.MirroredRepeatWrapping)return e.MIRRORED_REPEAT;if(t===THREE.NearestFilter)return e.NEAREST;if(t===THREE.NearestMipMapNearestFilter)return e.NEAREST_MIPMAP_NEAREST;if(t===THREE.NearestMipMapLinearFilter)return e.NEAREST_MIPMAP_LINEAR;if(t===THREE.LinearFilter)return e.LINEAR;if(t===THREE.LinearMipMapNearestFilter)return e.LINEAR_MIPMAP_NEAREST;if(t===THREE.LinearMipMapLinearFilter)return e.LINEAR_MIPMAP_LINEAR;if(t===THREE.UnsignedByteType)return e.UNSIGNED_BYTE;if(t===THREE.UnsignedShort4444Type)return e.UNSIGNED_SHORT_4_4_4_4;if(t===THREE.UnsignedShort5551Type)return e.UNSIGNED_SHORT_5_5_5_1;if(t===THREE.UnsignedShort565Type)return e.UNSIGNED_SHORT_5_6_5;if(t===THREE.ByteType)return e.BYTE;if(t===THREE.ShortType)return e.SHORT;if(t===THREE.UnsignedShortType)return e.UNSIGNED_SHORT;if(t===THREE.IntType)return e.INT;if(t===THREE.UnsignedIntType)return e.UNSIGNED_INT;if(t===THREE.FloatType)return e.FLOAT;if(t===THREE.HalfFloatType&&null!==(n=extensions.get("OES_texture_half_float")))return n.HALF_FLOAT_OES;if(t===THREE.AlphaFormat)return e.ALPHA;if(t===THREE.RGBFormat)return e.RGB;if(t===THREE.RGBAFormat)return e.RGBA;if(t===THREE.LuminanceFormat)return e.LUMINANCE;if(t===THREE.LuminanceAlphaFormat)return e.LUMINANCE_ALPHA;if(t===THREE.DepthFormat)return e.DEPTH_COMPONENT;if(t===THREE.DepthStencilFormat)return e.DEPTH_STENCIL;if(t===THREE.AddEquation)return e.FUNC_ADD;if(t===THREE.SubtractEquation)return e.FUNC_SUBTRACT;if(t===THREE.ReverseSubtractEquation)return e.FUNC_REVERSE_SUBTRACT;if(t===THREE.ZeroFactor)return e.ZERO;if(t===THREE.OneFactor)return e.ONE;if(t===THREE.SrcColorFactor)return e.SRC_COLOR;if(t===THREE.OneMinusSrcColorFactor)return e.ONE_MINUS_SRC_COLOR;if(t===THREE.SrcAlphaFactor)return e.SRC_ALPHA;if(t===THREE.OneMinusSrcAlphaFactor)return e.ONE_MINUS_SRC_ALPHA;if(t===THREE.DstAlphaFactor)return e.DST_ALPHA;if(t===THREE.OneMinusDstAlphaFactor)return e.ONE_MINUS_DST_ALPHA;if(t===THREE.DstColorFactor)return e.DST_COLOR;if(t===THREE.OneMinusDstColorFactor)return e.ONE_MINUS_DST_COLOR;if(t===THREE.SrcAlphaSaturateFactor)return e.SRC_ALPHA_SATURATE;if((t===THREE.RGB_S3TC_DXT1_Format||t===RGBA_S3TC_DXT1_Format||t===THREE.RGBA_S3TC_DXT3_Format||t===RGBA_S3TC_DXT5_Format)&&null!==(n=extensions.get("WEBGL_compressed_texture_s3tc"))){if(t===THREE.RGB_S3TC_DXT1_Format)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===THREE.RGBA_S3TC_DXT1_Format)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===THREE.RGBA_S3TC_DXT3_Format)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===THREE.RGBA_S3TC_DXT5_Format)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((t===THREE.RGB_PVRTC_4BPPV1_Format||t===THREE.RGB_PVRTC_2BPPV1_Format||t===THREE.RGBA_PVRTC_4BPPV1_Format||t===THREE.RGBA_PVRTC_2BPPV1_Format)&&null!==(n=extensions.get("WEBGL_compressed_texture_pvrtc"))){if(t===THREE.RGB_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===THREE.RGB_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===THREE.RGBA_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===THREE.RGBA_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(t===THREE.RGB_ETC1_Format&&null!==(n=extensions.get("WEBGL_compressed_texture_etc1")))return n.COMPRESSED_RGB_ETC1_WEBGL;if((t===THREE.MinEquation||t===THREE.MaxEquation)&&null!==(n=extensions.get("EXT_blend_minmax"))){if(t===THREE.MinEquation)return n.MIN_EXT;if(t===THREE.MaxEquation)return n.MAX_EXT}return t===UnsignedInt248Type&&null!==(n=extensions.get("WEBGL_depth_texture"))?n.UNSIGNED_INT_24_8_WEBGL:0},Pt.attributeLocations={position:0,color:1,intensity:2,classification:3,returnNumber:4,numberOfReturns:5,pointSourceID:6,indices:7,normal:8,spacing:9},Pt.Shader=function(){function r(e,t,n,i){_classCallCheck(this,r),this.gl=e,this.name=t,this.vsSource=n,this.fsSource=i,this.cache=new Map,this.vs=null,this.fs=null,this.program=null,this.uniformLocations={},this.attributeLocations={},this.update(n,i)}return _createClass(r,[{key:"update",value:function(e,t){this.vsSource=e,this.fsSource=t,this.linkProgram()}},{key:"compileShader",value:function(e,t){var n=this.gl;if(n.shaderSource(e,t),n.compileShader(e),!n.getShaderParameter(e,n.COMPILE_STATUS)){var i=n.getShaderInfoLog(e),r=t.split("\n").map(function(e,t){return(""+(t+1)).padEnd(5)+e}).join("\n");throw"could not compile shader "+this.name+": "+i+", \n"+r}}},{key:"linkProgram",value:function(){var e=this.gl;this.uniformLocations={},this.attributeLocations={},e.useProgram(null);var t=this.cache.get(this.vsSource+", "+this.fsSource);if(t)return this.program=t.program,this.vs=t.vs,this.fs=t.fs,this.attributeLocations=t.attributeLocations,void(this.uniformLocations=t.uniformLocations);this.vs=e.createShader(e.VERTEX_SHADER),this.fs=e.createShader(e.FRAGMENT_SHADER),this.program=e.createProgram();var n=!0,i=!1,r=void 0;try{for(var o,a=Object.keys(Pt.attributeLocations)[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value,l=Pt.attributeLocations[s];e.bindAttribLocation(this.program,l,s)}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}this.compileShader(this.vs,this.vsSource),this.compileShader(this.fs,this.fsSource);var u=this.program;if(e.attachShader(u,this.vs),e.attachShader(u,this.fs),e.linkProgram(u),e.detachShader(u,this.vs),e.detachShader(u,this.fs),!e.getProgramParameter(u,e.LINK_STATUS)){var c=e.getProgramInfoLog(u);throw"could not link program "+this.name+": "+c}for(var h=e.getProgramParameter(u,e.ACTIVE_ATTRIBUTES),d=0;d<h;d++){var p=e.getActiveAttrib(u,d),v=e.getAttribLocation(u,p.name);this.attributeLocations[p.name]=v}for(var f=e.getProgramParameter(u,e.ACTIVE_UNIFORMS),m=0;m<f;m++){var g=e.getActiveUniform(u,m),y=e.getUniformLocation(u,g.name);this.uniformLocations[g.name]=y}var E={program:this.program,vs:this.vs,fs:this.fs,attributeLocations:this.attributeLocations,uniformLocations:this.uniformLocations};this.cache.set(this.vsSource+", "+this.fsSource,E)}},{key:"setUniformMatrix4",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];if(null!=i){var r=new Float32Array(t.elements);n.uniformMatrix4fv(i,!1,r)}}},{key:"setUniform1f",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];null!=i&&n.uniform1f(i,t)}},{key:"setUniformBoolean",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];null!=i&&n.uniform1i(i,t)}},{key:"setUniformTexture",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];null!=i&&n.uniform1i(i,t)}},{key:"setUniform2f",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];null!=i&&n.uniform2f(i,t[0],t[1])}},{key:"setUniform3f",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];null!=i&&n.uniform3f(i,t[0],t[1],t[2])}},{key:"setUniform",value:function(e,t){t.constructor===THREE.Matrix4?this.setUniformMatrix4(e,t):"number"==typeof t?this.setUniform1f(e,t):"boolean"==typeof t?this.setUniformBoolean(e,t):t instanceof Pt.WebGLTexture?this.setUniformTexture(e,t):t instanceof Array?2===t.length?this.setUniform2f(e,t):3===t.length&&this.setUniform3f(e,t):console.error("unhandled uniform type: ",e,t)}},{key:"setUniform1i",value:function(e,t){var n=this.gl,i=this.uniformLocations[e];null!=i&&n.uniform1i(i,t)}}]),r}(),Pt.WebGLTexture=function(){function n(e,t){_classCallCheck(this,n),this.gl=e,this.texture=t,this.id=e.createTexture(),this.target=e.TEXTURE_2D,this.version=-1,this.update(t)}return _createClass(n,[{key:"update",value:function(){if(this.texture.image){var e=this.gl,t=this.texture;if(this.version!==t.version){this.target=e.TEXTURE_2D,e.bindTexture(this.target,this.id);var n=Pt.paramThreeToGL(e,t.format),i=t.image.width,r=t.image.height,o=n,a=Pt.paramThreeToGL(e,t.type),s=void 0;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,t.unpackAlignment),t instanceof THREE.DataTexture?(s=t.image.data,e.texParameteri(this.target,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(this.target,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,Pt.paramThreeToGL(e,t.magFilter)),e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,Pt.paramThreeToGL(e,t.minFilter)),e.texImage2D(this.target,0,n,i,r,0,o,a,s)):t instanceof THREE.CanvasTexture&&(s=t.image,e.texParameteri(this.target,e.TEXTURE_WRAP_S,Pt.paramThreeToGL(e,t.wrapS)),e.texParameteri(this.target,e.TEXTURE_WRAP_T,Pt.paramThreeToGL(e,t.wrapT)),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,Pt.paramThreeToGL(e,t.magFilter)),e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,Pt.paramThreeToGL(e,t.minFilter)),e.texImage2D(this.target,0,n,n,a,s)),e.bindTexture(this.target,null),this.version=t.version}}else this.version=this.texture.version}}]),n}(),Pt.WebGLBuffer=function e(){_classCallCheck(this,e),this.numElements=0,this.vao=null,this.vbos=new Map},Pt.Renderer=function(){function t(e){_classCallCheck(this,t),this.threeRenderer=e,this.gl=this.threeRenderer.context,this.buffers=new Map,this.shaders=new Map,this.textures=new Map,this.glTypeMapping=new Map,this.glTypeMapping.set(Float32Array,this.gl.FLOAT),this.glTypeMapping.set(Uint8Array,this.gl.UNSIGNED_BYTE),this.glTypeMapping.set(Uint16Array,this.gl.UNSIGNED_SHORT),this.toggle=0}return _createClass(t,[{key:"createBuffer",value:function(e){var t=this.gl,n=new Pt.WebGLBuffer;for(var i in n.vao=t.createVertexArray(),n.numElements=e.attributes.position.count,t.bindVertexArray(n.vao),e.attributes){var r=e.attributes[i],o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,r.array,t.STATIC_DRAW);var a=Pt.attributeLocations[i],s=r.normalized,l=this.glTypeMapping.get(r.array.constructor);t.vertexAttribPointer(a,r.itemSize,l,s,0,0),t.enableVertexAttribArray(a),n.vbos.set(i,{handle:o,name:i,count:r.count,itemSize:r.itemSize,type:e.attributes.position.array.constructor,version:0})}return t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(null),n}},{key:"updateBuffer",value:function(e){var t=this.gl,n=this.buffers.get(e);for(var i in t.bindVertexArray(n.vao),e.attributes){var r=e.attributes[i],o=Pt.attributeLocations[i],a=r.normalized,s=this.glTypeMapping.get(r.array.constructor),l=null;n.vbos.has(i)?(l=n.vbos.get(i).handle,n.vbos.get(i).version=r.version):(l=t.createBuffer(),n.vbos.set(i,{handle:l,name:i,count:r.count,itemSize:r.itemSize,type:e.attributes.position.array.constructor,version:r.version})),t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,r.array,t.STATIC_DRAW),t.vertexAttribPointer(o,r.itemSize,s,a,0,0),t.enableVertexAttribArray(o)}t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(null)}},{key:"traverse",value:function(e){for(var t=[],n=[e];0<n.length;){var i=n.pop();if(i instanceof Pt.PointCloudTree)t.push(i);else{var r=i.children.filter(function(e){return e.visible});n.push.apply(n,_toConsumableArray(r))}}return{octrees:t}}},{key:"renderNodes",value:function(e,t,j,n,i,W,r){var X=this;Pt.measureTimings&&performance.mark("renderNodes-start");var Y=this.gl,q=r.material?r.material:e.material,Q=null==r.shadowMaps?[]:r.shadowMaps,K=n.matrixWorldInverse,$=new THREE.Matrix4,Z=new Float32Array(16),J=0,o=!0,a=!1,s=void 0;try{for(var ee,l=function(){var e=ee.value;if(void 0!==Pt.debug.allowedNodes&&!Pt.debug.allowedNodes.includes(e.name))return"continue";var t=e.sceneNode.matrixWorld;if($.multiplyMatrices(K,t),j){var n=j.offsets.get(e);W.setUniform1f("uVNStart",n)}var i=e.getLevel();e.debug?W.setUniform("uDebug",!0):W.setUniform("uDebug",!1);var r=void 0;e instanceof Pt.PointCloudOctreeNode?r=0===Object.keys(e.children).length:e instanceof Pt.PointCloudArena4DNode&&(r=e.geometryNode.isLeaf),W.setUniform("uIsLeafNode",r);var o=W.uniformLocations.modelMatrix;o&&(Z.set(t.elements),Y.uniformMatrix4fv(o,!1,Z));for(var a=W.uniformLocations.modelViewMatrix,s=0;s<16;s++)Z[s]=$.elements[s];if(Y.uniformMatrix4fv(a,!1,Z),q.clipPolygons&&0<q.clipPolygons.length){var l,u=[],c=[],h=!0,d=!1,p=void 0;try{for(var v,f=q.clipPolygons[Symbol.iterator]();!(h=(v=f.next()).done);h=!0){var m=v.value,g=m.viewMatrix,y=m.projMatrix.clone().multiply(g).multiply(t);u.push(m.markers.length),c.push(y)}}catch(e){d=!0,p=e}finally{try{!h&&f.return&&f.return()}finally{if(d)throw p}}for(var E=(l=[]).concat.apply(l,_toConsumableArray(c.map(function(e){return e.elements}))),T=new Array(24*q.clipPolygons.length),P=0;P<q.clipPolygons.length;P++)for(var b=q.clipPolygons[P],w=0;w<b.markers.length;w++)T[24*P+(3*w+0)]=b.markers[w].position.x,T[24*P+(3*w+1)]=b.markers[w].position.y,T[24*P+(3*w+2)]=b.markers[w].position.z;var x=W.uniformLocations["uClipPolygonVCount[0]"];Y.uniform1iv(x,u);var _=W.uniformLocations["uClipPolygonWVP[0]"];Y.uniformMatrix4fv(_,!1,E);var R=W.uniformLocations["uClipPolygonVertices[0]"];Y.uniform3fv(R,T)}if(W.setUniform1f("uLevel",i),W.setUniform1f("uNodeSpacing",e.geometryNode.estimatedSpacing),W.setUniform1f("uPCIndex",J),0<Q.length){var C=W.uniformLocations["uShadowMap[0]"];W.setUniform3f("uShadowColor",q.uniforms.uShadowColor.value);var S=new Array(Q.length).fill(5).map(function(e,t){return e+t});Y.uniform1iv(C,S);for(var A=0;A<Q.length;A++){var H=Q[A],k=S[A],L=X.threeRenderer.properties.get(H.target.texture).__webglTexture;Y.activeTexture(Y["TEXTURE"+k]),Y.bindTexture(Y.TEXTURE_2D,L)}var M,D=Q.map(function(e){return e.camera.matrixWorldInverse}).map(function(e){return(new THREE.Matrix4).multiplyMatrices(e,t)}),B=(M=[]).concat.apply(M,_toConsumableArray(D.map(function(e){return e.elements}))),N=W.uniformLocations["uShadowWorldView[0]"];Y.uniformMatrix4fv(N,!1,B);var I,O=(I=[]).concat.apply(I,_toConsumableArray(Q.map(function(e){return e.camera.projectionMatrix.elements}))),V=W.uniformLocations["uShadowProj[0]"];Y.uniformMatrix4fv(V,!1,O)}var z=e.geometryNode.geometry,U=null;if(X.buffers.has(z))for(var F in U=X.buffers.get(z),z.attributes){z.attributes[F].version>U.vbos.get(F).version&&X.updateBuffer(z)}else U=X.createBuffer(z),X.buffers.set(z,U);Y.bindVertexArray(U.vao);var G=U.numElements;Y.drawArrays(Y.POINTS,0,G),J++},u=t[Symbol.iterator]();!(o=(ee=u.next()).done);o=!0)l()}catch(e){a=!0,s=e}finally{try{!o&&u.return&&u.return()}finally{if(a)throw s}}Y.bindVertexArray(null),Pt.measureTimings&&(performance.mark("renderNodes-end"),performance.measure("render.renderNodes","renderNodes-start","renderNodes-end"))}},{key:"renderOctree",value:function(e,t,n,i){var r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{},o=this.gl,a=r.material?r.material:e.material,s=null==r.shadowMaps?[]:r.shadowMaps,l=n.matrixWorldInverse,u=n.matrixWorld,c=n.projectionMatrix,h=(new THREE.Matrix4).getInverse(c),d=(new THREE.Matrix4,null),p=null,v=0;if(0<=a.pointSizeType&&(a.pointSizeType===Pt.PointSizeType.ADAPTIVE||a.pointColorType===Pt.PointColorType.LOD)){var f=null!=r.vnTextureNodes?r.vnTextureNodes:t;p=e.computeVisibilityTextureData(f,n);var m=a.visibleNodesTexture;m.image.data.set(p.data),m.needsUpdate=!0}if(!this.shaders.has(a)){var g=[a.vertexShader,a.fragmentShader],y=g[0],E=g[1],T=new Pt.Shader(o,"pointcloud",y,E);this.shaders.set(a,T)}d=this.shaders.get(a);var P=[a.vertexShader,a.fragmentShader],b=P[0],w=P[1],x=a.snapEnabled?a.numSnapshots:0,_=a.clipBoxes&&a.clipBoxes.length?a.clipBoxes.length:0,R=a.clipPolygons&&a.clipPolygons.length?a.clipPolygons.length:0,C=["#define num_shadowmaps "+s.length,"#define num_snapshots "+x,"#define num_clipboxes "+_,"#define num_clippolygons "+R].join("\n");b=C+"\n"+b,w=C+"\n"+w,d.update(b,w);var S=!(a.needsUpdate=!1),A=!1,H=void 0;try{for(var k,L=Object.keys(a.uniforms)[Symbol.iterator]();!(S=(k=L.next()).done);S=!0){var M=k.value,D=a.uniforms[M];if("t"==D.type){var B=D.value;if(!B)continue;if(!this.textures.has(B)){var N=new Pt.WebGLTexture(o,B);this.textures.set(B,N)}this.textures.get(B).update()}}}catch(e){A=!0,H=e}finally{try{!S&&L.return&&L.return()}finally{if(A)throw H}}o.useProgram(d.program);(void 0!==r.transparent?r.transparent&&a.opacity<1:a.opacity<1)?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE),o.depthMask(!1),o.disable(o.DEPTH_TEST)):(o.disable(o.BLEND),o.depthMask(!0),o.enable(o.DEPTH_TEST)),void 0!==r.blendFunc&&(o.enable(o.BLEND),o.blendFunc.apply(o,_toConsumableArray(r.blendFunc))),void 0!==r.depthTest&&(!0===r.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST)),void 0!==r.depthWrite&&(!0===r.depthWrite?o.depthMask(!0):o.depthMask(!1)),d.setUniformMatrix4("projectionMatrix",c),d.setUniformMatrix4("viewMatrix",l),d.setUniformMatrix4("uViewInv",u),d.setUniformMatrix4("uProjInv",h);var I=i?i.width:a.screenWidth,O=i?i.height:a.screenHeight;if(d.setUniform1f("uScreenWidth",I),d.setUniform1f("uScreenHeight",O),d.setUniform1f("fov",Math.PI*n.fov/180),d.setUniform1f("near",n.near),d.setUniform1f("far",n.far),n instanceof THREE.OrthographicCamera?(d.setUniform("uUseOrthographicCamera",!0),d.setUniform("uOrthoWidth",n.right-n.left),d.setUniform("uOrthoHeight",n.top-n.bottom)):d.setUniform("uUseOrthographicCamera",!1),a.clipBoxes.length+a.clipPolygons.length===0?d.setUniform1i("clipTask",Pt.ClipTask.NONE):d.setUniform1i("clipTask",a.clipTask),d.setUniform1i("clipMethod",a.clipMethod),a.clipBoxes&&0<a.clipBoxes.length){var V,z=(V=[]).concat.apply(V,_toConsumableArray(a.clipBoxes.map(function(e){return e.inverse.elements}))),U=d.uniformLocations["clipBoxes[0]"];o.uniformMatrix4fv(U,!1,z)}d.setUniform1f("size",a.size),d.setUniform1f("maxSize",a.uniforms.maxSize.value),d.setUniform1f("minSize",a.uniforms.minSize.value),d.setUniform1f("uOctreeSpacing",a.spacing),d.setUniform("uOctreeSize",a.uniforms.octreeSize.value),d.setUniform3f("uColor",a.color.toArray()),d.setUniform1f("uOpacity",a.opacity),d.setUniform2f("elevationRange",a.elevationRange),d.setUniform2f("intensityRange",a.intensityRange),d.setUniform1f("intensityGamma",a.intensityGamma),d.setUniform1f("intensityContrast",a.intensityContrast),d.setUniform1f("intensityBrightness",a.intensityBrightness),d.setUniform1f("rgbGamma",a.rgbGamma),d.setUniform1f("rgbContrast",a.rgbContrast),d.setUniform1f("rgbBrightness",a.rgbBrightness),d.setUniform1f("uTransition",a.transition),d.setUniform1f("wRGB",a.weightRGB),d.setUniform1f("wIntensity",a.weightIntensity),d.setUniform1f("wElevation",a.weightElevation),d.setUniform1f("wClassification",a.weightClassification),d.setUniform1f("wReturnNumber",a.weightReturnNumber),d.setUniform1f("wSourceID",a.weightSourceID);var F=this.textures.get(a.visibleNodesTexture);d.setUniform1i("visibleNodesTexture",v),o.activeTexture(o.TEXTURE0+v),o.bindTexture(F.target,F.id),v++;var G=this.textures.get(a.gradientTexture);d.setUniform1i("gradient",v),o.activeTexture(o.TEXTURE0+v),o.bindTexture(G.target,G.id),v++;var j=this.textures.get(a.classificationTexture);if(d.setUniform1i("classificationLUT",v),o.activeTexture(o.TEXTURE0+v),o.bindTexture(j.target,j.id),v++,!0===a.snapEnabled){var W=d.uniformLocations["uSnapshot[0]"],X=d.uniformLocations["uSnapshotDepth[0]"],Y=v,q=new Array(5).fill(Y).map(function(e,t){return e+t}),Q=new Array(5).fill(1+Math.max.apply(Math,_toConsumableArray(q))).map(function(e,t){return e+t});v=1+Math.max.apply(Math,_toConsumableArray(Q)),o.uniform1iv(W,q),o.uniform1iv(X,Q);for(var K=0;K<5;K++){var $=a.uniforms.uSnapshot.value[K],Z=a.uniforms.uSnapshotDepth.value[K];if(!$)break;var J=this.threeRenderer.properties.get($).__webglTexture,ee=this.threeRenderer.properties.get(Z).__webglTexture,te=q[K],ne=Q[K];o.activeTexture(o["TEXTURE"+te]),o.bindTexture(o.TEXTURE_2D,J),o.activeTexture(o["TEXTURE"+ne]),o.bindTexture(o.TEXTURE_2D,ee)}var ie,re=(ie=[]).concat.apply(ie,_toConsumableArray(a.uniforms.uSnapView.value.map(function(e){return e.elements}))),oe=d.uniformLocations["uSnapView[0]"];o.uniformMatrix4fv(oe,!1,re);var ae,se=(ae=[]).concat.apply(ae,_toConsumableArray(a.uniforms.uSnapProj.value.map(function(e){return e.elements}))),le=d.uniformLocations["uSnapProj[0]"];o.uniformMatrix4fv(le,!1,se);var ue,ce=(ue=[]).concat.apply(ue,_toConsumableArray(a.uniforms.uSnapProjInv.value.map(function(e){return e.elements}))),he=d.uniformLocations["uSnapProjInv[0]"];o.uniformMatrix4fv(he,!1,ce);var de,pe=(de=[]).concat.apply(de,_toConsumableArray(a.uniforms.uSnapViewInv.value.map(function(e){return e.elements}))),ve=d.uniformLocations["uSnapViewInv[0]"];o.uniformMatrix4fv(ve,!1,pe)}this.renderNodes(e,t,p,n,i,d,r),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,null),o.activeTexture(o.TEXTURE0)}},{key:"render",value:function(e,t,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},r=this.gl;null!=n&&this.threeRenderer.setRenderTarget(n),t.updateProjectionMatrix();var o=this.traverse(e),a=!0,s=!1,l=void 0;try{for(var u,c=o.octrees[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var h=u.value,d=h.visibleNodes;this.renderOctree(h,d,t,n,i)}}catch(e){s=!0,l=e}finally{try{!a&&c.return&&c.return()}finally{if(s)throw l}}r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,null),this.threeRenderer.state.reset()}}]),t}(),Pt.PointCloudTreeNode=function(){function e(){_classCallCheck(this,e),this.needsTransformUpdate=!0}return _createClass(e,[{key:"getChildren",value:function(){throw new Error("override function")}},{key:"getBoundingBox",value:function(){throw new Error("override function")}},{key:"isLoaded",value:function(){throw new Error("override function")}},{key:"isGeometryNode",value:function(){throw new Error("override function")}},{key:"isTreeNode",value:function(){throw new Error("override function")}},{key:"getLevel",value:function(){throw new Error("override function")}},{key:"getBoundingSphere",value:function(){throw new Error("override function")}}]),e}(),Pt.PointCloudTree=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,THREE.Object3D),_createClass(t,[{key:"initialized",value:function(){return null!==this.root}}]),t}(),Pt.WorkerPool=function(){function e(){_classCallCheck(this,e),this.workers={}}return _createClass(e,[{key:"getWorker",value:function(e){if(this.workers[e]||(this.workers[e]=[]),0===this.workers[e].length){var t=new Worker(e);this.workers[e].push(t)}return this.workers[e].pop()}},{key:"returnWorker",value:function(e,t){this.workers[e].push(t)}}]),e}(),Pt.workerPool=new Pt.WorkerPool,Pt.Shaders["pointcloud.vs"]="\nprecision highp float;\nprecision highp int;\n\n#define max_clip_polygons 8\n#define PI 3.141592653589793\n\nattribute vec3 position;\nattribute vec3 color;\nattribute float intensity;\nattribute float classification;\nattribute float returnNumber;\nattribute float numberOfReturns;\nattribute float pointSourceID;\nattribute vec4 indices;\nattribute float spacing;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\n\nuniform float uScreenWidth;\nuniform float uScreenHeight;\nuniform float fov;\nuniform float near;\nuniform float far;\n\nuniform bool uDebug;\n\nuniform bool uUseOrthographicCamera;\nuniform float uOrthoWidth;\nuniform float uOrthoHeight;\n\n\n#define CLIPTASK_NONE 0\n#define CLIPTASK_HIGHLIGHT 1\n#define CLIPTASK_SHOW_INSIDE 2\n#define CLIPTASK_SHOW_OUTSIDE 3\n\n#define CLIPMETHOD_INSIDE_ANY 0\n#define CLIPMETHOD_INSIDE_ALL 1\n\nuniform int clipTask;\nuniform int clipMethod;\n#if defined(num_clipboxes) && num_clipboxes > 0\n\tuniform mat4 clipBoxes[num_clipboxes];\n#endif\n\n#if defined(num_clippolygons) && num_clippolygons > 0\n\tuniform int uClipPolygonVCount[num_clippolygons];\n\tuniform vec3 uClipPolygonVertices[num_clippolygons * 8];\n\tuniform mat4 uClipPolygonWVP[num_clippolygons];\n#endif\n\nuniform float size;\nuniform float minSize;\nuniform float maxSize;\n\nuniform float uPCIndex;\nuniform float uOctreeSpacing;\nuniform float uNodeSpacing;\nuniform float uOctreeSize;\nuniform vec3 uBBSize;\nuniform float uLevel;\nuniform float uVNStart;\nuniform bool uIsLeafNode;\n\nuniform vec3 uColor;\nuniform float uOpacity;\n\nuniform vec2 elevationRange;\nuniform vec2 intensityRange;\nuniform float intensityGamma;\nuniform float intensityContrast;\nuniform float intensityBrightness;\nuniform float rgbGamma;\nuniform float rgbContrast;\nuniform float rgbBrightness;\nuniform float uTransition;\nuniform float wRGB;\nuniform float wIntensity;\nuniform float wElevation;\nuniform float wClassification;\nuniform float wReturnNumber;\nuniform float wSourceID;\n\nuniform vec3 uShadowColor;\n\nuniform sampler2D visibleNodes;\nuniform sampler2D gradient;\nuniform sampler2D classificationLUT;\n\n#if defined(num_shadowmaps) && num_shadowmaps > 0\nuniform sampler2D uShadowMap[num_shadowmaps];\nuniform mat4 uShadowWorldView[num_shadowmaps];\nuniform mat4 uShadowProj[num_shadowmaps];\n#endif\n\n#if defined(num_snapshots) && num_snapshots > 0\nuniform sampler2D uSnapshot[num_snapshots];\nuniform mat4 uSnapView[num_snapshots];\nuniform mat4 uSnapProj[num_snapshots];\nuniform mat4 uSnapScreenToCurrentView[num_snapshots];\n\nvarying float vSnapTextureID;\n#endif\n\nvarying vec4\tvColor;\nvarying float\tvLogDepth;\nvarying vec3\tvViewPosition;\nvarying float \tvRadius;\nvarying float \tvPointSize;\n\n\nfloat round(float number){\n\treturn floor(number + 0.5);\n}\n\n// \n//    ###    ########     ###    ########  ######## #### ##     ## ########     ######  #### ######## ########  ######  \n//   ## ##   ##     ##   ## ##   ##     ##    ##     ##  ##     ## ##          ##    ##  ##       ##  ##       ##    ## \n//  ##   ##  ##     ##  ##   ##  ##     ##    ##     ##  ##     ## ##          ##        ##      ##   ##       ##       \n// ##     ## ##     ## ##     ## ########     ##     ##  ##     ## ######       ######   ##     ##    ######    ######  \n// ######### ##     ## ######### ##           ##     ##   ##   ##  ##                ##  ##    ##     ##             ## \n// ##     ## ##     ## ##     ## ##           ##     ##    ## ##   ##          ##    ##  ##   ##      ##       ##    ## \n// ##     ## ########  ##     ## ##           ##    ####    ###    ########     ######  #### ######## ########  ######  \n// \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\n\n// ---------------------\n// OCTREE\n// ---------------------\n\n#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_octree)\n/**\n * number of 1-bits up to inclusive index position\n * number is treated as if it were an integer in the range 0-255\n *\n */\nint numberOfOnes(int number, int index){\n\tint numOnes = 0;\n\tint tmp = 128;\n\tfor(int i = 7; i >= 0; i--){\n\t\t\n\t\tif(number >= tmp){\n\t\t\tnumber = number - tmp;\n\n\t\t\tif(i <= index){\n\t\t\t\tnumOnes++;\n\t\t\t}\n\t\t}\n\t\t\n\t\ttmp = tmp / 2;\n\t}\n\n\treturn numOnes;\n}\n\n\n/**\n * checks whether the bit at index is 1\n * number is treated as if it were an integer in the range 0-255\n *\n */\nbool isBitSet(int number, int index){\n\n\t// weird multi else if due to lack of proper array, int and bitwise support in WebGL 1.0\n\tint powi = 1;\n\tif(index == 0){\n\t\tpowi = 1;\n\t}else if(index == 1){\n\t\tpowi = 2;\n\t}else if(index == 2){\n\t\tpowi = 4;\n\t}else if(index == 3){\n\t\tpowi = 8;\n\t}else if(index == 4){\n\t\tpowi = 16;\n\t}else if(index == 5){\n\t\tpowi = 32;\n\t}else if(index == 6){\n\t\tpowi = 64;\n\t}else if(index == 7){\n\t\tpowi = 128;\n\t}else{\n\t\treturn false;\n\t}\n\n\tint ndp = number / powi;\n\n\treturn mod(float(ndp), 2.0) != 0.0;\n}\n\n\n/**\n * find the LOD at the point position\n */\nfloat getLOD(){\n\t\n\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\tint iOffset = int(uVNStart);\n\tfloat depth = uLevel;\n\tfor(float i = 0.0; i <= 30.0; i++){\n\t\tfloat nodeSizeAtLevel = uOctreeSize  / pow(2.0, i + uLevel + 0.0);\n\t\t\n\t\tvec3 index3d = (position-offset) / nodeSizeAtLevel;\n\t\tindex3d = floor(index3d + 0.5);\n\t\tint index = int(round(4.0 * index3d.x + 2.0 * index3d.y + index3d.z));\n\t\t\n\t\tvec4 value = texture2D(visibleNodes, vec2(float(iOffset) / 2048.0, 0.0));\n\t\tint mask = int(round(value.r * 255.0));\n\n\t\tif(isBitSet(mask, index)){\n\t\t\t// there are more visible child nodes at this position\n\t\t\tint advanceG = int(round(value.g * 255.0)) * 256;\n\t\t\tint advanceB = int(round(value.b * 255.0));\n\t\t\tint advanceChild = numberOfOnes(mask, index - 1);\n\t\t\tint advance = advanceG + advanceB + advanceChild;\n\n\t\t\tiOffset = iOffset + advance;\n\t\t\t\n\t\t\tdepth++;\n\t\t}else{\n\t\t\t// no more visible child nodes at this position\n\t\t\treturn value.a * 255.0;\n\t\t\t//return depth;\n\t\t}\n\t\t\n\t\toffset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;\n\t}\n\t\t\n\treturn depth;\n}\n\nfloat getSpacing(){\n\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\tint iOffset = int(uVNStart);\n\tfloat depth = uLevel;\n\tfloat spacing = uNodeSpacing;\n\tfor(float i = 0.0; i <= 30.0; i++){\n\t\tfloat nodeSizeAtLevel = uOctreeSize  / pow(2.0, i + uLevel + 0.0);\n\t\t\n\t\tvec3 index3d = (position-offset) / nodeSizeAtLevel;\n\t\tindex3d = floor(index3d + 0.5);\n\t\tint index = int(round(4.0 * index3d.x + 2.0 * index3d.y + index3d.z));\n\t\t\n\t\tvec4 value = texture2D(visibleNodes, vec2(float(iOffset) / 2048.0, 0.0));\n\t\tint mask = int(round(value.r * 255.0));\n\t\tfloat spacingFactor = value.a;\n\n\t\tif(i > 0.0){\n\t\t\tspacing = spacing / (255.0 * spacingFactor);\n\t\t}\n\t\t\n\n\t\tif(isBitSet(mask, index)){\n\t\t\t// there are more visible child nodes at this position\n\t\t\tint advanceG = int(round(value.g * 255.0)) * 256;\n\t\t\tint advanceB = int(round(value.b * 255.0));\n\t\t\tint advanceChild = numberOfOnes(mask, index - 1);\n\t\t\tint advance = advanceG + advanceB + advanceChild;\n\n\t\t\tiOffset = iOffset + advance;\n\n\t\t\t//spacing = spacing / (255.0 * spacingFactor);\n\t\t\t//spacing = spacing / 3.0;\n\t\t\t\n\t\t\tdepth++;\n\t\t}else{\n\t\t\t// no more visible child nodes at this position\n\t\t\treturn spacing;\n\t\t}\n\t\t\n\t\toffset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;\n\t}\n\t\t\n\treturn spacing;\n}\n\nfloat getPointSizeAttenuation(){\n\treturn pow(2.0, getLOD());\n}\n\n\n#endif\n\n\n// ---------------------\n// KD-TREE\n// ---------------------\n\n#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_kdtree)\n\nfloat getLOD(){\n\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\tfloat iOffset = 0.0;\n\tfloat depth = 0.0;\n\t\t\n\t\t\n\tvec3 size = uBBSize;\t\n\tvec3 pos = position;\n\t\t\n\tfor(float i = 0.0; i <= 1000.0; i++){\n\t\t\n\t\tvec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));\n\t\t\n\t\tint children = int(value.r * 255.0);\n\t\tfloat next = value.g * 255.0;\n\t\tint split = int(value.b * 255.0);\n\t\t\n\t\tif(next == 0.0){\n\t\t \treturn depth;\n\t\t}\n\t\t\n\t\tvec3 splitv = vec3(0.0, 0.0, 0.0);\n\t\tif(split == 1){\n\t\t\tsplitv.x = 1.0;\n\t\t}else if(split == 2){\n\t\t \tsplitv.y = 1.0;\n\t\t}else if(split == 4){\n\t\t \tsplitv.z = 1.0;\n\t\t}\n\t\t\n\t\tiOffset = iOffset + next;\n\t\t\n\t\tfloat factor = length(pos * splitv / size);\n\t\tif(factor < 0.5){\n\t\t\t// left\n\t\tif(children == 0 || children == 2){\n\t\t\t\treturn depth;\n\t\t\t}\n\t\t}else{\n\t\t\t// right\n\t\t\tpos = pos - size * splitv * 0.5;\n\t\t\tif(children == 0 || children == 1){\n\t\t\t\treturn depth;\n\t\t\t}\n\t\t\tif(children == 3){\n\t\t\t\tiOffset = iOffset + 1.0;\n\t\t\t}\n\t\t}\n\t\tsize = size * ((1.0 - (splitv + 1.0) / 2.0) + 0.5);\n\t\t\n\t\tdepth++;\n\t}\n\t\t\n\t\t\n\treturn depth;\t\n}\n\nfloat getPointSizeAttenuation(){\n\treturn 0.5 * pow(1.3, getLOD());\n}\n\n#endif\n\n\n\n// \n//    ###    ######## ######## ########  #### ########  ##     ## ######## ########  ######  \n//   ## ##      ##       ##    ##     ##  ##  ##     ## ##     ##    ##    ##       ##    ## \n//  ##   ##     ##       ##    ##     ##  ##  ##     ## ##     ##    ##    ##       ##       \n// ##     ##    ##       ##    ########   ##  ########  ##     ##    ##    ######    ######  \n// #########    ##       ##    ##   ##    ##  ##     ## ##     ##    ##    ##             ## \n// ##     ##    ##       ##    ##    ##   ##  ##     ## ##     ##    ##    ##       ##    ## \n// ##     ##    ##       ##    ##     ## #### ########   #######     ##    ########  ######                                                                               \n// \n\n\n\n// formula adapted from: http://www.dfstudios.co.uk/articles/programming/image-programming-algorithms/image-processing-algorithms-part-5-contrast-adjustment/\nfloat getContrastFactor(float contrast){\n\treturn (1.0158730158730156 * (contrast + 1.0)) / (1.0158730158730156 - contrast);\n}\n\nvec3 getRGB(){\n\tvec3 rgb = color;\n\t\n\trgb = pow(rgb, vec3(rgbGamma));\n\trgb = rgb + rgbBrightness;\n\t//rgb = (rgb - 0.5) * getContrastFactor(rgbContrast) + 0.5;\n\trgb = clamp(rgb, 0.0, 1.0);\n\n\t\t//rgb = indices.rgb;\n\t//rgb.b = pcIndex / 255.0;\n\t\n\t\n\treturn rgb;\n}\n\nfloat getIntensity(){\n\tfloat w = (intensity - intensityRange.x) / (intensityRange.y - intensityRange.x);\n\tw = pow(w, intensityGamma);\n\tw = w + intensityBrightness;\n\tw = (w - 0.5) * getContrastFactor(intensityContrast) + 0.5;\n\tw = clamp(w, 0.0, 1.0);\n\n\t//w = w + color.x * 0.0001;\n\t\n\t//float w = color.x * 0.001 + intensity / 1.0;\n\n\treturn w;\n}\n\nvec3 getElevation(){\n\tvec4 world = modelMatrix * vec4( position, 1.0 );\n\tfloat w = (world.z - elevationRange.x) / (elevationRange.y - elevationRange.x);\n\tif(world.z<=0.0){\n\t\tw=0.0;\n\t}else if(world.z >= 100.0){\n\t\tw=1.0;\n\t}else{\n\t\tw = world.z/80.0;\n\t}\n\tw = (world.z - elevationRange.x) / (elevationRange.y - elevationRange.x);\n\tvec3 cElevation = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\t\n\treturn cElevation;\n}\n\nvec4 getClassification(){\n\tvec2 uv = vec2(classification / 255.0, 0.5);\n\tvec4 classColor = texture2D(classificationLUT, uv);\n\t\n\treturn classColor;\n}\n\nvec3 getReturnNumber(){\n\tif(numberOfReturns == 1.0){\n\t\treturn vec3(1.0, 1.0, 0.0);\n\t}else{\n\t\tif(returnNumber == 1.0){\n\t\t\treturn vec3(1.0, 0.0, 0.0);\n\t\t}else if(returnNumber == numberOfReturns){\n\t\t\treturn vec3(0.0, 0.0, 1.0);\n\t\t}else{\n\t\t\treturn vec3(0.0, 1.0, 0.0);\n\t\t}\n\t}\n}\n\nvec3 getSourceID(){\n\tfloat w = mod(pointSourceID, 10.0) / 10.0;\n\treturn texture2D(gradient, vec2(w,1.0 - w)).rgb;\n}\n\nvec3 getCompositeColor(){\n\tvec3 c;\n\tfloat w;\n\n\tc += wRGB * getRGB();\n\tw += wRGB;\n\t\n\tc += wIntensity * getIntensity() * vec3(1.0, 1.0, 1.0);\n\tw += wIntensity;\n\t\n\tc += wElevation * getElevation();\n\tw += wElevation;\n\t\n\tc += wReturnNumber * getReturnNumber();\n\tw += wReturnNumber;\n\t\n\tc += wSourceID * getSourceID();\n\tw += wSourceID;\n\t\n\tvec4 cl = wClassification * getClassification();\n    c += cl.a * cl.rgb;\n\tw += wClassification * cl.a;\n\n\tc = c / w;\n\t\n\tif(w == 0.0){\n\t\t//c = color;\n\t\tgl_Position = vec4(100.0, 100.0, 100.0, 0.0);\n\t}\n\t\n\treturn c;\n}\n\n\n// \n//  ######  ##       #### ########  ########  #### ##    ##  ######   \n// ##    ## ##        ##  ##     ## ##     ##  ##  ###   ## ##    ##  \n// ##       ##        ##  ##     ## ##     ##  ##  ####  ## ##        \n// ##       ##        ##  ########  ########   ##  ## ## ## ##   #### \n// ##       ##        ##  ##        ##         ##  ##  #### ##    ##  \n// ##    ## ##        ##  ##        ##         ##  ##   ### ##    ##  \n//  ######  ######## #### ##        ##        #### ##    ##  ######                                                          \n// \n\n\n\nvec3 getColor(){\n\tvec3 color;\n\t\n\t#ifdef color_type_rgb\n\t\tcolor = getRGB();\n\t#elif defined color_type_height\n\t\tcolor = getElevation();\n\t#elif defined color_type_rgb_height\n\t\tvec3 cHeight = getElevation();\n\t\tcolor = (1.0 - uTransition) * getRGB() + uTransition * cHeight;\n\t#elif defined color_type_depth\n\t\tfloat linearDepth = gl_Position.w;\n\t\tfloat expDepth = (gl_Position.z / gl_Position.w) * 0.5 + 0.5;\n\t\tcolor = vec3(linearDepth, expDepth, 0.0);\n\t#elif defined color_type_intensity\n\t\tfloat w = getIntensity();\n\t\tcolor = vec3(w, w, w);\n\t#elif defined color_type_intensity_gradient\n\t\tfloat w = getIntensity();\n\t\tcolor = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\t#elif defined color_type_color\n\t\tcolor = uColor;\n\t#elif defined color_type_lod\n\t\tfloat depth = getLOD();\n\t\tfloat w = depth / 10.0;\n\t\tcolor = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\t#elif defined color_type_point_index\n\t\tcolor = indices.rgb;\n\t#elif defined color_type_classification\n\t\tvec4 cl = getClassification(); \n\t\tcolor = cl.rgb;\n\t#elif defined color_type_return_number\n\t\tcolor = getReturnNumber();\n\t#elif defined color_type_source\n\t\tcolor = getSourceID();\n\t#elif defined color_type_normal\n\t\tcolor = (modelMatrix * vec4(normal, 0.0)).xyz;\n\t#elif defined color_type_phong\n\t\tcolor = color;\n\t#elif defined color_type_composite\n\t\tcolor = getCompositeColor();\n\t#endif\n\t\n\treturn color;\n}\n\nfloat getPointSize(){\n\tfloat pointSize = 1.0;\n\t\n\tfloat slope = tan(fov / 2.0);\n\tfloat projFactor = -0.5 * uScreenHeight / (slope * vViewPosition.z);\n\t\n\tfloat r = uOctreeSpacing * 1.7;\n\tvRadius = r;\n\t#if defined fixed_point_size\n\t\tpointSize = size;\n\t#elif defined attenuated_point_size\n\t\tif(uUseOrthographicCamera){\n\t\t\tpointSize = size;\n\t\t}else{\n\t\t\tpointSize = size * spacing * projFactor;\n\t\t\t//pointSize = pointSize * projFactor;\n\t\t}\n\t#elif defined adaptive_point_size\n\t\tif(uUseOrthographicCamera) {\n\t\t\tfloat worldSpaceSize = 1.0 * size * r / getPointSizeAttenuation();\n\t\t\tpointSize = (worldSpaceSize / uOrthoWidth) * uScreenWidth;\n\t\t} else {\n\n\t\t\tif(uIsLeafNode && false){\n\t\t\t\tpointSize = size * spacing * projFactor;\n\t\t\t}else{\n\t\t\t\tfloat worldSpaceSize = 1.0 * size * r / getPointSizeAttenuation();\n\t\t\t\tpointSize = worldSpaceSize * projFactor;\n\t\t\t}\n\t\t}\n\t#endif\n\n\tpointSize = max(minSize, pointSize);\n\tpointSize = min(maxSize, pointSize);\n\t\n\tvRadius = pointSize / projFactor;\n\n\treturn pointSize;\n}\n\n#if defined(num_clippolygons) && num_clippolygons > 0\nbool pointInClipPolygon(vec3 point, int polyIdx) {\n\n\tmat4 wvp = uClipPolygonWVP[polyIdx];\n\t//vec4 screenClipPos = uClipPolygonVP[polyIdx] * modelMatrix * vec4(point, 1.0);\n\t//screenClipPos.xy = screenClipPos.xy / screenClipPos.w * 0.5 + 0.5;\n\n\tvec4 pointNDC = wvp * vec4(point, 1.0);\n\tpointNDC.xy = pointNDC.xy / pointNDC.w;\n\n\tint j = uClipPolygonVCount[polyIdx] - 1;\n\tbool c = false;\n\tfor(int i = 0; i < 8; i++) {\n\t\tif(i == uClipPolygonVCount[polyIdx]) {\n\t\t\tbreak;\n\t\t}\n\n\t\t//vec4 verti = wvp * vec4(uClipPolygonVertices[polyIdx * 8 + i], 1);\n\t\t//vec4 vertj = wvp * vec4(uClipPolygonVertices[polyIdx * 8 + j], 1);\n\n\t\t//verti.xy = verti.xy / verti.w;\n\t\t//vertj.xy = vertj.xy / vertj.w;\n\n\t\t//verti.xy = verti.xy / verti.w * 0.5 + 0.5;\n\t\t//vertj.xy = vertj.xy / vertj.w * 0.5 + 0.5;\n\n\t\tvec3 verti = uClipPolygonVertices[polyIdx * 8 + i];\n\t\tvec3 vertj = uClipPolygonVertices[polyIdx * 8 + j];\n\n\t\tif( ((verti.y > pointNDC.y) != (vertj.y > pointNDC.y)) && \n\t\t\t(pointNDC.x < (vertj.x-verti.x) * (pointNDC.y-verti.y) / (vertj.y-verti.y) + verti.x) ) {\n\t\t\tc = !c;\n\t\t}\n\t\tj = i;\n\t}\n\n\treturn c;\n}\n#endif\n\nvoid doClipping(){\n\n\t#if !defined color_type_composite\n\t\tvec4 cl = getClassification(); \n\t\tif(cl.a == 0.0){\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 0.0);\n\t\t\t\n\t\t\treturn;\n\t\t}\n\t#endif\n\n\tint clipVolumesCount = 0;\n\tint insideCount = 0;\n\n\t#if defined(num_clipboxes) && num_clipboxes > 0\n\t\tfor(int i = 0; i < num_clipboxes; i++){\n\t\t\tvec4 clipPosition = clipBoxes[i] * modelMatrix * vec4( position, 1.0 );\n\t\t\tbool inside = -0.5 <= clipPosition.x && clipPosition.x <= 0.5;\n\t\t\tinside = inside && -0.5 <= clipPosition.y && clipPosition.y <= 0.5;\n\t\t\tinside = inside && -0.5 <= clipPosition.z && clipPosition.z <= 0.5;\n\n\t\t\tinsideCount = insideCount + (inside ? 1 : 0);\n\t\t\tclipVolumesCount++;\n\t\t}\t\n\t#endif\n\n\t#if defined(num_clippolygons) && num_clippolygons > 0\n\t\tfor(int i = 0; i < num_clippolygons; i++) {\n\t\t\tbool inside = pointInClipPolygon(position, i);\n\n\t\t\tinsideCount = insideCount + (inside ? 1 : 0);\n\t\t\tclipVolumesCount++;\n\t\t}\n\t#endif\n\n\tbool insideAny = insideCount > 0;\n\tbool insideAll = (clipVolumesCount > 0) && (clipVolumesCount == insideCount);\n\n\tif(clipMethod == CLIPMETHOD_INSIDE_ANY){\n\t\tif(insideAny && clipTask == CLIPTASK_HIGHLIGHT){\n\t\t\tvColor.r += 0.5;\n\t\t}else if(!insideAny && clipTask == CLIPTASK_SHOW_INSIDE){\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}else if(insideAny && clipTask == CLIPTASK_SHOW_OUTSIDE){\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}\n\t}else if(clipMethod == CLIPMETHOD_INSIDE_ALL){\n\t\tif(insideAll && clipTask == CLIPTASK_HIGHLIGHT){\n\t\t\tvColor.r += 0.5;\n\t\t}else if(!insideAll && clipTask == CLIPTASK_SHOW_INSIDE){\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}else if(insideAll && clipTask == CLIPTASK_SHOW_OUTSIDE){\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}\n\t}\n}\n\n\n\n// \n// ##     ##    ###    #### ##    ## \n// ###   ###   ## ##    ##  ###   ## \n// #### ####  ##   ##   ##  ####  ## \n// ## ### ## ##     ##  ##  ## ## ## \n// ##     ## #########  ##  ##  #### \n// ##     ## ##     ##  ##  ##   ### \n// ##     ## ##     ## #### ##    ## \n//\n\nvoid main() {\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tvViewPosition = mvPosition.xyz;\n\tgl_Position = projectionMatrix * mvPosition;\n\tvLogDepth = log2(-mvPosition.z);\n\n\t// POINT SIZE\n\tfloat pointSize = getPointSize();\n\tgl_PointSize = pointSize;\n\tvPointSize = pointSize;\n\n\t// COLOR\n\t#if defined(color_type_composite) && defined(color_type_intensity)\n\t\tvColor = vec4(getColor(),getIntensity());\n\t#else\n\t\tvColor = vec4(getColor(),1.0);\n\t#endif\n\n\t#if defined hq_depth_pass\n\t\tfloat originalDepth = gl_Position.w;\n\t\tfloat adjustedDepth = originalDepth + 2.0 * vRadius;\n\t\tfloat adjust = adjustedDepth / originalDepth;\n\n\t\tmvPosition.xyz = mvPosition.xyz * adjust;\n\t\tgl_Position = projectionMatrix * mvPosition;\n\t#endif\n\n\n\t// CLIPPING\n\tdoClipping();\n\t\n\n\n\n\n\t//#if defined(num_snapshots) && num_snapshots > 0\n\n\t//\tfor(int i = 0; i < num_snapshots; i++){\n\t//\t\tvSnapProjected[i] = uSnapProj[i] * uSnapView[i] * modelMatrix * vec4(position, 1.0);\t\n\t//\t\tvSnapProjectedDistance[i] = -(uSnapView[i] * modelMatrix * vec4(position, 1.0)).z;\n\t//\t}\n\t//\t\n\t//#endif\n\n\t#if defined(num_shadowmaps) && num_shadowmaps > 0\n\n\t\tconst float sm_near = 0.1;\n\t\tconst float sm_far = 10000.0;\n\n\t\tfor(int i = 0; i < num_shadowmaps; i++){\n\t\t\tvec3 viewPos = (uShadowWorldView[i] * vec4(position, 1.0)).xyz;\n\t\t\tfloat distanceToLight = abs(viewPos.z);\n\t\t\t\n\t\t\tvec4 projPos = uShadowProj[i] * uShadowWorldView[i] * vec4(position, 1);\n\t\t\tvec3 nc = projPos.xyz / projPos.w;\n\t\t\t\n\t\t\tfloat u = nc.x * 0.5 + 0.5;\n\t\t\tfloat v = nc.y * 0.5 + 0.5;\n\n\t\t\tvec2 sampleStep = vec2(1.0 / (2.0*1024.0), 1.0 / (2.0*1024.0)) * 1.5;\n\t\t\tvec2 sampleLocations[9];\n\t\t\tsampleLocations[0] = vec2(0.0, 0.0);\n\t\t\tsampleLocations[1] = sampleStep;\n\t\t\tsampleLocations[2] = -sampleStep;\n\t\t\tsampleLocations[3] = vec2(sampleStep.x, -sampleStep.y);\n\t\t\tsampleLocations[4] = vec2(-sampleStep.x, sampleStep.y);\n\n\t\t\tsampleLocations[5] = vec2(0.0, sampleStep.y);\n\t\t\tsampleLocations[6] = vec2(0.0, -sampleStep.y);\n\t\t\tsampleLocations[7] = vec2(sampleStep.x, 0.0);\n\t\t\tsampleLocations[8] = vec2(-sampleStep.x, 0.0);\n\n\t\t\tfloat visibleSamples = 0.0;\n\t\t\tfloat numSamples = 0.0;\n\n\t\t\tfloat bias = vRadius * 2.0;\n\n\t\t\tfor(int j = 0; j < 9; j++){\n\t\t\t\tvec4 depthMapValue = texture2D(uShadowMap[i], vec2(u, v) + sampleLocations[j]);\n\n\t\t\t\tfloat linearDepthFromSM = depthMapValue.x + bias;\n\t\t\t\tfloat linearDepthFromViewer = distanceToLight;\n\n\t\t\t\tif(linearDepthFromSM > linearDepthFromViewer){\n\t\t\t\t\tvisibleSamples += 1.0;\n\t\t\t\t}\n\n\t\t\t\tnumSamples += 1.0;\n\t\t\t}\n\n\t\t\tfloat visibility = visibleSamples / numSamples;\n\n\t\t\tif(u < 0.0 || u > 1.0 || v < 0.0 || v > 1.0 || nc.x < -1.0 || nc.x > 1.0 || nc.y < -1.0 || nc.y > 1.0 || nc.z < -1.0 || nc.z > 1.0){\n\t\t\t\t//vColor = vec3(0.0, 0.0, 0.2);\n\t\t\t}else{\n\t\t\t\t//vColor = vec3(1.0, 1.0, 1.0) * visibility + vec3(1.0, 1.0, 1.0) * vec3(0.5, 0.0, 0.0) * (1.0 - visibility);\n\t\t\t\tvColor = vColor * visibility + vColor * uShadowColor * (1.0 - visibility);\n\t\t\t}\n\t\t}\n\n\t#endif\n\n\tif(uDebug){\n\t\tvColor.b = (vColor.r + vColor.g + vColor.b) / 3.0;\n\t\tvColor.r = 1.0;\n\t\tvColor.g = 1.0;\n\t}\n\n}\n",Pt.Shaders["pointcloud.fs"]="\n#if defined paraboloid_point_shape\n\t#extension GL_EXT_frag_depth : enable\n#endif\n\nprecision highp float;\nprecision highp int;\n\nuniform mat4 viewMatrix;\nuniform mat4 uViewInv;\nuniform mat4 uProjInv;\nuniform vec3 cameraPosition;\n\n\nuniform mat4 projectionMatrix;\nuniform float uOpacity;\n\nuniform float blendHardness;\nuniform float blendDepthSupplement;\nuniform float fov;\nuniform float uSpacing;\nuniform float near;\nuniform float far;\nuniform float uPCIndex;\nuniform float uScreenWidth;\nuniform float uScreenHeight;\n\nvarying vec4\tvColor;\nvarying float\tvLogDepth;\nvarying vec3\tvViewPosition;\nvarying float\tvRadius;\nvarying float \tvPointSize;\nvarying vec3 \tvPosition;\n\n#if defined(num_snapshots) && num_snapshots > 0\nuniform sampler2D uSnapshot[num_snapshots];\nuniform sampler2D uSnapshotDepth[num_snapshots];\nuniform mat4 uSnapView[num_snapshots];\nuniform mat4 uSnapProj[num_snapshots];\nuniform mat4 uSnapProjInv[num_snapshots];\nuniform mat4 uSnapViewInv[num_snapshots];\n\nvarying float vSnapTextureID;\n#endif\n\n\n\n\n\n\nfloat specularStrength = 1.0;\n\nvoid main() {\n\n\tvec4 color = vColor;\n\tfloat depth = gl_FragCoord.z;\n\n\n\t//#if defined(num_snapshots) && num_snapshots > 0\n\t//\tvec3 sRGB = vec3(0.0, 0.0, 0.0);\n\t//\tfloat sA = 0.0;\n\n\t//\tfor(int i = 0; i < num_snapshots; i++){\n\n\t//\t\tfloat snapLinearDistance = 0.0;\n\t//\t\tfloat currentLinearDistance = vSnapProjectedDistance[i];\n\t//\t\tvec2 uv;\n\n\t//\t\t{\n\t//\t\t\tvec2 pc = vec2(gl_PointCoord.x - 0.5, (1.0 - gl_PointCoord.y) - 0.5);\n\t//\t\t\tvec2 offset = (pc * vPointSize) / vec2(uScreenWidth, uScreenHeight);\n\t//\t\n\t//\t\t\tuv = 0.5 * (vSnapProjected[i].xy /vSnapProjected[i].w) + 0.5 + offset;\t\n\t//\t\t\t\n\t//\t\t\tvec4 td = texture2D(uSnapshotDepth[i], uv);\n\t//\t\t\tfloat d = td.r;\n\n\t//\t\t\t// TODO save linear distance in uSnapshotDepth!!!\n\t//\t\t\tvec4 snapViewPos = uSnapProjInv[i] * vec4(uv * 2.0 - 1.0, d * 2.0 - 1.0, 1.0);\n\t//\t\t\tsnapViewPos = snapViewPos / snapViewPos.w;\n\t//\t\t\tsnapLinearDistance = -snapViewPos.z;\n\n\t//\t\t}\n\n\t//\t\tif(abs(currentLinearDistance - snapLinearDistance) < vRadius * 1.0){\n\t//\t\t\tvec4 col = texture2D(uSnapshot[i], uv);\n\t//\t\t\t//vec4 col = vec4(0.5, 1.0, 0.0, 1.0);\n\t//\t\t\tsRGB += col.rgb;\n\n\t//\t\t\tif(col.a != 0.0){\n\t//\t\t\t\tsA = sA + 1.0;\n\t//\t\t\t}\n\t//\t\t}else{\n\t//\t\t\t//sRGB += vColor;\n\t//\t\t\t//sA += 1.0;\n\t//\t\t\t\n\t//\t\t}\n\n\t//\t}\n\n\n\t//\tcolor = sRGB / sA;\n\t//\tif(sA == 0.0){\n\t//\t\t//color = vColor;\n\t//\t\tdiscard;\n\t//\t}\n\t//\n\t//#endif\n\n\n\t#if defined(circle_point_shape) || defined(paraboloid_point_shape) \n\t\tfloat u = 2.0 * gl_PointCoord.x - 1.0;\n\t\tfloat v = 2.0 * gl_PointCoord.y - 1.0;\n\t#endif\n\t\n\t#if defined(circle_point_shape) \n\t\tfloat cc = u*u + v*v;\n\t\tif(cc > 1.0){\n\t\t\tdiscard;\n\t\t}\n\t#endif\n\t\t\n\t#if defined color_type_point_index\n\t\tgl_FragColor = vec4(color.rgb, uPCIndex / 255.0);\n\t#elif defined color_type_composite\n\t\tgl_FragColor = color;\n\t#else\n\t\tgl_FragColor = vec4(color.rgb,uOpacity);\n\t#endif\n\n\t#if defined paraboloid_point_shape\n\t\tfloat wi = 0.0 - ( u*u + v*v);\n\t\tvec4 pos = vec4(vViewPosition, 1.0);\n\t\tpos.z += wi * vRadius;\n\t\tfloat linearDepth = -pos.z;\n\t\tpos = projectionMatrix * pos;\n\t\tpos = pos / pos.w;\n\t\tfloat expDepth = pos.z;\n\t\tdepth = (pos.z + 1.0) / 2.0;\n\t\tgl_FragDepthEXT = depth;\n\t\t\n\t\t#if defined(color_type_depth)\n\t\t\tcolor.r = linearDepth;\n\t\t\tcolor.g = expDepth;\n\t\t#endif\n\t\t\n\t\t#if defined(use_edl)\n\t\t\tgl_FragColor.a = log2(linearDepth);\n\t\t#endif\n\t\t\n\t#else\n\t\t#if defined(use_edl)\n\t\t\tgl_FragColor.a = vLogDepth;\n\t\t#endif\n\t#endif\n\n\t#if defined(weighted_splats)\n\t\tfloat distance = 2.0 * length(gl_PointCoord.xy - 0.5);\n\t\tfloat weight = max(0.0, 1.0 - distance);\n\t\tweight = pow(weight, 1.5);\n\n\t\tgl_FragColor.a = weight;\n\t\tgl_FragColor.xyz = gl_FragColor.xyz * weight;\n\t#endif\n\t\n}\n\n\n",Pt.Shaders["pointcloud_sm.vs"]="\nprecision mediump float;\nprecision mediump int;\n\nattribute vec3 position;\nattribute vec3 color;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\n\nuniform float uScreenWidth;\nuniform float uScreenHeight;\nuniform float near;\nuniform float far;\n\nuniform float uSpacing;\nuniform float uOctreeSize;\nuniform float uLevel;\nuniform float uVNStart;\n\nuniform sampler2D visibleNodes;\n\nvarying float vLinearDepth;\nvarying vec3 vColor;\n\n#define PI 3.141592653589793\n\n\n\n// ---------------------\n// OCTREE\n// ---------------------\n\n#if defined(adaptive_point_size)\n/**\n * number of 1-bits up to inclusive index position\n * number is treated as if it were an integer in the range 0-255\n *\n */\nfloat numberOfOnes(float number, float index){\n\tfloat tmp = mod(number, pow(2.0, index + 1.0));\n\tfloat numOnes = 0.0;\n\tfor(float i = 0.0; i < 8.0; i++){\n\t\tif(mod(tmp, 2.0) != 0.0){\n\t\t\tnumOnes++;\n\t\t}\n\t\ttmp = floor(tmp / 2.0);\n\t}\n\treturn numOnes;\n}\n\n\n/**\n * checks whether the bit at index is 1\n * number is treated as if it were an integer in the range 0-255\n *\n */\nbool isBitSet(float number, float index){\n\treturn mod(floor(number / pow(2.0, index)), 2.0) != 0.0;\n}\n\n\n/**\n * find the LOD at the point position\n */\nfloat getLOD(){\n\t\n\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\tfloat iOffset = uVNStart;\n\tfloat depth = uLevel;\n\tfor(float i = 0.0; i <= 30.0; i++){\n\t\tfloat nodeSizeAtLevel = uOctreeSize  / pow(2.0, i + uLevel + 0.0);\n\t\t\n\t\tvec3 index3d = (position-offset) / nodeSizeAtLevel;\n\t\tindex3d = floor(index3d + 0.5);\n\t\tfloat index = 4.0 * index3d.x + 2.0 * index3d.y + index3d.z;\n\t\t\n\t\tvec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));\n\t\tfloat mask = value.r * 255.0;\n\t\tif(isBitSet(mask, index)){\n\t\t\t// there are more visible child nodes at this position\n\t\t\tiOffset = iOffset + value.g * 255.0 * 256.0 + value.b * 255.0 + numberOfOnes(mask, index - 1.0);\n\t\t\tdepth++;\n\t\t}else{\n\t\t\t// no more visible child nodes at this position\n\t\t\treturn depth;\n\t\t}\n\t\t\n\t\toffset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;\n\t}\n\t\t\n\treturn depth;\n}\n\n#endif\n\nfloat getPointSize(){\n\tfloat pointSize = 1.0;\n\t\n\tfloat slope = tan(fov / 2.0);\n\tfloat projFactor =  -0.5 * uScreenHeight / (slope * vViewPosition.z);\n\t\n\tfloat r = uOctreeSpacing * 1.5;\n\tvRadius = r;\n\t#if defined fixed_point_size\n\t\tpointSize = size;\n\t#elif defined attenuated_point_size\n\t\tif(uUseOrthographicCamera){\n\t\t\tpointSize = size;\t\t\t\n\t\t}else{\n\t\t\tpointSize = pointSize * projFactor;\n\t\t}\n\t#elif defined adaptive_point_size\n\t\tif(uUseOrthographicCamera) {\n\t\t\tfloat worldSpaceSize = 1.5 * size * r / getPointSizeAttenuation();\n\t\t\tpointSize = (worldSpaceSize / uOrthoWidth) * uScreenWidth;\n\t\t} else {\n\t\t\tfloat worldSpaceSize = 1.5 * size * r / getPointSizeAttenuation();\n\t\t\tpointSize = worldSpaceSize * projFactor;\n\t\t}\n\t#endif\n\n\tpointSize = max(minSize, pointSize);\n\tpointSize = min(maxSize, pointSize);\n\t\n\tvRadius = pointSize / projFactor;\n\n\treturn pointSize;\n}\n\n\nvoid main() {\n\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tvLinearDepth = gl_Position.w;\n\n\tfloat pointSize = getPointSize();\n\tgl_PointSize = pointSize;\n\n}\n",Pt.Shaders["pointcloud_sm.fs"]="\nprecision mediump float;\nprecision mediump int;\n\nvarying vec3 vColor;\nvarying float vLinearDepth;\n\nvoid main() {\n\n\t//gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t//gl_FragColor = vec4(vColor, 1.0);\n\t//gl_FragColor = vec4(vLinearDepth, pow(vLinearDepth, 2.0), 0.0, 1.0);\n\tgl_FragColor = vec4(vLinearDepth, vLinearDepth / 30.0, vLinearDepth / 30.0, 1.0);\n\t\n}\n\n\n",Pt.Shaders["normalize.vs"]="\nprecision mediump float;\nprecision mediump int;\n\nattribute vec3 position;\nattribute vec2 uv;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\n\nvarying vec2 vUv;\n\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n}",Pt.Shaders["normalize.fs"]="\n#extension GL_EXT_frag_depth : enable\n\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D uWeightMap;\nuniform sampler2D uDepthMap;\n\nvarying vec2 vUv;\n\nvoid main() {\n\tfloat depth = texture2D(uDepthMap, vUv).r;\n\t\n\tif(depth >= 1.0){\n\t\tdiscard;\n\t}\n\n\tgl_FragColor = vec4(depth, 1.0, 0.0, 1.0);\n\n\tvec4 color = texture2D(uWeightMap, vUv); \n\tcolor = color / color.w;\n\t\n\tgl_FragColor = vec4(color.xyz, 1.0); \n\t\n\tgl_FragDepthEXT = depth;\n\n\n}",Pt.Shaders["normalize_and_edl.fs"]="\n#extension GL_EXT_frag_depth : enable\n\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D uWeightMap;\nuniform sampler2D uEDLMap;\nuniform sampler2D uDepthMap;\n\nuniform float screenWidth;\nuniform float screenHeight;\nuniform vec2 neighbours[NEIGHBOUR_COUNT];\nuniform float edlStrength;\nuniform float radius;\n\nvarying vec2 vUv;\n\nfloat response(float depth){\n\tvec2 uvRadius = radius / vec2(screenWidth, screenHeight);\n\t\n\tfloat sum = 0.0;\n\t\n\tfor(int i = 0; i < NEIGHBOUR_COUNT; i++){\n\t\tvec2 uvNeighbor = vUv + uvRadius * neighbours[i];\n\t\t\n\t\tfloat neighbourDepth = texture2D(uEDLMap, uvNeighbor).a;\n\n\t\tif(neighbourDepth != 0.0){\n\t\t\tif(depth == 0.0){\n\t\t\t\tsum += 100.0;\n\t\t\t}else{\n\t\t\t\tsum += max(0.0, depth - neighbourDepth);\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn sum / float(NEIGHBOUR_COUNT);\n}\n\nvoid main() {\n\n\tfloat edlDepth = texture2D(uEDLMap, vUv).a;\n\tfloat res = response(edlDepth);\n\tfloat shade = exp(-res * 300.0 * edlStrength);\n\n\tfloat depth = texture2D(uDepthMap, vUv).r;\n\tif(depth >= 1.0 && res == 0.0){\n\t\tdiscard;\n\t}\n\t\n\tvec4 color = texture2D(uWeightMap, vUv); \n\tcolor = color / color.w;\n\tcolor = color * shade;\n\n\tgl_FragColor = vec4(color.xyz, 1.0); \n\n\tgl_FragDepthEXT = depth;\n}",Pt.Shaders["edl.vs"]="\n\nvarying vec2 vUv;\n\nvoid main() {\n    vUv = uv;\n\t\n\tvec4 mvPosition = modelViewMatrix * vec4(position,1.0);\n\n    gl_Position = projectionMatrix * mvPosition;\n}",Pt.Shaders["edl.fs"]="// \n// adapted from the EDL shader code from Christian Boucheny in cloud compare:\n// https://github.com/cloudcompare/trunk/tree/master/plugins/qEDL/shaders/EDL\n//\n\nuniform float screenWidth;\nuniform float screenHeight;\nuniform vec2 neighbours[NEIGHBOUR_COUNT];\nuniform float edlStrength;\nuniform float radius;\nuniform float opacity;\n\n//uniform sampler2D colorMap;\nuniform sampler2D uRegularColor;\nuniform sampler2D uRegularDepth;\nuniform sampler2D uEDLColor;\nuniform sampler2D uEDLDepth;\n\nvarying vec2 vUv;\n\nfloat response(float depth){\n\tvec2 uvRadius = radius / vec2(screenWidth, screenHeight);\n\t\n\tfloat sum = 0.0;\n\t\n\tfor(int i = 0; i < NEIGHBOUR_COUNT; i++){\n\t\tvec2 uvNeighbor = vUv + uvRadius * neighbours[i];\n\t\t\n\t\tfloat neighbourDepth = texture2D(uEDLColor, uvNeighbor).a;\n\t\tneighbourDepth = (neighbourDepth == 1.0) ? 0.0 : neighbourDepth;\n\n\t\tif(neighbourDepth != 0.0){\n\t\t\tif(depth == 0.0){\n\t\t\t\tsum += 100.0;\n\t\t\t}else{\n\t\t\t\tsum += max(0.0, depth - neighbourDepth);\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn sum / float(NEIGHBOUR_COUNT);\n}\n\nvoid main(){\n\tvec4 cReg = texture2D(uRegularColor, vUv);\n\tvec4 cEDL = texture2D(uEDLColor, vUv);\n\t\n\tfloat depth = cEDL.a;\n\tdepth = (depth == 1.0) ? 0.0 : depth;\n\tfloat res = response(depth);\n\tfloat shade = exp(-res * 300.0 * edlStrength);\n\n\tfloat dReg = texture2D(uRegularDepth, vUv).r;\n\tfloat dEDL = texture2D(uEDLDepth, vUv).r;\n\n\tif(dEDL < dReg){\n\t\tgl_FragColor = vec4(cEDL.rgb * shade, opacity);\n\t}else{\n\t\tgl_FragColor = vec4(cReg.rgb * shade, cReg.a);\n\t}\n\n}\n",Pt.Shaders["blur.vs"]="\nvarying vec2 vUv;\n\nvoid main() {\n    vUv = uv;\n\n    gl_Position =   projectionMatrix * modelViewMatrix * vec4(position,1.0);\n}",Pt.Shaders["blur.fs"]="\nuniform mat4 projectionMatrix;\n\nuniform float screenWidth;\nuniform float screenHeight;\nuniform float near;\nuniform float far;\n\nuniform sampler2D map;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tfloat dx = 1.0 / screenWidth;\n\tfloat dy = 1.0 / screenHeight;\n\n\tvec3 color = vec3(0.0, 0.0, 0.0);\n\tcolor += texture2D(map, vUv + vec2(-dx, -dy)).rgb;\n\tcolor += texture2D(map, vUv + vec2(  0, -dy)).rgb;\n\tcolor += texture2D(map, vUv + vec2(+dx, -dy)).rgb;\n\tcolor += texture2D(map, vUv + vec2(-dx,   0)).rgb;\n\tcolor += texture2D(map, vUv + vec2(  0,   0)).rgb;\n\tcolor += texture2D(map, vUv + vec2(+dx,   0)).rgb;\n\tcolor += texture2D(map, vUv + vec2(-dx,  dy)).rgb;\n\tcolor += texture2D(map, vUv + vec2(  0,  dy)).rgb;\n\tcolor += texture2D(map, vUv + vec2(+dx,  dy)).rgb;\n    \n\tcolor = color / 9.0;\n\t\n\tgl_FragColor = vec4(color, 1.0);\n\t\n\t\n}",Pt.POCLoader=function(){},Pt.POCLoader.load=function(g,y){try{var E=new Pt.PointCloudOctreeGeometry;E.url=g;var T=Pt.XHRFactory.createXMLHttpRequest();T.open("GET",g,!0),T.onreadystatechange=function(){if(4===T.readyState&&(200===T.status||0===T.status)){var e=JSON.parse(T.responseText),t=new Pt.Version(e.version);0===e.octreeDir.indexOf("http")?E.octreeDir=e.octreeDir:E.octreeDir=g+"/../"+e.octreeDir,E.spacing=e.spacing,E.hierarchyStepSize=e.hierarchyStepSize,E.pointAttributes=e.pointAttributes;var n=new THREE.Vector3(e.boundingBox.lx,e.boundingBox.ly,e.boundingBox.lz),i=new THREE.Vector3(e.boundingBox.ux,e.boundingBox.uy,e.boundingBox.uz),r=new THREE.Box3(n,i),o=r.clone();e.tightBoundingBox&&(o.min.copy(new THREE.Vector3(e.tightBoundingBox.lx,e.tightBoundingBox.ly,e.tightBoundingBox.lz)),o.max.copy(new THREE.Vector3(e.tightBoundingBox.ux,e.tightBoundingBox.uy,e.tightBoundingBox.uz)));var a=n.clone();r.min.sub(a),r.max.sub(a),o.min.sub(a),o.max.sub(a),E.projection=e.projection,E.boundingBox=r,E.tightBoundingBox=o,E.boundingSphere=r.getBoundingSphere(new THREE.Sphere),E.tightBoundingSphere=o.getBoundingSphere(new THREE.Sphere),E.offset=a,"LAS"===e.pointAttributes?E.loader=new Pt.LasLazLoader(e.version):"LAZ"===e.pointAttributes?E.loader=new Pt.LasLazLoader(e.version):(E.loader=new Pt.BinaryLoader(e.version,r,e.scale),E.pointAttributes=new Pt.PointAttributes(E.pointAttributes));var s={},l=new Pt.PointCloudOctreeGeometryNode("r",E,r);if(l.level=0,l.hasChildren=!0,l.spacing=E.spacing,t.upTo("1.5")?l.numPoints=e.hierarchy[0][1]:l.numPoints=0,E.root=l,E.root.load(),s.r=l,t.upTo("1.4"))for(var u=1;u<e.hierarchy.length;u++){var c=e.hierarchy[u][0],h=e.hierarchy[u][1],d=parseInt(c.charAt(c.length-1)),p=s[c.substring(0,c.length-1)],v=c.length-1,f=Pt.POCLoader.createChildAABB(p.boundingBox,d),m=new Pt.PointCloudOctreeGeometryNode(c,E,f);m.level=v,m.numPoints=h,m.spacing=E.spacing/Math.pow(2,v),p.addChild(m),s[c]=m}E.nodes=s,y(E)}},T.send(null)}catch(e){console.log("loading failed: '"+g+"'"),console.log(e),y()}},Pt.POCLoader.loadPointAttributes=function(e){for(var t=e.pointAttributes,n=new Pt.PointAttributes,i=0;i<t.length;i++){var r=Pt.PointAttribute[t[i]];n.add(r)}return n},Pt.POCLoader.createChildAABB=function(e,t){var n=e.min.clone(),i=e.max.clone(),r=(new THREE.Vector3).subVectors(i,n);return 0<(1&t)?n.z+=r.z/2:i.z-=r.z/2,0<(2&t)?n.y+=r.y/2:i.y-=r.y/2,0<(4&t)?n.x+=r.x/2:i.x-=r.x/2,new THREE.Box3(n,i)},Pt.PointAttributeNames={},Pt.PointAttributeNames.POSITION_CARTESIAN=0,Pt.PointAttributeNames.COLOR_PACKED=1,Pt.PointAttributeNames.COLOR_FLOATS_1=2,Pt.PointAttributeNames.COLOR_FLOATS_255=3,Pt.PointAttributeNames.NORMAL_FLOATS=4,Pt.PointAttributeNames.FILLER=5,Pt.PointAttributeNames.INTENSITY=6,Pt.PointAttributeNames.CLASSIFICATION=7,Pt.PointAttributeNames.NORMAL_SPHEREMAPPED=8,Pt.PointAttributeNames.NORMAL_OCT16=9,Pt.PointAttributeNames.NORMAL=10,Pt.PointAttributeNames.RETURN_NUMBER=11,Pt.PointAttributeNames.NUMBER_OF_RETURNS=12,Pt.PointAttributeNames.SOURCE_ID=13,Pt.PointAttributeNames.INDICES=14,Pt.PointAttributeNames.SPACING=15,Pt.PointAttributeTypes={DATA_TYPE_DOUBLE:{ordinal:0,size:8},DATA_TYPE_FLOAT:{ordinal:1,size:4},DATA_TYPE_INT8:{ordinal:2,size:1},DATA_TYPE_UINT8:{ordinal:3,size:1},DATA_TYPE_INT16:{ordinal:4,size:2},DATA_TYPE_UINT16:{ordinal:5,size:2},DATA_TYPE_INT32:{ordinal:6,size:4},DATA_TYPE_UINT32:{ordinal:7,size:4},DATA_TYPE_INT64:{ordinal:8,size:8},DATA_TYPE_UINT64:{ordinal:9,size:8}};var i=0;for(var obj in Pt.PointAttributeTypes)Pt.PointAttributeTypes[i]=Pt.PointAttributeTypes[obj],i++;function LRUItem(e){this.previous=null,this.next=null,this.node=e}function LRU(){this.first=null,this.last=null,this.items={},this.elements=0,this.numPoints=0}Pt.PointAttribute=function(e,t,n){this.name=e,this.type=t,this.numElements=n,this.byteSize=this.numElements*this.type.size},Pt.PointAttribute.POSITION_CARTESIAN=new Pt.PointAttribute(Pt.PointAttributeNames.POSITION_CARTESIAN,Pt.PointAttributeTypes.DATA_TYPE_FLOAT,3),Pt.PointAttribute.RGBA_PACKED=new Pt.PointAttribute(Pt.PointAttributeNames.COLOR_PACKED,Pt.PointAttributeTypes.DATA_TYPE_INT8,4),Pt.PointAttribute.COLOR_PACKED=Pt.PointAttribute.RGBA_PACKED,Pt.PointAttribute.RGB_PACKED=new Pt.PointAttribute(Pt.PointAttributeNames.COLOR_PACKED,Pt.PointAttributeTypes.DATA_TYPE_INT8,3),Pt.PointAttribute.NORMAL_FLOATS=new Pt.PointAttribute(Pt.PointAttributeNames.NORMAL_FLOATS,Pt.PointAttributeTypes.DATA_TYPE_FLOAT,3),Pt.PointAttribute.FILLER_1B=new Pt.PointAttribute(Pt.PointAttributeNames.FILLER,Pt.PointAttributeTypes.DATA_TYPE_UINT8,1),Pt.PointAttribute.INTENSITY=new Pt.PointAttribute(Pt.PointAttributeNames.INTENSITY,Pt.PointAttributeTypes.DATA_TYPE_UINT16,1),Pt.PointAttribute.CLASSIFICATION=new Pt.PointAttribute(Pt.PointAttributeNames.CLASSIFICATION,Pt.PointAttributeTypes.DATA_TYPE_UINT8,1),Pt.PointAttribute.NORMAL_SPHEREMAPPED=new Pt.PointAttribute(Pt.PointAttributeNames.NORMAL_SPHEREMAPPED,Pt.PointAttributeTypes.DATA_TYPE_UINT8,2),Pt.PointAttribute.NORMAL_OCT16=new Pt.PointAttribute(Pt.PointAttributeNames.NORMAL_OCT16,Pt.PointAttributeTypes.DATA_TYPE_UINT8,2),Pt.PointAttribute.NORMAL=new Pt.PointAttribute(Pt.PointAttributeNames.NORMAL,Pt.PointAttributeTypes.DATA_TYPE_FLOAT,3),Pt.PointAttribute.RETURN_NUMBER=new Pt.PointAttribute(Pt.PointAttributeNames.RETURN_NUMBER,Pt.PointAttributeTypes.DATA_TYPE_UINT8,1),Pt.PointAttribute.NUMBER_OF_RETURNS=new Pt.PointAttribute(Pt.PointAttributeNames.NUMBER_OF_RETURNS,Pt.PointAttributeTypes.DATA_TYPE_UINT8,1),Pt.PointAttribute.SOURCE_ID=new Pt.PointAttribute(Pt.PointAttributeNames.SOURCE_ID,Pt.PointAttributeTypes.DATA_TYPE_UINT8,1),Pt.PointAttribute.INDICES=new Pt.PointAttribute(Pt.PointAttributeNames.INDICES,Pt.PointAttributeTypes.DATA_TYPE_UINT32,1),Pt.PointAttribute.SPACING=new Pt.PointAttribute(Pt.PointAttributeNames.SPACING,Pt.PointAttributeTypes.DATA_TYPE_FLOAT,1),Pt.PointAttributes=function(e){if(this.attributes=[],this.byteSize=0,this.size=0,null!=e)for(var t=0;t<e.length;t++){var n=e[t],i=Pt.PointAttribute[n];this.attributes.push(i),this.byteSize+=i.byteSize,this.size++}},Pt.PointAttributes.prototype.add=function(e){this.attributes.push(e),this.byteSize+=e.byteSize,this.size++},Pt.PointAttributes.prototype.hasColors=function(){for(var e in this.attributes){if(this.attributes[e].name===Pt.PointAttributeNames.COLOR_PACKED)return!0}return!1},Pt.PointAttributes.prototype.hasNormals=function(){for(var e in this.attributes){var t=this.attributes[e];if(t===Pt.PointAttribute.NORMAL_SPHEREMAPPED||t===Pt.PointAttribute.NORMAL_FLOATS||t===Pt.PointAttribute.NORMAL||t===Pt.PointAttribute.NORMAL_OCT16)return!0}return!1},Pt.BinaryLoader=function(){function i(e,t,n){_classCallCheck(this,i),this.version="string"==typeof e?new Pt.Version(e):e,this.boundingBox=t,this.scale=n}return _createClass(i,[{key:"load",value:function(t){var n=this;if(!t.loaded){var i=t.getURL();this.version.equalOrHigher("1.4")&&(i+=".bin");var r=Pt.XHRFactory.createXMLHttpRequest();r.open("GET",i,!0),r.responseType="arraybuffer",r.overrideMimeType("text/plain; charset=x-user-defined"),r.onreadystatechange=function(){if(4===r.readyState){if(200!==r.status&&0!==r.status||null===r.response)throw new Error("Failed to load file! HTTP status: "+r.status+", file: "+i);var e=r.response;n.parse(t,e)}};try{r.send(null)}catch(e){console.log("fehler beim laden der punktwolke: "+e)}}}},{key:"parse",value:function(c,e){var h=c.pcoGeometry.pointAttributes,t=e.byteLength/c.pcoGeometry.pointAttributes.byteSize;this.version.upTo("1.5")&&(c.numPoints=t);var d=Pt.scriptPath+"/workers/BinaryDecoderWorker.js",p=Pt.workerPool.getWorker(d);p.onmessage=function(e){var t=e.data,n=t.attributeBuffers,i=new THREE.Box3((new THREE.Vector3).fromArray(t.tightBoundingBox.min),(new THREE.Vector3).fromArray(t.tightBoundingBox.max));Pt.workerPool.returnWorker(d,p);var r=new THREE.BufferGeometry;for(var o in n){var a=n[o].buffer;if(parseInt(o)===Pt.PointAttributeNames.POSITION_CARTESIAN)r.addAttribute("position",new THREE.BufferAttribute(new Float32Array(a),3));else if(parseInt(o)===Pt.PointAttributeNames.COLOR_PACKED)r.addAttribute("color",new THREE.BufferAttribute(new Uint8Array(a),4,!0));else if(parseInt(o)===Pt.PointAttributeNames.INTENSITY)r.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(a),1));else if(parseInt(o)===Pt.PointAttributeNames.CLASSIFICATION)r.addAttribute("classification",new THREE.BufferAttribute(new Uint8Array(a),1));else if(parseInt(o)===Pt.PointAttributeNames.NORMAL_SPHEREMAPPED)r.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(a),3));else if(parseInt(o)===Pt.PointAttributeNames.NORMAL_OCT16)r.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(a),3));else if(parseInt(o)===Pt.PointAttributeNames.NORMAL)r.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(a),3));else if(parseInt(o)===Pt.PointAttributeNames.INDICES){var s=new THREE.BufferAttribute(new Uint8Array(a),4);s.normalized=!0,r.addAttribute("indices",s)}else if(parseInt(o)===Pt.PointAttributeNames.SPACING){var l=new THREE.BufferAttribute(new Float32Array(a),1);r.addAttribute("spacing",l)}}i.max.sub(i.min),i.min.set(0,0,0);var u=e.data.buffer.byteLength/h.byteSize;c.numPoints=u,c.geometry=r,c.mean=new(Function.prototype.bind.apply(THREE.Vector3,[null].concat(_toConsumableArray(t.mean)))),c.tightBoundingBox=i,c.loaded=!0,c.loading=!1,c.estimatedSpacing=t.estimatedSpacing,Pt.numNodesLoading--};var n={buffer:e,pointAttributes:h,version:this.version.version,min:[c.boundingBox.min.x,c.boundingBox.min.y,c.boundingBox.min.z],offset:[c.pcoGeometry.offset.x,c.pcoGeometry.offset.y,c.pcoGeometry.offset.z],scale:this.scale,spacing:c.spacing,hasChildren:c.hasChildren,name:c.name};p.postMessage(n,[n.buffer])}}]),i}(),Pt.LasLazLoader=function(){function t(e){_classCallCheck(this,t),this.version="string"==typeof e?new Pt.Version(e):e}return _createClass(t,[{key:"load",value:function(t){var n=this;if(!t.loaded){var e=t.pcoGeometry.pointAttributes,i=t.getURL();this.version.equalOrHigher("1.4")&&(i+="."+e.toLowerCase());var r=Pt.XHRFactory.createXMLHttpRequest();r.open("GET",i,!0),r.responseType="arraybuffer",r.overrideMimeType("text/plain; charset=x-user-defined"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status){var e=r.response;n.parse(t,e)}else console.log("Failed to load file! HTTP status: "+r.status+", file: "+i)},r.send(null)}}},{key:"parse",value:function(e,t){var n=new LASFile(t),a=new Pt.LasLazBatcher(e);n.open().then(function(e){return n.isOpen=!0,n}).catch(function(e){console.log("failed to open file. :(")}).then(function(t){return t.getHeader().then(function(e){return[t,e]})}).then(function(e){var n=e[0],i=e[1],r=0,o=i.pointsCount;return function t(){return n.readData(1e6,0,1).then(function(e){return a.push(new LASDecoder(e.buffer,i.pointsFormatId,i.pointsStructSize,e.count,i.scale,i.offset,i.mins,i.maxs)),r+=e.count,Pt.LasLazLoader.progressCB(r/o),e.hasMoreData?t():(i.totalRead=r,i.versionAsString=n.versionAsString,i.isCompressed=n.isCompressed,[n,i,a])})}()}).then(function(e){var t=e[0];return Pt.LasLazLoader.progressCB(1),t.close().then(function(){return t.isOpen=!1,e.slice(1)}).catch(function(e){if(t.isOpen)return t.close().then(function(){throw t.isOpen=!1,e});throw e})})}},{key:"handle",value:function(e,t){}}],[{key:"progressCB",value:function(){}}]),t}(),Pt.LasLazBatcher=function(){function t(e){_classCallCheck(this,t),this.node=e}return _createClass(t,[{key:"push",value:function(d){var p=this,v=Pt.scriptPath+"/workers/LASDecoderWorker.js",f=Pt.workerPool.getWorker(v);this.node;f.onmessage=function(e){var t=new THREE.BufferGeometry,n=d.pointsCount,i=new Float32Array(e.data.position),r=new Uint8Array(e.data.color),o=new Float32Array(e.data.intensity),a=new Uint8Array(e.data.classification),s=new Uint8Array(e.data.returnNumber),l=new Uint8Array(e.data.numberOfReturns),u=new Uint16Array(e.data.pointSourceID),c=new Uint8Array(e.data.indices);t.addAttribute("position",new THREE.BufferAttribute(i,3)),t.addAttribute("color",new THREE.BufferAttribute(r,4,!0)),t.addAttribute("intensity",new THREE.BufferAttribute(o,1)),t.addAttribute("classification",new THREE.BufferAttribute(a,1)),t.addAttribute("returnNumber",new THREE.BufferAttribute(s,1)),t.addAttribute("numberOfReturns",new THREE.BufferAttribute(l,1)),t.addAttribute("pointSourceID",new THREE.BufferAttribute(u,1)),t.addAttribute("indices",new THREE.BufferAttribute(c,4)),t.attributes.indices.normalized=!0;var h=new THREE.Box3((new THREE.Vector3).fromArray(e.data.tightBoundingBox.min),(new THREE.Vector3).fromArray(e.data.tightBoundingBox.max));t.boundingBox=p.node.boundingBox,p.node.tightBoundingBox=h,p.node.geometry=t,p.node.numPoints=n,p.node.loaded=!0,p.node.loading=!1,Pt.numNodesLoading--,p.node.mean=new(Function.prototype.bind.apply(THREE.Vector3,[null].concat(_toConsumableArray(e.data.mean)))),Pt.workerPool.returnWorker(v,f)};var e={buffer:d.arrayb,numPoints:d.pointsCount,pointSize:d.pointSize,pointFormatID:2,scale:d.scale,offset:d.offset,mins:d.mins,maxs:d.maxs};f.postMessage(e,[e.buffer])}}]),t}(),Pt.Gradients={RAINBOW:[[0,new THREE.Color(.278,0,.714)],[1/6,new THREE.Color(0,0,1)],[2/6,new THREE.Color(0,1,1)],[.5,new THREE.Color(0,1,0)],[4/6,new THREE.Color(1,1,0)],[5/6,new THREE.Color(1,.64,0)],[1,new THREE.Color(1,0,0)]],SPECTRAL:[[0,new THREE.Color(.3686,.3098,.6353)],[.1,new THREE.Color(.1961,.5333,.7412)],[.2,new THREE.Color(.4,.7608,.6471)],[.3,new THREE.Color(.6706,.8667,.6431)],[.4,new THREE.Color(.902,.9608,.5961)],[.5,new THREE.Color(1,1,.749)],[.6,new THREE.Color(.9961,.8784,.5451)],[.7,new THREE.Color(.9922,.6824,.3804)],[.8,new THREE.Color(.9569,.4275,.2627)],[.9,new THREE.Color(.8353,.2431,.3098)],[1,new THREE.Color(.6196,.0039,.2588)]],PLASMA:[[0,new THREE.Color(.241,.015,.61)],[.1,new THREE.Color(.387,.001,.654)],[.2,new THREE.Color(.524,.025,.653)],[.3,new THREE.Color(.651,.125,.596)],[.4,new THREE.Color(.752,.227,.513)],[.5,new THREE.Color(.837,.329,.431)],[.6,new THREE.Color(.907,.435,.353)],[.7,new THREE.Color(.963,.554,.272)],[.8,new THREE.Color(.992,.681,.195)],[.9,new THREE.Color(.987,.822,.144)],[1,new THREE.Color(.94,.975,.131)]],YELLOW_GREEN:[[0,new THREE.Color(.1647,.2824,.3451)],[.1,new THREE.Color(.1338,.3555,.4227)],[.2,new THREE.Color(.061,.4319,.4864)],[.3,new THREE.Color(0,.5099,.5319)],[.4,new THREE.Color(0,.5881,.5569)],[.5,new THREE.Color(.137,.665,.5614)],[.6,new THREE.Color(.2906,.7395,.5477)],[.7,new THREE.Color(.4453,.8099,.5201)],[.8,new THREE.Color(.6102,.8748,.485)],[.9,new THREE.Color(.7883,.9323,.4514)],[1,new THREE.Color(.9804,.9804,.4314)]],VIRIDIS:[[0,new THREE.Color(.267,.005,.329)],[.1,new THREE.Color(.283,.141,.458)],[.2,new THREE.Color(.254,.265,.53)],[.3,new THREE.Color(.207,.372,.553)],[.4,new THREE.Color(.164,.471,.558)],[.5,new THREE.Color(.128,.567,.551)],[.6,new THREE.Color(.135,.659,.518)],[.7,new THREE.Color(.267,.749,.441)],[.8,new THREE.Color(.478,.821,.318)],[.9,new THREE.Color(.741,.873,.15)],[1,new THREE.Color(.993,.906,.144)]],INFERNO:[[0,new THREE.Color(.077,.042,.206)],[.1,new THREE.Color(.225,.036,.388)],[.2,new THREE.Color(.373,.074,.432)],[.3,new THREE.Color(.522,.128,.42)],[.4,new THREE.Color(.665,.182,.37)],[.5,new THREE.Color(.797,.255,.287)],[.6,new THREE.Color(.902,.364,.184)],[.7,new THREE.Color(.969,.516,.063)],[.8,new THREE.Color(.988,.683,.072)],[.9,new THREE.Color(.961,.859,.298)],[1,new THREE.Color(.988,.998,.645)]],GRAYSCALE:[[0,new THREE.Color(0,0,0)],[1,new THREE.Color(1,1,1)]]},Pt.Classification={DEFAULT:{0:new THREE.Vector4(.5,.5,.5,1),1:new THREE.Vector4(.5,.5,.5,1),2:new THREE.Vector4(.63,.32,.18,1),3:new THREE.Vector4(0,1,0,1),4:new THREE.Vector4(0,.8,0,1),5:new THREE.Vector4(0,.6,0,1),6:new THREE.Vector4(1,.66,0,1),7:new THREE.Vector4(1,0,1,1),8:new THREE.Vector4(1,0,0,1),9:new THREE.Vector4(0,0,1,1),12:new THREE.Vector4(1,1,0,1),DEFAULT:new THREE.Vector4(.3,.6,.6,.5)}},Pt.PointSizeType={FIXED:0,ATTENUATED:1,ADAPTIVE:2},Pt.PointShape={SQUARE:0,CIRCLE:1,PARABOLOID:2},Pt.PointColorType={RGB:0,COLOR:1,DEPTH:2,HEIGHT:3,ELEVATION:3,INTENSITY:4,INTENSITY_GRADIENT:5,LOD:6,LEVEL_OF_DETAIL:6,POINT_INDEX:7,CLASSIFICATION:8,RETURN_NUMBER:9,SOURCE:10,NORMAL:11,PHONG:12,RGB_HEIGHT:13,COMPOSITE:50},Pt.TreeType={OCTREE:0,KDTREE:1},Pt.PointCloudMaterial=function(e){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,s);var t=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));t.visibleNodesTexture=Pt.utils.generateDataTexture(2048,1,new THREE.Color(16777215)),t.visibleNodesTexture.minFilter=THREE.NearestFilter,t.visibleNodesTexture.magFilter=THREE.NearestFilter;var n=function(e,t){return void 0!==e?e:t},i=n(e.size,1),r=n(e.minSize,2),o=n(e.maxSize,50),a=n(e.treeType,Pt.TreeType.OCTREE);return t._pointSizeType=Pt.PointSizeType.FIXED,t._shape=Pt.PointShape.SQUARE,t._pointColorType=Pt.PointColorType.RGB,t._useClipBox=!1,t.clipBoxes=[],t.numClipBoxes=0,t.clipPolygons=[],t._weighted=!1,t._gradient=Pt.Gradients.SPECTRAL,t.gradientTexture=Pt.PointCloudMaterial.generateGradientTexture(t._gradient),t.lights=!1,t.fog=!1,t._treeType=a,t._useEDL=!1,t._snapEnabled=!1,t._numSnapshots=0,t.defines=new Map,t._defaultIntensityRangeChanged=!1,t._defaultElevationRangeChanged=!1,t.attributes={position:{type:"fv",value:[]},color:{type:"fv",value:[]},normal:{type:"fv",value:[]},intensity:{type:"f",value:[]},classification:{type:"f",value:[]},returnNumber:{type:"f",value:[]},numberOfReturns:{type:"f",value:[]},pointSourceID:{type:"f",value:[]},indices:{type:"fv",value:[]}},t.uniforms={level:{type:"f",value:0},vnStart:{type:"f",value:0},spacing:{type:"f",value:1},blendHardness:{type:"f",value:2},blendDepthSupplement:{type:"f",value:0},fov:{type:"f",value:1},screenWidth:{type:"f",value:1},screenHeight:{type:"f",value:1},near:{type:"f",value:.1},far:{type:"f",value:1},uColor:{type:"c",value:new THREE.Color(16777215)},uOpacity:{type:"f",value:1},size:{type:"f",value:i},minSize:{type:"f",value:r},maxSize:{type:"f",value:o},octreeSize:{type:"f",value:0},bbSize:{type:"fv",value:[0,0,0]},elevationRange:{type:"2fv",value:[0,0]},clipBoxCount:{type:"f",value:0},clipPolygonCount:{type:"i",value:0},visibleNodes:{type:"t",value:t.visibleNodesTexture},pcIndex:{type:"f",value:0},gradient:{type:"t",value:t.gradientTexture},classificationLUT:{type:"t",value:t.classificationTexture},uHQDepthMap:{type:"t",value:null},clipBoxes:{type:"Matrix4fv",value:[]},clipPolygons:{type:"3fv",value:[]},clipPolygonVCount:{type:"iv",value:[]},clipPolygonVP:{type:"Matrix4fv",value:[]},toModel:{type:"Matrix4f",value:[]},diffuse:{type:"fv",value:[1,1,1]},transition:{type:"f",value:.5},intensityRange:{type:"fv",value:[0,65e3]},intensityGamma:{type:"f",value:1},intensityContrast:{type:"f",value:0},intensityBrightness:{type:"f",value:0},rgbGamma:{type:"f",value:1},rgbContrast:{type:"f",value:0},rgbBrightness:{type:"f",value:0},wRGB:{type:"f",value:1},wIntensity:{type:"f",value:0},wElevation:{type:"f",value:0},wClassification:{type:"f",value:0},wReturnNumber:{type:"f",value:0},wSourceID:{type:"f",value:0},useOrthographicCamera:{type:"b",value:!1},clipTask:{type:"i",value:1},clipMethod:{type:"i",value:1},uSnapshot:{type:"tv",value:[]},uSnapshotDepth:{type:"tv",value:[]},uSnapView:{type:"Matrix4fv",value:[]},uSnapProj:{type:"Matrix4fv",value:[]},uSnapProjInv:{type:"Matrix4fv",value:[]},uSnapViewInv:{type:"Matrix4fv",value:[]},uShadowColor:{type:"3fv",value:[0,0,0]}},t.classification=Pt.Classification.DEFAULT,t.defaultAttributeValues.normal=[0,0,0],t.defaultAttributeValues.classification=[0,0,0],t.defaultAttributeValues.indices=[0,0,0,0],t.vertexShader=t.getDefines()+Pt.Shaders["pointcloud.vs"],t.fragmentShader=t.getDefines()+Pt.Shaders["pointcloud.fs"],t.vertexColors=THREE.VertexColors,t}return _inherits(s,THREE.RawShaderMaterial),_createClass(s,[{key:"setDefine",value:function(e,t){null!=t?this.defines.get(e)!==t&&(this.defines.set(e,t),this.updateShaderSource()):this.removeDefine(e)}},{key:"removeDefine",value:function(e){this.defines.delete(e)}},{key:"updateShaderSource",value:function(){this.vertexShader=this.getDefines()+Pt.Shaders["pointcloud.vs"],this.fragmentShader=this.getDefines()+Pt.Shaders["pointcloud.fs"],1===this.opacity?(this.blending=THREE.NoBlending,this.transparent=!1,this.depthTest=!0,this.depthWrite=!0,this.depthFunc=THREE.LessEqualDepth):this.opacity<1&&!this.useEDL&&(this.blending=THREE.AdditiveBlending,this.transparent=!0,this.depthTest=!1,this.depthWrite=!0,this.depthFunc=THREE.AlwaysDepth),this.weighted&&(this.blending=THREE.AdditiveBlending,this.transparent=!0,this.depthTest=!0,this.depthWrite=!1),this.needsUpdate=!0}},{key:"getDefines",value:function(){var e=[];this.pointSizeType===Pt.PointSizeType.FIXED?e.push("#define fixed_point_size"):this.pointSizeType===Pt.PointSizeType.ATTENUATED?e.push("#define attenuated_point_size"):this.pointSizeType===Pt.PointSizeType.ADAPTIVE&&e.push("#define adaptive_point_size"),this.shape===Pt.PointShape.SQUARE?e.push("#define square_point_shape"):this.shape===Pt.PointShape.CIRCLE?e.push("#define circle_point_shape"):this.shape===Pt.PointShape.PARABOLOID&&e.push("#define paraboloid_point_shape"),this._useEDL&&e.push("#define use_edl"),this._snapEnabled&&e.push("#define snap_enabled"),this._pointColorType===Pt.PointColorType.RGB?e.push("#define color_type_rgb"):this._pointColorType===Pt.PointColorType.COLOR?e.push("#define color_type_color"):this._pointColorType===Pt.PointColorType.DEPTH?e.push("#define color_type_depth"):this._pointColorType===Pt.PointColorType.HEIGHT?e.push("#define color_type_height"):this._pointColorType===Pt.PointColorType.INTENSITY?e.push("#define color_type_intensity"):this._pointColorType===Pt.PointColorType.INTENSITY_GRADIENT?e.push("#define color_type_intensity_gradient"):this._pointColorType===Pt.PointColorType.LOD?e.push("#define color_type_lod"):this._pointColorType===Pt.PointColorType.POINT_INDEX?e.push("#define color_type_point_index"):this._pointColorType===Pt.PointColorType.CLASSIFICATION?e.push("#define color_type_classification"):this._pointColorType===Pt.PointColorType.RETURN_NUMBER?e.push("#define color_type_return_number"):this._pointColorType===Pt.PointColorType.SOURCE?e.push("#define color_type_source"):this._pointColorType===Pt.PointColorType.NORMAL?e.push("#define color_type_normal"):this._pointColorType===Pt.PointColorType.PHONG?e.push("#define color_type_phong"):this._pointColorType===Pt.PointColorType.RGB_HEIGHT?e.push("#define color_type_rgb_height"):this._pointColorType===Pt.PointColorType.COMPOSITE&&e.push("#define color_type_composite"),this._treeType===Pt.TreeType.OCTREE?e.push("#define tree_type_octree"):this._treeType===Pt.TreeType.KDTREE&&e.push("#define tree_type_kdtree"),this.weighted&&e.push("#define weighted_splats"),0<this.numClipBoxes&&e.push("#define use_clip_box"),0<this.clipPolygons.length&&e.push("#define use_clip_polygon");var t=!0,n=!1,i=void 0;try{for(var r,o=this.defines[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=_slicedToArray(r.value,2),s=(a[0],a[1]);e.push(s)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}return e.join("\n")}},{key:"setClipBoxes",value:function(e){if(e){this.clipBoxes=e;var t=this.numClipBoxes!==e.length&&(0===e.length||0===this.numClipBoxes);this.numClipBoxes=e.length,this.uniforms.clipBoxCount.value=this.numClipBoxes,t&&this.updateShaderSource(),this.uniforms.clipBoxes.value=new Float32Array(16*this.numClipBoxes);for(var n=0;n<this.numClipBoxes;n++){var i=e[n];this.uniforms.clipBoxes.value.set(i.inverse.elements,16*n)}for(var r=0;r<this.uniforms.clipBoxes.value.length;r++)Number.isNaN(this.uniforms.clipBoxes.value[r])&&(this.uniforms.clipBoxes.value[r]=1/0)}}},{key:"setClipPolygons",value:function(e,t){e&&(this.clipPolygons=e,this.clipPolygons.length!==e.length&&this.updateShaderSource())}},{key:"recomputeClassification",value:function(){this.classificationTexture=Pt.PointCloudMaterial.generateClassificationTexture(this._classification),this.uniforms.classificationLUT.value=this.classificationTexture,this.dispatchEvent({type:"material_property_changed",target:this})}},{key:"disableEvents",value:function(){void 0===this._hiddenListeners&&(this._hiddenListeners=this._listeners,this._listeners={})}},{key:"enableEvents",value:function(){this._listeners=this._hiddenListeners,this._hiddenListeners=void 0}},{key:"copyFrom",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=this.uniforms[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;this.uniforms[a].value=e.uniforms[a].value}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"gradient",get:function(){return this._gradient},set:function(e){this._gradient!==e&&(this._gradient=e,this.gradientTexture=Pt.PointCloudMaterial.generateGradientTexture(this._gradient),this.uniforms.gradient.value=this.gradientTexture)}},{key:"useOrthographicCamera",get:function(){return this.uniforms.useOrthographicCamera.value},set:function(e){this.uniforms.useOrthographicCamera.value!==e&&(this.uniforms.useOrthographicCamera.value=e)}},{key:"classification",get:function(){return this._classification},set:function(e){var t={},n=!0,i=!1,r=void 0;try{for(var o,a=Object.keys(e)[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;t[s]=e[s].clone()}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}var l=!1;if(void 0===this._classification)l=!1;else{l=Object.keys(t).length===Object.keys(this._classification).length;var u=!0,c=!1,h=void 0;try{for(var d,p=Object.keys(t)[Symbol.iterator]();!(u=(d=p.next()).done);u=!0){var v=d.value;l=(l=l&&void 0!==this._classification[v])&&t[v].equals(this._classification[v])}}catch(e){c=!0,h=e}finally{try{!u&&p.return&&p.return()}finally{if(c)throw h}}}l||(this._classification=t,this.recomputeClassification())}},{key:"numSnapshots",get:function(){return this._numSnapshots},set:function(e){this._numSnapshots=e}},{key:"snapEnabled",get:function(){return this._snapEnabled},set:function(e){this._snapEnabled!==e&&(this._snapEnabled=e,this.updateShaderSource())}},{key:"spacing",get:function(){return this.uniforms.spacing.value},set:function(e){this.uniforms.spacing.value!==e&&(this.uniforms.spacing.value=e)}},{key:"useClipBox",get:function(){return this._useClipBox},set:function(e){this._useClipBox!==e&&(this._useClipBox=e,this.updateShaderSource())}},{key:"clipTask",get:function(){return this.uniforms.clipTask.value},set:function(e){this.uniforms.clipTask.value=e}},{key:"clipMethod",get:function(){return this.uniforms.clipMethod.value},set:function(e){this.uniforms.clipMethod.value=e}},{key:"weighted",get:function(){return this._weighted},set:function(e){this._weighted!==e&&(this._weighted=e,this.updateShaderSource())}},{key:"fov",get:function(){return this.uniforms.fov.value},set:function(e){this.uniforms.fov.value!==e&&(this.uniforms.fov.value=e)}},{key:"screenWidth",get:function(){return this.uniforms.screenWidth.value},set:function(e){this.uniforms.screenWidth.value!==e&&(this.uniforms.screenWidth.value=e)}},{key:"screenHeight",get:function(){return this.uniforms.screenHeight.value},set:function(e){this.uniforms.screenHeight.value!==e&&(this.uniforms.screenHeight.value=e)}},{key:"near",get:function(){return this.uniforms.near.value},set:function(e){this.uniforms.near.value!==e&&(this.uniforms.near.value=e)}},{key:"far",get:function(){return this.uniforms.far.value},set:function(e){this.uniforms.far.value!==e&&(this.uniforms.far.value=e)}},{key:"opacity",get:function(){return this.uniforms.uOpacity.value},set:function(e){this.uniforms&&this.uniforms.uOpacity&&this.uniforms.uOpacity.value!==e&&(this.uniforms.uOpacity.value=e,this.updateShaderSource(),this.dispatchEvent({type:"opacity_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"pointColorType",get:function(){return this._pointColorType},set:function(e){this._pointColorType!==e&&(this._pointColorType=e,this.updateShaderSource(),this.dispatchEvent({type:"point_color_type_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"pointSizeType",get:function(){return this._pointSizeType},set:function(e){this._pointSizeType!==e&&(this._pointSizeType=e,this.updateShaderSource(),this.dispatchEvent({type:"point_size_type_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"useEDL",get:function(){return this._useEDL},set:function(e){this._useEDL!==e&&(this._useEDL=e,this.updateShaderSource())}},{key:"color",get:function(){return this.uniforms.uColor.value},set:function(e){this.uniforms.uColor.value.equals(e)||(this.uniforms.uColor.value.copy(e),this.dispatchEvent({type:"color_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"shape",get:function(){return this._shape},set:function(e){this._shape!==e&&(this._shape=e,this.updateShaderSource(),this.dispatchEvent({type:"point_shape_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"treeType",get:function(){return this._treeType},set:function(e){this._treeType!==e&&(this._treeType=e,this.updateShaderSource())}},{key:"bbSize",get:function(){return this.uniforms.bbSize.value},set:function(e){this.uniforms.bbSize.value=e}},{key:"size",get:function(){return this.uniforms.size.value},set:function(e){this.uniforms.size.value!==e&&(this.uniforms.size.value=e,this.dispatchEvent({type:"point_size_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"elevationRange",get:function(){return this.uniforms.elevationRange.value},set:function(e){(this.uniforms.elevationRange.value[0]!==e[0]||this.uniforms.elevationRange.value[1]!==e[1])&&(this.uniforms.elevationRange.value=e,this._defaultElevationRangeChanged=!0,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"heightMin",get:function(){return this.uniforms.elevationRange.value[0]},set:function(e){this.elevationRange=[e,this.elevationRange[1]]}},{key:"heightMax",get:function(){return this.uniforms.elevationRange.value[1]},set:function(e){this.elevationRange=[this.elevationRange[0],e]}},{key:"transition",get:function(){return this.uniforms.transition.value},set:function(e){this.uniforms.transition.value=e}},{key:"intensityRange",get:function(){return this.uniforms.intensityRange.value},set:function(e){e instanceof Array&&2===e.length&&(e[0]===this.uniforms.intensityRange.value[0]&&e[1]===this.uniforms.intensityRange.value[1]||(this.uniforms.intensityRange.value=e,this._defaultIntensityRangeChanged=!0,this.dispatchEvent({type:"material_property_changed",target:this})))}},{key:"intensityGamma",get:function(){return this.uniforms.intensityGamma.value},set:function(e){this.uniforms.intensityGamma.value!==e&&(this.uniforms.intensityGamma.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"intensityContrast",get:function(){return this.uniforms.intensityContrast.value},set:function(e){this.uniforms.intensityContrast.value!==e&&(this.uniforms.intensityContrast.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"intensityBrightness",get:function(){return this.uniforms.intensityBrightness.value},set:function(e){this.uniforms.intensityBrightness.value!==e&&(this.uniforms.intensityBrightness.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"rgbGamma",get:function(){return this.uniforms.rgbGamma.value},set:function(e){this.uniforms.rgbGamma.value!==e&&(this.uniforms.rgbGamma.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"rgbContrast",get:function(){return this.uniforms.rgbContrast.value},set:function(e){this.uniforms.rgbContrast.value!==e&&(this.uniforms.rgbContrast.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"rgbBrightness",get:function(){return this.uniforms.rgbBrightness.value},set:function(e){this.uniforms.rgbBrightness.value!==e&&(this.uniforms.rgbBrightness.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"weightRGB",get:function(){return this.uniforms.wRGB.value},set:function(e){this.uniforms.wRGB.value!==e&&(this.uniforms.wRGB.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"weightIntensity",get:function(){return this.uniforms.wIntensity.value},set:function(e){this.uniforms.wIntensity.value!==e&&(this.uniforms.wIntensity.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"weightElevation",get:function(){return this.uniforms.wElevation.value},set:function(e){this.uniforms.wElevation.value!==e&&(this.uniforms.wElevation.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"weightClassification",get:function(){return this.uniforms.wClassification.value},set:function(e){this.uniforms.wClassification.value!==e&&(this.uniforms.wClassification.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"weightReturnNumber",get:function(){return this.uniforms.wReturnNumber.value},set:function(e){this.uniforms.wReturnNumber.value!==e&&(this.uniforms.wReturnNumber.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}},{key:"weightSourceID",get:function(){return this.uniforms.wSourceID.value},set:function(e){this.uniforms.wSourceID.value!==e&&(this.uniforms.wSourceID.value=e,this.dispatchEvent({type:"material_property_changed",target:this}))}}],[{key:"generateGradientTexture",value:function(e){var t=document.createElement("canvas");t.width=64,t.height=64;var n=t.getContext("2d");n.rect(0,0,64,64);for(var i=n.createLinearGradient(0,0,64,64),r=0;r<e.length;r++){var o=e[r];i.addColorStop(o[0],"#"+o[1].getHexString())}n.fillStyle=i,n.fill();var a=new THREE.CanvasTexture(t);return a.needsUpdate=!0,a.minFilter=THREE.LinearFilter,a}},{key:"generateClassificationTexture",value:function(e){for(var t=new Uint8Array(262144),n=0;n<256;n++)for(var i=0;i<256;i++){var r=n+256*i,o=void 0;o=e[n]?e[n]:e[n%32]?e[n%32]:e.DEFAULT,t[4*r+0]=255*o.x,t[4*r+1]=255*o.y,t[4*r+2]=255*o.z,t[4*r+3]=255*o.w}var a=new THREE.DataTexture(t,256,256,THREE.RGBAFormat);return a.magFilter=THREE.NearestFilter,a.needsUpdate=!0,a}}]),s}(),Pt.EyeDomeLightingMaterial=function(e){function t(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setValues({uniforms:{screenWidth:{type:"f",value:0},screenHeight:{type:"f",value:0},edlStrength:{type:"f",value:1},radius:{type:"f",value:1},neighbours:{type:"2fv",value:[]},depthMap:{type:"t",value:null},uRegularColor:{type:"t",value:null},uRegularDepth:{type:"t",value:null},uEDLColor:{type:"t",value:null},uEDLDepth:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:e.getDefines()+Pt.Shaders["edl.vs"],fragmentShader:e.getDefines()+Pt.Shaders["edl.fs"],lights:!1}),e.neighbourCount=8,e}return _inherits(t,THREE.ShaderMaterial),_createClass(t,[{key:"getDefines",value:function(){var e="";return e+="#define NEIGHBOUR_COUNT "+this.neighbourCount+"\n"}},{key:"updateShaderSource",value:function(){var e=this.getDefines()+Pt.Shaders["edl.vs"],t=this.getDefines()+Pt.Shaders["edl.fs"];this.setValues({vertexShader:e,fragmentShader:t}),this.uniforms.neighbours.value=this.neighbours,this.needsUpdate=!0}},{key:"neighbourCount",get:function(){return this._neighbourCount},set:function(e){if(this._neighbourCount!==e){this._neighbourCount=e,this.neighbours=new Float32Array(2*this._neighbourCount);for(var t=0;t<this._neighbourCount;t++)this.neighbours[2*t+0]=Math.cos(2*t*Math.PI/this._neighbourCount),this.neighbours[2*t+1]=Math.sin(2*t*Math.PI/this._neighbourCount);this.updateShaderSource()}}}]),t}(),Pt.InputHandler=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t.viewer=e,t.renderer=e.renderer,t.domElement=t.renderer.domElement,t.enabled=!0,t.scene=null,t.interactiveScenes=[],t.interactiveObjects=new Set,t.inputListeners=[],t.blacklist=new Set,t.drag=null,t.mouse=new THREE.Vector2(0,0),t.selection=[],t.hoveredElements=[],t.pressedKeys={},t.wheelDelta=0,t.speed=1,t.logMessages=!1,-1===t.domElement.tabIndex&&(t.domElement.tabIndex=2222),t.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),t.domElement.addEventListener("click",t.onMouseClick.bind(t),!1),t.domElement.addEventListener("mousedown",t.onMouseDown.bind(t),!1),t.domElement.addEventListener("mouseup",t.onMouseUp.bind(t),!1),t.domElement.addEventListener("mousemove",t.onMouseMove.bind(t),!1),t.domElement.addEventListener("mousewheel",t.onMouseWheel.bind(t),!1),t.domElement.addEventListener("DOMMouseScroll",t.onMouseWheel.bind(t),!1),t.domElement.addEventListener("dblclick",t.onDoubleClick.bind(t)),t.domElement.addEventListener("keydown",t.onKeyDown.bind(t)),t.domElement.addEventListener("keyup",t.onKeyUp.bind(t)),t.domElement.addEventListener("touchstart",t.onTouchStart.bind(t)),t.domElement.addEventListener("touchend",t.onTouchEnd.bind(t)),t.domElement.addEventListener("touchmove",t.onTouchMove.bind(t)),t}return _inherits(n,THREE.EventDispatcher),_createClass(n,[{key:"addInputListener",value:function(e){this.inputListeners.push(e)}},{key:"removeInputListener",value:function(t){this.inputListeners=this.inputListeners.filter(function(e){return e!==t})}},{key:"getSortedListeners",value:function(){return this.inputListeners.sort(function(e,t){var n=void 0!==e.importance?e.importance:0;return(void 0!==t.importance?t.importance:0)-n})}},{key:"onTouchStart",value:function(e){if(this.logMessages&&console.log(this.constructor.name+": onTouchStart"),e.preventDefault(),1===e.touches.length){var t=this.domElement.getBoundingClientRect(),n=e.touches[0].pageX-t.left,i=e.touches[0].pageY-t.top;this.mouse.set(n,i),this.startDragging(null)}var r=!0,o=!1,a=void 0;try{for(var s,l=this.getSortedListeners()[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.dispatchEvent({type:e.type,touches:e.touches,changedTouches:e.changedTouches})}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}}},{key:"onTouchEnd",value:function(e){this.logMessages&&console.log(this.constructor.name+": onTouchEnd"),e.preventDefault();var t=!0,n=!1,i=void 0;try{for(var r,o=this.getSortedListeners()[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){r.value.dispatchEvent({type:"drop",drag:this.drag,viewer:this.viewer})}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}var a=!(this.drag=null),s=!1,l=void 0;try{for(var u,c=this.getSortedListeners()[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){u.value.dispatchEvent({type:e.type,touches:e.touches,changedTouches:e.changedTouches})}}catch(e){s=!0,l=e}finally{try{!a&&c.return&&c.return()}finally{if(s)throw l}}}},{key:"onTouchMove",value:function(e){if(this.logMessages&&console.log(this.constructor.name+": onTouchMove"),e.preventDefault(),1===e.touches.length){var t=this.domElement.getBoundingClientRect(),n=e.touches[0].pageX-t.left,i=e.touches[0].pageY-t.top;if(this.mouse.set(n,i),this.drag){this.drag.mouse=1,this.drag.lastDrag.x=n-this.drag.end.x,this.drag.lastDrag.y=i-this.drag.end.y,this.drag.end.set(n,i),this.logMessages&&console.log(this.constructor.name+": drag: ");var r=!0,o=!1,a=void 0;try{for(var s,l=this.getSortedListeners()[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.dispatchEvent({type:"drag",drag:this.drag,viewer:this.viewer})}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}}}var u=!0,c=!1,h=void 0;try{for(var d,p=this.getSortedListeners()[Symbol.iterator]();!(u=(d=p.next()).done);u=!0){d.value.dispatchEvent({type:e.type,touches:e.touches,changedTouches:e.changedTouches})}}catch(e){c=!0,h=e}finally{try{!u&&p.return&&p.return()}finally{if(c)throw h}}}},{key:"onKeyDown",value:function(e){this.logMessages&&console.log(this.constructor.name+": onKeyDown"),e.keyCode===Pt.KeyCodes.DELETE&&0<this.selection.length&&(this.dispatchEvent({type:"delete",selection:this.selection}),this.deselectAll()),this.dispatchEvent({type:"keydown",keyCode:e.keyCode,event:e}),this.pressedKeys[e.keyCode]=!0}},{key:"onKeyUp",value:function(e){this.logMessages&&console.log(this.constructor.name+": onKeyUp"),delete this.pressedKeys[e.keyCode],e.preventDefault()}},{key:"onDoubleClick",value:function(e){this.logMessages&&console.log(this.constructor.name+": onDoubleClick");var t=!1,n=!0,i=!1,r=void 0;try{for(var o,a=this.hoveredElements[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;if(s._listeners&&s._listeners.dblclick){s.object.dispatchEvent({type:"dblclick",mouse:this.mouse,object:s.object}),t=!0;break}}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}if(!t){var l=!0,u=!1,c=void 0;try{for(var h,d=this.getSortedListeners()[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){h.value.dispatchEvent({type:"dblclick",mouse:this.mouse,object:null})}}catch(e){u=!0,c=e}finally{try{!l&&d.return&&d.return()}finally{if(u)throw c}}}e.preventDefault()}},{key:"onMouseClick",value:function(e){this.logMessages&&console.log(this.constructor.name+": onMouseClick"),e.preventDefault()}},{key:"onMouseDown",value:function(e){this.logMessages&&console.log(this.constructor.name+": onMouseDown"),e.preventDefault();var t=!1,n=function(){return t=!0};if(0===this.hoveredElements.length){var i=!0,r=!1,o=void 0;try{for(var a,s=this.getSortedListeners()[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){a.value.dispatchEvent({type:"mousedown",viewer:this.viewer,mouse:this.mouse})}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}else{var l=!0,u=!1,c=void 0;try{for(var h,d=this.hoveredElements[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){if(h.value.object.dispatchEvent({type:"mousedown",viewer:this.viewer,consume:n}),t)break}}catch(e){u=!0,c=e}finally{try{!l&&d.return&&d.return()}finally{if(u)throw c}}}if(!this.drag){var p=this.hoveredElements.find(function(e){return e.object._listeners&&e.object._listeners.drag&&0<e.object._listeners.drag.length});p?this.startDragging(p.object,{location:p.point}):this.startDragging(null)}this.scene&&(this.viewStart=this.scene.view.clone())}},{key:"onMouseUp",value:function(e){var t=this;this.logMessages&&console.log(this.constructor.name+": onMouseUp"),e.preventDefault();var n=0===this.getNormalizedDrag().length(),i=!1,r=function(){return i=!0};if(0===this.hoveredElements.length){var o=!0,a=!1,s=void 0;try{for(var l,u=this.getSortedListeners()[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){if(l.value.dispatchEvent({type:"mouseup",viewer:this.viewer,mouse:this.mouse,consume:r}),i)break}}catch(e){a=!0,s=e}finally{try{!o&&u.return&&u.return()}finally{if(a)throw s}}}else{var c=this.hoveredElements.map(function(e){return e.object}).find(function(e){return e._listeners&&e._listeners.mouseup});c&&c.dispatchEvent({type:"mouseup",viewer:this.viewer,consume:r})}if(this.drag){if(this.drag.object)this.logMessages&&console.log(this.constructor.name+": drop "+this.drag.object.name),this.drag.object.dispatchEvent({type:"drop",drag:this.drag,viewer:this.viewer});else{var h=!0,d=!1,p=void 0;try{for(var v,f=this.getSortedListeners()[Symbol.iterator]();!(h=(v=f.next()).done);h=!0){v.value.dispatchEvent({type:"drop",drag:this.drag,viewer:this.viewer})}}catch(e){d=!0,p=e}finally{try{!h&&f.return&&f.return()}finally{if(d)throw p}}}void 0!==this.hoveredElements.map(function(e){return e.object}).find(function(e){return e===t.drag.object})&&(this.logMessages&&console.log(this.constructor.name+": click "+this.drag.object.name),this.drag.object.dispatchEvent({type:"click",viewer:this.viewer,consume:r})),this.drag=null}if(!i)if(e.button===THREE.MOUSE.LEFT){if(n){var m=this.hoveredElements.find(function(e){return e.object._listeners&&e.object._listeners.select});m?(m=m.object,this.isSelected(m)?this.selection.filter(function(e){return e!==m}).forEach(function(e){return t.toggleSelection(e)}):(this.deselectAll(),this.toggleSelection(m))):this.deselectAll()}}else e.button===THREE.MOUSE.RIGHT&&n&&this.deselectAll()}},{key:"onMouseMove",value:function(e){e.preventDefault();var t=this.domElement.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;this.mouse.set(n,i);var r=this.getHoveredElements();if(0<r.length){var o=r.map(function(e){return e.object.name}).join(", ");this.logMessages&&console.log(this.constructor.name+": onMouseMove; hovered: '"+o+"'")}if(this.drag)if(this.drag.mouse=e.buttons,this.drag.lastDrag.x=n-this.drag.end.x,this.drag.lastDrag.y=i-this.drag.end.y,this.drag.end.set(n,i),this.drag.object)this.logMessages&&console.log(this.constructor.name+": drag: "+this.drag.object.name),this.drag.object.dispatchEvent({type:"drag",drag:this.drag,viewer:this.viewer});else{this.logMessages&&console.log(this.constructor.name+": drag: ");var a=!1,s=!0,l=!1,u=void 0;try{for(var c,h=this.getSortedListeners()[Symbol.iterator]();!(s=(c=h.next()).done);s=!0){if(c.value.dispatchEvent({type:"drag",drag:this.drag,viewer:this.viewer,consume:function(){a=!0}}),a)break}}catch(e){l=!0,u=e}finally{try{!s&&h.return&&h.return()}finally{if(l)throw u}}}else{var d=r.map(function(e){return e.object}).find(function(e){return!0}),p=this.hoveredElements.map(function(e){return e.object}).find(function(e){return!0});if(d!==p&&(d&&(this.logMessages&&console.log(this.constructor.name+": mouseover: "+d.name),d.dispatchEvent({type:"mouseover",object:d})),p&&(this.logMessages&&console.log(this.constructor.name+": mouseleave: "+p.name),p.dispatchEvent({type:"mouseleave",object:p}))),0<r.length){var v=r.map(function(e){return e.object}).find(function(e){return e._listeners&&e._listeners.mousemove});v&&v.dispatchEvent({type:"mousemove",object:v})}}this.hoveredElements=r}},{key:"onMouseWheel",value:function(e){if(this.enabled){this.logMessages&&console.log(this.constructor.name+": onMouseWheel"),e.preventDefault();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail);var n=Math.sign(t);if(this.hoveredElement)this.hoveredElement.object.dispatchEvent({type:"mousewheel",delta:n,object:this.hoveredElement.object});else{var i=!0,r=!1,o=void 0;try{for(var a,s=this.getSortedListeners()[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){a.value.dispatchEvent({type:"mousewheel",delta:n,object:null})}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}}}},{key:"startDragging",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=e?e.name:"no name";if(this.logMessages&&console.log(this.constructor.name+": startDragging: '"+n+"'"),this.drag={start:this.mouse.clone(),end:this.mouse.clone(),lastDrag:new THREE.Vector2(0,0),startView:this.scene.view.clone(),object:e},t){var i=!0,r=!1,o=void 0;try{for(var a,s=Object.keys(t)[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value;this.drag[l]=t[l]}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}}}},{key:"getMousePointCloudIntersection",value:function(e){return Pt.utils.getMousePointCloudIntersection(this.mouse,this.scene.getActiveCamera(),this.viewer,this.scene.pointclouds)}},{key:"toggleSelection",value:function(e){var t=this.selection,n=this.selection.indexOf(e);-1===n?(this.selection.push(e),e.dispatchEvent({type:"select"})):(this.selection.splice(n,1),e.dispatchEvent({type:"deselect"})),this.dispatchEvent({type:"selection_changed",oldSelection:t,selection:this.selection})}},{key:"deselect",value:function(e){var t=this.selection,n=this.selection.indexOf(e);0<=n&&(this.selection.splice(n,1),e.dispatchEvent({type:"deselect"}),this.dispatchEvent({type:"selection_changed",oldSelection:t,selection:this.selection}))}},{key:"deselectAll",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,r=this.selection[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){i.value.dispatchEvent({type:"deselect"})}}catch(e){t=!0,n=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw n}}var o=this.selection;0<this.selection.length&&(this.selection=[],this.dispatchEvent({type:"selection_changed",oldSelection:o,selection:this.selection}))}},{key:"isSelected",value:function(e){return-1!==this.selection.indexOf(e)}},{key:"registerInteractiveObject",value:function(e){this.interactiveObjects.add(e)}},{key:"removeInteractiveObject",value:function(e){this.interactiveObjects.delete(e)}},{key:"registerInteractiveScene",value:function(e){-1===this.interactiveScenes.indexOf(e)&&this.interactiveScenes.push(e)}},{key:"unregisterInteractiveScene",value:function(e){var t=this.interactiveScenes.indexOf(e);-1<t&&this.interactiveScenes.splice(t,1)}},{key:"getHoveredElement",value:function(){var e=this.getHoveredElements();return 0<e.length?e[0]:null}},{key:"getHoveredElements",value:function(){var e=this,t=this.interactiveScenes.concat(this.scene.scene),n=["mouseup","mousemove","mouseover","mouseleave","drag","drop","click","select","deselect"],i=[],r=!0,o=!1,a=void 0;try{for(var s,l=t[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.traverseVisible(function(t){t._listeners&&t.visible&&!e.blacklist.has(t)&&(0<n.filter(function(e){return void 0!==t._listeners[e]}).length&&i.push(t))})}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}var u=this.scene.getActiveCamera(),c=Pt.utils.mouseToRay(this.mouse,u,this.domElement.clientWidth,this.domElement.clientHeight),h=new THREE.Raycaster;return h.ray.set(c.origin,c.direction),h.linePrecision=.2,h.intersectObjects(i.filter(function(e){return e.visible}),!1)}},{key:"setScene",value:function(e){this.deselectAll(),this.scene=e}},{key:"update",value:function(e){}},{key:"getNormalizedDrag",value:function(){if(!this.drag)return new THREE.Vector2(0,0);var e=(new THREE.Vector2).subVectors(this.drag.end,this.drag.start);return e.x=e.x/this.domElement.clientWidth,e.y=e.y/this.domElement.clientHeight,e}},{key:"getNormalizedLastDrag",value:function(){if(!this.drag)return new THREE.Vector2(0,0);var e=this.drag.lastDrag.clone();return e.x=e.x/this.domElement.clientWidth,e.y=e.y/this.domElement.clientHeight,e}}]),n}(),Pt.OrbitControls=function(e){function t(e){_classCallCheck(this,t);var E=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));E.viewer=e,E.renderer=e.renderer,E.scene=null,E.sceneControls=new THREE.Scene,E.rotationSpeed=5,E.fadeFactor=10,E.yawDelta=0,E.pitchDelta=0,E.panDelta=new THREE.Vector2(0,0),E.radiusDelta=0,E.tweens=[];var T=null;return E.addEventListener("touchstart",function(e){T=e}),E.addEventListener("touchend",function(e){T=e}),E.addEventListener("touchmove",function(e){if(2===e.touches.length&&2===T.touches.length){var t=T,n=e,i=t.touches[0].pageX-t.touches[1].pageX,r=t.touches[0].pageY-t.touches[1].pageY,o=Math.sqrt(i*i+r*r),a=n.touches[0].pageX-n.touches[1].pageX,s=n.touches[0].pageY-n.touches[1].pageY,l=Math.sqrt(a*a+s*s)/o,u=E.scene.view.radius+E.radiusDelta,c=u/l;E.radiusDelta=c-u,E.stopTweens()}else if(3===e.touches.length&&3===T.touches.length){var h=T,d=e,p=(h.touches[0].pageX+h.touches[1].pageX+h.touches[2].pageX)/3,v=(h.touches[0].pageY+h.touches[1].pageY+h.touches[2].pageY)/3,f=(d.touches[0].pageX+d.touches[1].pageX+d.touches[2].pageX)/3,m=(d.touches[0].pageY+d.touches[1].pageY+d.touches[2].pageY)/3,g=(f-p)/E.renderer.domElement.clientWidth,y=(m-v)/E.renderer.domElement.clientHeight;E.panDelta.x+=g,E.panDelta.y+=y,E.stopTweens()}T=e}),E.addEventListener("drag",function(e){if(null===e.drag.object){void 0===e.drag.startHandled&&(e.drag.startHandled=!0,E.dispatchEvent({type:"start"}));var t=e.drag.lastDrag.x/E.renderer.domElement.clientWidth,n=e.drag.lastDrag.y/E.renderer.domElement.clientHeight;e.drag.mouse===Pt.MOUSE.LEFT?(E.yawDelta+=t*E.rotationSpeed,E.pitchDelta+=n*E.rotationSpeed,E.stopTweens()):e.drag.mouse===Pt.MOUSE.RIGHT&&(E.panDelta.x+=t,E.panDelta.y+=n,E.stopTweens())}}),E.addEventListener("drop",function(e){E.dispatchEvent({type:"end"})}),E.addEventListener("mousewheel",function(e){var t=E.scene.view.radius+E.radiusDelta;E.radiusDelta+=-e.delta*t*.1,E.stopTweens()}),E.addEventListener("dblclick",function(e){E.zoomToLocation(e.mouse)}),E}return _inherits(t,THREE.EventDispatcher),_createClass(t,[{key:"setScene",value:function(e){this.scene=e}},{key:"stop",value:function(){this.yawDelta=0,this.pitchDelta=0,this.radiusDelta=0,this.panDelta.set(0,0)}},{key:"zoomToLocation",value:function(e){var t=this,n=this.scene.getActiveCamera(),i=Pt.utils.getMousePointCloudIntersection(e,n,this.viewer,this.scene.pointclouds,{pickClipped:!0});if(null!==i){var r=0,o=this.renderer.domElement,a=Pt.utils.mouseToRay(e,n,o.clientWidth,o.clientHeight),s=i.pointcloud.nodesOnRay(i.pointcloud.visibleNodes,a),l=s[s.length-1].getBoundingSphere().radius;r=Math.min(this.scene.view.radius,l),r=Math.max(.2,r);var u=this.scene.view.direction.multiplyScalar(-1),c=(new THREE.Vector3).addVectors(i.location,u.multiplyScalar(r)),h=TWEEN.Easing.Quartic.Out,d={x:0},p=new TWEEN.Tween(d).to({x:1},600);p.easing(h),this.tweens.push(p);var v=this.scene.view.position.clone(),f=c.clone(),m=this.scene.view.radius,g=c.distanceTo(i.location);p.onUpdate(function(){var e=d.x;t.scene.view.position.x=(1-e)*v.x+e*f.x,t.scene.view.position.y=(1-e)*v.y+e*f.y,t.scene.view.position.z=(1-e)*v.z+e*f.z,t.scene.view.radius=(1-e)*m+e*g,t.viewer.setMoveSpeed(t.scene.view.radius/2.5)}),p.onComplete(function(){t.tweens=t.tweens.filter(function(e){return e!==p})}),p.start()}}},{key:"stopTweens",value:function(){this.tweens.forEach(function(e){return e.stop()}),this.tweens=[]}},{key:"update",value:function(e){var t=this.scene.view,n=Math.min(1,this.fadeFactor*e),i=t.yaw,r=t.pitch,o=t.getPivot();i-=n*this.yawDelta,r-=n*this.pitchDelta,t.yaw=i,t.pitch=r;var a=this.scene.view.direction.multiplyScalar(-t.radius),s=(new THREE.Vector3).addVectors(o,a);t.position.copy(s);var l=Math.min(1,this.fadeFactor*e)*t.radius*3,u=-this.panDelta.x*l,c=this.panDelta.y*l;t.pan(u,c);var h=Math.min(1,this.fadeFactor*e),d=t.radius+h*this.radiusDelta,p=t.direction.multiplyScalar(-d),v=(new THREE.Vector3).addVectors(t.getPivot(),p);t.radius=d,t.position.copy(v);var f=t.radius/2.5;this.viewer.setMoveSpeed(f);var m=Math.min(1,this.fadeFactor*e),g=Math.max(0,1-this.fadeFactor*e);this.yawDelta*=g,this.pitchDelta*=g,this.panDelta.multiplyScalar(g),this.radiusDelta-=m*this.radiusDelta}}]),t}(),Pt.EarthControls=function(e){function i(e){_classCallCheck(this,i);var w=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));w.viewer=e,w.renderer=e.renderer,w.scene=null,w.sceneControls=new THREE.Scene,w.rotationSpeed=10,w.fadeFactor=20,w.wheelDelta=0,w.zoomDelta=new THREE.Vector3,w.camStart=null,w.tweens=[];var t=new THREE.SphereGeometry(.5,16,16),n=new THREE.MeshLambertMaterial({color:new THREE.Color(.86,.1,.1)});w.pivotIndicator=new THREE.Mesh(t,n),w.pivotIndicator.visible=!1,w.sceneControls.add(w.pivotIndicator);return w.addEventListener("drag",function(e){if(null===e.drag.object&&w.pivot){void 0===e.drag.startHandled&&(e.drag.startHandled=!0,w.dispatchEvent({type:"start"}));var t=w.camStart,n=w.viewer.scene.view,i=e.drag.end,r=w.viewer.renderer.domElement;if(e.drag.mouse===Pt.MOUSE.LEFT){var o=Pt.utils.mouseToRay(i,t,r.clientWidth,r.clientHeight),a=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),w.pivot),s=o.distanceToPlane(a);if(0<s){var l=(new THREE.Vector3).addVectors(t.position,o.direction.clone().multiplyScalar(s)),u=(new THREE.Vector3).subVectors(l,w.pivot),c=t.position.clone().sub(u);n.position.copy(c);var h=c.distanceTo(w.pivot);n.radius=h;var d=n.radius/2.5;w.viewer.setMoveSpeed(d)}}else if(e.drag.mouse===Pt.MOUSE.RIGHT){var p=e.drag.lastDrag.x/w.renderer.domElement.clientWidth,v=e.drag.lastDrag.y/w.renderer.domElement.clientHeight,f=-p*w.rotationSpeed*.5,m=-v*w.rotationSpeed*.2,g=n.pitch,y=n.clone();y.pitch=y.pitch+m,m=y.pitch-g;var E=(new THREE.Vector3).subVectors(n.position,w.pivot),T=(new THREE.Vector3).subVectors(n.getPivot(),w.pivot),P=n.getSide();E.applyAxisAngle(P,m),T.applyAxisAngle(P,m),E.applyAxisAngle(new THREE.Vector3(0,0,1),f),T.applyAxisAngle(new THREE.Vector3(0,0,1),f);var b=(new THREE.Vector3).addVectors(w.pivot,E);n.position.copy(b),n.yaw+=f,n.pitch+=m}}}),w.addEventListener("drop",function(e){w.dispatchEvent({type:"end"})}),w.addEventListener("mousewheel",function(e){w.wheelDelta+=e.delta}),w.addEventListener("mousedown",function(e){var t=Pt.utils.getMousePointCloudIntersection(e.mouse,w.scene.getActiveCamera(),w.viewer,w.scene.pointclouds,{pickClipped:!1});null===t&&(t=Pt.utils.getMouseObjectIntersection(e.mouse,w.scene.getActiveCamera(),w.viewer,w.scene.scene.children,{pickClipped:!1})),t&&(w.pivot=t.location,w.camStart=w.scene.getActiveCamera().clone(),w.pivotIndicator.visible=!0,w.pivotIndicator.position.copy(t.location))}),w.addEventListener("mouseup",function(e){w.camStart=null,w.pivot=null,w.pivotIndicator.visible=!1}),w.addEventListener("dblclick",function(e){w.zoomToLocation(e.mouse)}),w}return _inherits(i,THREE.EventDispatcher),_createClass(i,[{key:"setScene",value:function(e){this.scene=e}},{key:"stop",value:function(){this.wheelDelta=0,this.zoomDelta.set(0,0,0)}},{key:"zoomToLocation",value:function(e){var t=this,n=this.scene.getActiveCamera(),i=0,r=Pt.utils.getMousePointCloudIntersection(e,n,this.viewer,this.scene.pointclouds);if(null===r){if(null===(r=Pt.utils.getMouseObjectIntersection(e,n,this.viewer,this.scene.scene.children)))return;var o=this.renderer.domElement,a=(Pt.utils.mouseToRay(e,n,o.clientWidth,o.clientHeight),r.pointcloud.geometry.computeBoundingSphere().radius);i=Math.min(this.scene.view.radius,a),i=Math.max(.2,i)}var s=this.renderer.domElement,l=Pt.utils.mouseToRay(e,n,s.clientWidth,s.clientHeight),u=r.pointcloud.nodesOnRay(r.pointcloud.visibleNodes,l),c=u[u.length-1].getBoundingSphere().radius;i=Math.min(this.scene.view.radius,c),i=Math.max(.2,i);var h=this.scene.view.direction.multiplyScalar(-1),d=(new THREE.Vector3).addVectors(r.location,h.multiplyScalar(i)),p=TWEEN.Easing.Quartic.Out,v={x:0},f=new TWEEN.Tween(v).to({x:1},600);f.easing(p),this.tweens.push(f);var m=this.scene.view.position.clone(),g=d.clone(),y=this.scene.view.radius,E=d.distanceTo(r.location);f.onUpdate(function(){var e=v.x;t.scene.view.position.x=(1-e)*m.x+e*g.x,t.scene.view.position.y=(1-e)*m.y+e*g.y,t.scene.view.position.z=(1-e)*m.z+e*g.z,t.scene.view.radius=(1-e)*y+e*E,t.viewer.setMoveSpeed(t.scene.view.radius/2.5)}),f.onComplete(function(){t.tweens=t.tweens.filter(function(e){return e!==f})}),f.start()}},{key:"update",value:function(e){var t=this.scene.view,n=Math.pow(.5,this.fadeFactor*e),i=1-n,r=this.scene.getActiveCamera();if(0!==this.wheelDelta){var o=Pt.utils.getMousePointCloudIntersection(this.viewer.inputHandler.mouse,this.scene.getActiveCamera(),this.viewer,this.scene.pointclouds);if(null===o&&(o=Pt.utils.getMouseObjectIntersection(this.viewer.inputHandler.mouse,this.scene.getActiveCamera(),this.viewer,this.scene.scene.children)),o){var a=(new THREE.Vector3).addVectors(t.position,this.zoomDelta),s=.2*o.location.distanceTo(a)*this.wheelDelta,l=(new THREE.Vector3).subVectors(o.location,t.position);l.normalize(),a.add(l.multiplyScalar(s)),this.zoomDelta.subVectors(a,t.position);var u=a.distanceTo(o.location);t.radius=u;var c=t.radius/2.5;this.viewer.setMoveSpeed(c)}}if(0!==this.zoomDelta.length()){var h=this.zoomDelta.clone().multiplyScalar(i),d=(new THREE.Vector3).addVectors(t.position,h);t.position.copy(d)}if(this.pivotIndicator.visible){var p=this.pivotIndicator.position.distanceTo(t.position),v=this.renderer.domElement.clientwidth,f=this.renderer.domElement.clientHeight,m=10/Pt.utils.projectedRadius(1,r,p,v,f);this.pivotIndicator.scale.set(m,m,m)}this.zoomDelta.multiplyScalar(n),this.wheelDelta=0}}]),i}(),LRU.prototype.size=function(){return this.elements},LRU.prototype.contains=function(e){return null==this.items[e.id]},LRU.prototype.touch=function(e){if(e.loaded){var t=void 0;null==this.items[e.id]?((t=new LRUItem(e)).previous=this.last,null!==(this.last=t).previous&&(t.previous.next=t),this.items[e.id]=t,this.elements++,null===this.first&&(this.first=t),this.numPoints+=e.numPoints):null===(t=this.items[e.id]).previous?null!==t.next&&(this.first=t.next,this.first.previous=null,t.previous=this.last,t.next=null,(this.last=t).previous.next=t):null===t.next||(t.previous.next=t.next,t.next.previous=t.previous,t.previous=this.last,t.next=null,(this.last=t).previous.next=t)}},LRU.prototype.remove=function(e){var t=this.items[e.id];t&&(1===this.elements?(this.first=null,this.last=null):(t.previous||(this.first=t.next,this.first.previous=null),t.next||(this.last=t.previous,this.last.next=null),t.previous&&t.next&&(t.previous.next=t.next,t.next.previous=t.previous)),delete this.items[e.id],this.elements--,this.numPoints-=e.numPoints)},LRU.prototype.getLRUItem=function(){return null===this.first?null:this.first.node},LRU.prototype.toString=function(){for(var e="{ ",t=this.first;null!==t;)e+=t.node.id,null!==t.next&&(e+=", "),t=t.next;return e+="}",e+="("+this.size()+")"},LRU.prototype.freeMemory=function(){if(!(this.elements<=1))for(;this.numPoints>Pt.pointLoadLimit;){var e=this.first.node;this.disposeDescendants(e)}},LRU.prototype.disposeDescendants=function(e){var t=[];for(t.push(e);0<t.length;){var n=t.pop();for(var i in n.dispose(),this.remove(n),n.children){if(n.children.hasOwnProperty(i))n.children[i].loaded&&t.push(n.children[i])}}},Pt.Annotation=function(e){function v(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,v);var n=_possibleConstructorReturn(this,(v.__proto__||Object.getPrototypeOf(v)).call(this));n.scene=null,n._title=e.title||"No Title",n._description=e.description||"",e.position?e.position instanceof THREE.Vector3?n.position=e.position:n.position=new(Function.prototype.bind.apply(THREE.Vector3,[null].concat(_toConsumableArray(e.position)))):n.position=null,n.cameraPosition=e.cameraPosition instanceof Array?(new THREE.Vector3).fromArray(e.cameraPosition):e.cameraPosition,n.cameraTarget=e.cameraTarget instanceof Array?(new THREE.Vector3).fromArray(e.cameraTarget):e.cameraTarget,n.radius=e.radius,n.view=e.view||null,n.keepOpen=!1,n.descriptionVisible=!1,n.showDescription=!0,n.actions=e.actions||[],n.isHighlighted=!1,n._visible=!0,n.__visible=!0,n._display=!0,n._expand=!1,n.collapseThreshold=[e.collapseThreshold,100].find(function(e){return void 0!==e}),n.children=[],n.parent=null,n.boundingBox=new THREE.Box3,n.domElement=$("\n\t\t\t<div>\n\t\t\t</div>\n\t\t"),n.elTitlebar=n.domElement.find(".annotation-titlebar"),n.elTitle=n.elTitlebar.find(".annotation-label"),n.elTitle.append(n._title),n.elDescription=n.domElement.find(".annotation-description"),n.elDescriptionClose=n.elDescription.find(".annotation-description-close"),n.clickTitle=function(){n.hasView()&&n.moveHere(n.scene.getActiveCamera()),n.dispatchEvent({type:"click",target:n})},n.elTitle.click(n.clickTitle),n.actions=n.actions.map(function(e){return e instanceof Pt.Action?e:new Pt.Action(e)});var t=!0,i=!1,r=void 0;try{for(var o,a=n.actions[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){o.value.pairWith(n)}}catch(e){i=!0,r=e}finally{try{!t&&a.return&&a.return()}finally{if(i)throw r}}var s=n.actions.filter(function(e){return void 0===e.showIn||e.showIn.includes("scene")}),l=!0,u=!1,c=void 0;try{for(var h,d=function(){var e=h.value,t=$('<img src="'+e.icon+'" class="annotation-action-icon">');n.elTitlebar.append(t),t.click(function(){return e.onclick({annotation:n})})},p=s[Symbol.iterator]();!(l=(h=p.next()).done);l=!0)d()}catch(e){u=!0,c=e}finally{try{!l&&p.return&&p.return()}finally{if(u)throw c}}return n.elDescriptionClose.hover(function(e){return n.elDescriptionClose.css("opacity","1")},function(e){return n.elDescriptionClose.css("opacity","0.5")}),n.elDescriptionClose.click(function(e){return n.setHighlighted(!1)}),n.domElement.mouseenter(function(e){return n.setHighlighted(!0)}),n.domElement.mouseleave(function(e){return n.setHighlighted(!1)}),n.domElement.on("touchstart",function(e){n.setHighlighted(!n.isHighlighted)}),n.display=!1,n}return _inherits(v,THREE.EventDispatcher),_createClass(v,[{key:"add",value:function(e){if(!this.children.includes(e)){this.children.push(e),e.parent=this;var t=[];e.traverse(function(e){t.push(e)});var n=!0,i=!1,r=void 0;try{for(var o,a=t[Symbol.iterator]();!(n=(o=a.next()).done);n=!0)for(var s=o.value,l=this;null!==l;)l.dispatchEvent({type:"annotation_added",annotation:s}),l=l.parent}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}}}},{key:"level",value:function(){return null===this.parent?0:this.parent.level()+1}},{key:"hasChild",value:function(e){return this.children.includes(e)}},{key:"remove",value:function(t){this.hasChild(t)&&(t.removeAllChildren(),t.dispose(),this.children=this.children.filter(function(e){return e!==t}),t.parent=null)}},{key:"removeAllChildren",value:function(){var t=this;this.children.forEach(function(e){0<e.children.length&&e.removeAllChildren(),t.remove(e)})}},{key:"updateBounds",value:function(){var e=new THREE.Box3;this.position&&e.expandByPoint(this.position);var t=!0,n=!1,i=void 0;try{for(var r,o=this.children[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;a.updateBounds(),e.union(a.boundingBox)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}this.boundingBox.copy(e)}},{key:"traverse",value:function(e){var t=e(this);if(void 0===t||!0===t){var n=!0,i=!1,r=void 0;try{for(var o,a=this.children[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){o.value.traverse(e)}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}}}},{key:"traverseDescendants",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=this.children[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){r.value.traverse(e)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"flatten",value:function(){var t=[];return this.traverse(function(e){t.push(e)}),t}},{key:"descendants",value:function(){var t=this,n=[];return this.traverse(function(e){e!==t&&n.push(e)}),n}},{key:"setHighlighted",value:function(e){e?(this.domElement.css("opacity","0.8"),this.elTitlebar.css("box-shadow","0 0 5px #fff"),this.domElement.css("z-index","1000"),this._description&&(this.descriptionVisible=!0,this.elDescription.fadeIn(200),this.elDescription.css("position","relative"))):(this.domElement.css("opacity","0.5"),this.elTitlebar.css("box-shadow",""),this.domElement.css("z-index","100"),this.descriptionVisible=!1,this.elDescription.css("display","none")),this.isHighlighted=e}},{key:"hasView",value:function(){var e=this.cameraTarget instanceof THREE.Vector3;e=e&&this.cameraPosition instanceof THREE.Vector3;var t=void 0!==this.radius,n=e||t;return n}},{key:"moveHere",value:function(e){if(this.hasView()){var t=this.scene.view,n=TWEEN.Easing.Quartic.Out,i=void 0;if(i=this.cameraTarget?this.cameraTarget:this.position?this.position:this.boundingBox.getCenter(),this.cameraPosition){var r=this.cameraPosition;Pt.utils.moveTo(this.scene,r,i)}else if(this.radius){var o=t.direction,a=i.clone().add(o.multiplyScalar(-this.radius)),s=t.radius,l=this.radius,u=new TWEEN.Tween(t.position).to(a,500);u.easing(n),u.start();var c=new TWEEN.Tween({x:0}).to({x:1},500).onUpdate(function(){t.radius=this.x*l+(1-this.x)*s});c.easing(n),c.start()}}}},{key:"dispose",value:function(){this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement)}},{key:"toString",value:function(){return"Annotation: "+this._title}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible!==e&&(this._visible=e,this.dispatchEvent({type:"visibility_changed",annotation:this}))}},{key:"display",get:function(){return this._display},set:function(e){this._display!==e&&((this._display=e)?this.domElement.show():this.domElement.hide())}},{key:"expand",get:function(){return this._expand},set:function(e){this._expand!==e&&(e?this.display=!1:(this.display=!0,this.traverseDescendants(function(e){e.display=!1})),this._expand=e)}},{key:"title",get:function(){return this._title},set:function(e){this._title!==e&&(this._title=e,this.elTitle.empty(),this.elTitle.append(this._title))}},{key:"description",get:function(){return this._description},set:function(e){if(this._description!==e){this._description=e;var t=this.elDescription.find(".annotation-description-content");t.empty(),t.append(this._description)}}}]),v}(),Pt.Action=function(e){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t.icon=e.icon||"",t.tooltip=e.tooltip,void 0!==e.onclick&&(t.onclick=e.onclick),t}return _inherits(n,THREE.EventDispatcher),_createClass(n,[{key:"onclick",value:function(e){}},{key:"pairWith",value:function(e){}},{key:"setIcon",value:function(e){var t=this.icon;e!==t&&(this.icon=e,this.dispatchEvent({type:"icon_changed",action:this,icon:e,oldIcon:t}))}}]),n}(),Pt.Actions={},Pt.Actions.ToggleAnnotationVisibility=function(e){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.icon=Pt.resourcePath+"/icons/eye.svg",t.showIn="sidebar",t.tooltip="toggle visibility",t}return _inherits(n,Pt.Action),_createClass(n,[{key:"pairWith",value:function(e){var t=this;e.visible?this.setIcon(Pt.resourcePath+"/icons/eye.svg"):this.setIcon(Pt.resourcePath+"/icons/eye_crossed.svg"),e.addEventListener("visibility_changed",function(e){e.annotation.visible?t.setIcon(Pt.resourcePath+"/icons/eye.svg"):t.setIcon(Pt.resourcePath+"/icons/eye_crossed.svg")})}},{key:"onclick",value:function(e){var t=e.annotation;t.visible=!t.visible,t.visible?this.setIcon(Pt.resourcePath+"/icons/eye.svg"):this.setIcon(Pt.resourcePath+"/icons/eye_crossed.svg")}}]),n}(),Pt.PointCloudOctreeNode=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.children={},e.sceneNode=null,e.octree=null,e}return _inherits(t,Pt.PointCloudTreeNode),_createClass(t,[{key:"getNumPoints",value:function(){return this.geometryNode.numPoints}},{key:"isLoaded",value:function(){return!0}},{key:"isTreeNode",value:function(){return!0}},{key:"isGeometryNode",value:function(){return!1}},{key:"getLevel",value:function(){return this.geometryNode.level}},{key:"getBoundingSphere",value:function(){return this.geometryNode.boundingSphere}},{key:"getBoundingBox",value:function(){return this.geometryNode.boundingBox}},{key:"getChildren",value:function(){for(var e=[],t=0;t<8;t++)this.children[t]&&e.push(this.children[t]);return e}},{key:"getPointsInBox",value:function(e){if(!this.sceneNode)return null;for(var t=this.geometryNode.buffer,n=t.offset("position"),i=t.stride,r=new DataView(t.data),o=(new THREE.Matrix4).getInverse(e.matrixWorld),a=(new THREE.Matrix4).multiplyMatrices(o,this.sceneNode.matrixWorld),s=[],l=new THREE.Vector4,u=0;u<t.numElements;u++){var c=r.getFloat32(u*i+n+0,!0),h=r.getFloat32(u*i+n+4,!0),d=r.getFloat32(u*i+n+8,!0);l.set(c,h,d,1),l.applyMatrix4(a),-.5<l.x&&l.x<.5&&-.5<l.y&&l.y<.5&&-.5<l.z&&l.z<.5&&(l.set(c,h,d,1).applyMatrix4(this.sceneNode.matrixWorld),s.push(new THREE.Vector3(l.x,l.y,l.z)))}return s}},{key:"name",get:function(){return this.geometryNode.name}}]),t}(),Pt.PointCloudOctree=function(e){function a(e,t){_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));n.pointBudget=1/0,n.pcoGeometry=e,n.boundingBox=n.pcoGeometry.boundingBox,n.boundingSphere=n.boundingBox.getBoundingSphere(new THREE.Sphere),n.material=t||new Pt.PointCloudMaterial,n.visiblePointsTarget=2e6,n.minimumNodePixelSize=150,n.level=0,n.position.copy(e.offset),n.updateMatrix(),n.showBoundingBox=!1,n.boundingBoxNodes=[],n.loadQueue=[],n.visibleBounds=new THREE.Box3,n.visibleNodes=[],n.visibleGeometry=[],n.generateDEM=!1,n.profileRequests=[],n.name="";var i=[n.pcoGeometry.tightBoundingBox,n.getBoundingBoxWorld()].find(function(e){return void 0!==e});n.updateMatrixWorld(!0);var r=(i=Pt.utils.computeTransformedBoundingBox(i,n.matrixWorld)).min.z,o=i.max.z;return n.material.heightMin=r,n.material.heightMax=o,n.projection=e.projection,n.root=n.pcoGeometry.root,n}return _inherits(a,Pt.PointCloudTree),_createClass(a,[{key:"setName",value:function(e){this.name!==e&&(this.name=e,this.dispatchEvent({type:"name_changed",name:e,pointcloud:this}))}},{key:"getName",value:function(){return this.name}},{key:"toTreeNode",value:function(u,t){var c=this,h=new Pt.PointCloudOctreeNode,e=new THREE.Points(u.geometry,this.material);for(var n in e.name=u.name,e.position.copy(u.boundingBox.min),e.frustumCulled=!1,e.onBeforeRender=function(e,t,n,i,r,o){if(r.program){if(e.getContext().useProgram(r.program.program),r.program.getUniforms().map.level){var a=u.getLevel();r.uniforms.level.value=a,r.program.getUniforms().map.level.setValue(e.getContext(),a)}if(c.visibleNodeTextureOffsets&&r.program.getUniforms().map.vnStart){var s=c.visibleNodeTextureOffsets.get(h);r.uniforms.vnStart.value=s,r.program.getUniforms().map.vnStart.setValue(e.getContext(),s)}if(r.program.getUniforms().map.pcIndex){var l=h.pcIndex?h.pcIndex:c.visibleNodes.indexOf(h);r.uniforms.pcIndex.value=l,r.program.getUniforms().map.pcIndex.setValue(e.getContext(),l)}}},h.geometryNode=u,h.sceneNode=e,h.pointcloud=this,h.children={},u.children)h.children[n]=u.children[n];if(t){var i=parseInt(u.name[u.name.length-1]);t.sceneNode.add(e),t.children[i]=h}else this.root=h,this.add(e);return u.oneTimeDisposeHandlers.push(function(){var e=parseInt(u.name[u.name.length-1]);t.sceneNode.remove(h.sceneNode),t.children[e]=u}),h}},{key:"updateVisibleBounds",value:function(){for(var e=[],t=0;t<this.visibleNodes.length;t++){for(var n=this.visibleNodes[t],i=!0,r=0;r<n.children.length;r++){var o=n.children[r];o instanceof Pt.PointCloudOctreeNode?i=i&&!o.sceneNode.visible:o instanceof Pt.PointCloudOctreeGeometryNode&&(i=!0)}i&&e.push(n)}this.visibleBounds.min=new THREE.Vector3(1/0,1/0,1/0),this.visibleBounds.max=new THREE.Vector3(-1/0,-1/0,-1/0);for(var a=0;a<e.length;a++){var s=e[a];this.visibleBounds.expandByPoint(s.getBoundingBox().min),this.visibleBounds.expandByPoint(s.getBoundingBox().max)}}},{key:"updateMaterial",value:function(e,t,n,i){e.fov=n.fov*(Math.PI/180),e.screenWidth=i.domElement.clientWidth,e.screenHeight=i.domElement.clientHeight,e.spacing=this.pcoGeometry.spacing*Math.max(this.scale.x,this.scale.y,this.scale.z),e.near=n.near,e.far=n.far,e.uniforms.octreeSize.value=this.pcoGeometry.boundingBox.getSize(new THREE.Vector3).x}},{key:"computeVisibilityTextureData",value:function(e,t){Pt.measureTimings&&performance.mark("computeVisibilityTextureData-start");var n=new Uint8Array(4*e.length),i=new Map;(e=e.slice()).sort(function(e,t){var n=e.geometryNode.name,i=t.geometryNode.name;return n.length!==i.length?n.length-i.length:n<i?-1:i<n?1:0});for(var a=new THREE.Vector3,r=function(e,t){a.subVectors(t.center,e.origin);var n=a.dot(e.direction),i=a.dot(a)-n*n,r=t.radius*t.radius;if(r<i)return null;var o=n+Math.sqrt(r-i);return o<0?null:o},o=new Map,s=new Map,l=0;l<e.length;l++){var u=e[l];i.set(u,l);for(var c=[],h=0;h<8;h++){var d=u.children[h];d&&d.constructor===Pt.PointCloudOctreeNode&&e.includes(d,l)&&c.push(d)}u.geometryNode.estimatedSpacing;n[4*l+0]=0,n[4*l+1]=0,n[4*l+2]=0,n[4*l+3]=u.getLevel();for(var p=0;p<c.length;p++){var v=c[p],f=parseInt(v.geometryNode.name.substr(-1));if(n[4*l+0]+=Math.pow(2,f),0===p){var m=e.indexOf(v,l);n[4*l+1]=m-l>>8,n[4*l+2]=(m-l)%256}}var g=u.getBoundingBox().clone().getBoundingSphere(new THREE.Sphere);g.applyMatrix4(u.sceneNode.matrixWorld),g.applyMatrix4(t.matrixWorldInverse);var y=r(new THREE.Ray(t.position,t.getWorldDirection(new THREE.Vector3)),g),E=g.center.distanceTo(t.position)+g.radius;if(null===y&&(y=E),y=Math.max(y,E),o.has(u.getLevel())){var T=o.get(u.getLevel()),P=Math.max(T,y);o.set(u.getLevel(),P)}else o.set(u.getLevel(),y);if(!u.geometryNode.hasChildren){var b={distance:y,i:l};s.set(u,b)}}var w=!0,x=!1,_=void 0;try{for(var R,C=s[Symbol.iterator]();!(w=(R=C.next()).done);w=!0){var S=_slicedToArray(R.value,2),A=S[0],H=S[1],k=A.getLevel(),L=H.distance,M=H.i;if(!(k<4)){var D=!0,B=!1,N=void 0;try{for(var I,O=o[Symbol.iterator]();!(D=(I=O.next()).done);D=!0){var V=_slicedToArray(I.value,2),z=V[0];L<1.2*V[1]&&(n[4*M+3]=z)}}catch(e){B=!0,N=e}finally{try{!D&&O.return&&O.return()}finally{if(B)throw N}}}}}catch(e){x=!0,_=e}finally{try{!w&&C.return&&C.return()}finally{if(x)throw _}}return Pt.measureTimings&&(performance.mark("computeVisibilityTextureData-end"),performance.measure("render.computeVisibilityTextureData","computeVisibilityTextureData-start","computeVisibilityTextureData-end")),{data:n,offsets:i}}},{key:"nodeIntersectsProfile",value:function(e,t){for(var n=e.boundingBox.clone().applyMatrix4(this.matrixWorld).getBoundingSphere(),i=!1,r=0;r<t.points.length-1;r++){var o=new THREE.Vector3(t.points[r+0].x,t.points[r+0].y,n.center.z),a=new THREE.Vector3(t.points[r+1].x,t.points[r+1].y,n.center.z),s=new THREE.Line3(o,a).closestPointToPoint(n.center,!0).distanceTo(n.center);i=i||s<n.radius+t.width}return i}},{key:"nodesOnRay",value:function(e,t){for(var n=[],i=t.clone(),r=0;r<e.length;r++){var o=e[r],a=o.getBoundingSphere().clone().applyMatrix4(this.matrixWorld);i.intersectsSphere(a)&&n.push(o)}return n}},{key:"updateMatrixWorld",value:function(e){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==e||(this.parent?this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),e=!(this.matrixWorldNeedsUpdate=!1))}},{key:"hideDescendants",value:function(e){for(var t=[],n=0;n<e.children.length;n++){var i=e.children[n];i.visible&&t.push(i)}for(;0<t.length;){var r=t.shift();r.visible=!1;for(var o=0;o<r.children.length;o++){var a=r.children[o];a.visible&&t.push(a)}}}},{key:"moveToOrigin",value:function(){this.position.set(0,0,0),this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,n=Pt.utils.computeTransformedBoundingBox(e,t);this.position.set(0,0,0).sub(n.getCenter())}},{key:"moveToGroundPlane",value:function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,n=Pt.utils.computeTransformedBoundingBox(e,t);this.position.y+=-n.min.y}},{key:"getBoundingBoxWorld",value:function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld;return Pt.utils.computeTransformedBoundingBox(e,t)}},{key:"getPointsInProfile",value:function(e,t,n){if(n){var i=new Pt.ProfileRequest(this,e,t,n);return this.profileRequests.push(i),i}for(var r={segments:[],boundingBox:new THREE.Box3,projectedBoundingBox:new THREE.Box2},o=0;o<e.points.length-1;o++){var a=e.points[o],s=e.points[o+1],l=this.getProfile(a,s,e.width,t),u={start:a,end:s,points:l,project:null};r.segments.push(u),r.boundingBox.expandByPoint(l.boundingBox.min),r.boundingBox.expandByPoint(l.boundingBox.max)}for(var c=new THREE.Vector3,h=0;h<r.segments.length;h++){var d=r.segments[h],p=d.start,v=d.end,f=function(e,t,n,i){var o=e,r=t,a=n,s=i,l=new THREE.Vector3(1,0,0),u=(new THREE.Vector3).subVectors(r,o);u.y=0,u.normalize();var c=Math.acos(l.dot(u));return 0<u.z&&(c=-c),function(e){var t=(new THREE.Matrix4).makeTranslation(-o.x,-s.min.y,-o.z),n=(new THREE.Matrix4).makeRotationY(-c),i=(new THREE.Matrix4).makeTranslation(a.x,0,0),r=e.clone();return r.applyMatrix4(t),r.applyMatrix4(n),r.applyMatrix4(i),r}}(p,v,c.clone(),r.boundingBox.clone());d.project=f,c.x+=new THREE.Vector3(p.x,0,p.z).distanceTo(new THREE.Vector3(v.x,0,v.z)),c.y+=v.y-p.y}return r.projectedBoundingBox.min.x=0,r.projectedBoundingBox.min.y=r.boundingBox.min.y,r.projectedBoundingBox.max.x=c.x,r.projectedBoundingBox.max.y=r.boundingBox.max.y,r}},{key:"getProfile",value:function(e,t,n,i,r){var o=new Pt.ProfileRequest(e,t,n,i,r);this.profileRequests.push(o)}},{key:"getVisibleExtent",value:function(){return this.visibleBounds.applyMatrix4(this.matrixWorld)}},{key:"pick",value:function(e,t,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},r=e.renderer,o=e.pRenderer;performance.mark("pick-start");var a=function(e,t){return void 0!==e?e:t},s=a(i.pickWindowSize,17),l=(a(i.pickOutsideClipRegion,!1),r.getSize(new THREE.Vector3)),u=Math.ceil(a(i.width,l.width)),c=Math.ceil(a(i.height,l.height)),h=a(i.pointSizeType,this.material.pointSizeType),d=a(i.pointSize,this.material.size),p=this.nodesOnRay(this.visibleNodes,n);if(0===p.length)return null;if(!this.pickState){var v=new THREE.Scene,f=new Pt.PointCloudMaterial;f.pointColorType=Pt.PointColorType.POINT_INDEX;var m=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});this.pickState={renderTarget:m,material:f,scene:v}}var g=this.pickState,y=g.material;y.pointSizeType=h,y.shape=this.material.shape,y.size=d,y.uniforms.minSize.value=this.material.uniforms.minSize.value,y.uniforms.maxSize.value=this.material.uniforms.maxSize.value,y.classification=this.material.classification,i.pickClipped?(y.clipBoxes=this.material.clipBoxes,this.material.clipTask===Pt.ClipTask.HIGHLIGHT?y.clipTask=Pt.ClipTask.NONE:y.clipTask=this.material.clipTask):y.clipBoxes=[],this.updateMaterial(y,p,t,r),g.renderTarget.setSize(u,c);var E=new THREE.Vector2(i.x,i.y),T=r.getContext();T.enable(T.SCISSOR_TEST),T.scissor(parseInt(E.x-(s-1)/2),parseInt(E.y-(s-1)/2),parseInt(s),parseInt(s)),r.state.buffers.depth.setTest(y.depthTest),r.state.buffers.depth.setMask(y.depthWrite),r.state.setBlending(THREE.NoBlending),r.setRenderTarget(g.renderTarget),T.clearColor(0,0,0,0),r.clearTarget(g.renderTarget,!0,!0,!0);var P=this.material;this.material=y,o.renderOctree(this,p,t,g.renderTarget),this.material=P;var b=function(e,t,n){return Math.min(Math.max(t,e),n)},w=parseInt(b(E.x-(s-1)/2,0,u)),x=parseInt(b(E.y-(s-1)/2,0,c)),_=parseInt(Math.min(w+s,u)-w),R=parseInt(Math.min(x+s,c)-x),C=new Uint8Array(4*(_*R));T.readPixels(w,x,s,s,T.RGBA,T.UNSIGNED_BYTE,C),r.setRenderTarget(null),r.state.reset(),r.setScissorTest(!1),T.disable(T.SCISSOR_TEST);for(var S=C,A=new Uint32Array(C.buffer),H=(Number.MAX_VALUE,[]),k=0;k<s;k++)for(var L=0;L<s;L++){var M=k+L*s,D=Math.pow(k-(s-1)/2,2)+Math.pow(L-(s-1)/2,2),B=S[4*M+3];S[4*M+3]=0;var N=A[M];if((0!==B||0!==N)&&void 0!==B&&void 0!==N){var I={pIndex:N,pcIndex:B,distanceToCenter:D};i.all?H.push(I):0<H.length?D<H[0].distanceToCenter&&(H[0]=I):H.push(I)}}var O=!0,V=!1,z=void 0;try{for(var U,F=H[Symbol.iterator]();!(O=(U=F.next()).done);O=!0){var G=U.value,j={};if(!p[G.pcIndex])return null;var W=p[G.pcIndex],X=W.sceneNode,Y=W.geometryNode.geometry;for(var q in Y.attributes){var Q=Y.attributes[q];if("position"===q){var K=Q.array[3*G.pIndex+0],$=Q.array[3*G.pIndex+1],Z=Q.array[3*G.pIndex+2],J=new THREE.Vector3(K,$,Z);J.applyMatrix4(X.matrixWorld),j[q]=J}}G.point=j}}catch(e){V=!0,z=e}finally{try{!O&&F.return&&F.return()}finally{if(V)throw z}}return performance.mark("pick-end"),performance.measure("pick","pick-start","pick-end"),i.all?H.map(function(e){return e.point}):0===H.length?null:H[0].point}},{key:"getFittedBoxGen",value:regeneratorRuntime.mark(function e(t){var n,i,r,o,a,s,l,u,c,h,d,p,v,f,m,g,y,E,T,P,b,w,x;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=performance.now(),i=new THREE.Box3,r=(new THREE.Matrix4).getInverse(t.matrixWorld),a=!(o=!0),s=void 0,e.prev=6,l=this.visibleNodes[Symbol.iterator]();case 8:if(o=(u=l.next()).done){e.next=24;break}if((c=u.value).sceneNode){e.next=12;break}return e.abrupt("continue",21);case 12:for(h=c.geometryNode.buffer,d=h.offset("position"),p=h.stride,v=new DataView(h.data),f=(new THREE.Matrix4).multiplyMatrices(r,c.sceneNode.matrixWorld),m=new THREE.Vector4,g=0;g<h.numElements;g++)y=v.getFloat32(g*p+d+0,!0),E=v.getFloat32(g*p+d+4,!0),T=v.getFloat32(g*p+d+8,!0),m.set(y,E,T,1),m.applyMatrix4(f),-.5<m.x&&m.x<.5&&-.5<m.y&&m.y<.5&&-.5<m.z&&m.z<.5&&i.expandByPoint(m);return void(e.next=21);case 21:o=!0,e.next=8;break;case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(6),a=!0,s=e.t0;case 30:e.prev=30,e.prev=31,!o&&l.return&&l.return();case 33:if(e.prev=33,a)throw s;e.next=36;break;case 36:return e.finish(33);case 37:return e.finish(30);case 38:return P=i.getCenter().applyMatrix4(t.matrixWorld),(b=new THREE.Object3D).position.copy(P),b.scale.copy(t.scale),b.rotation.copy(t.rotation),w=(new THREE.Vector3).subVectors(i.max,i.min),b.scale.multiply(w),x=performance.now()-n,console.log("duration: ",x),e.next=49,b;case 49:case"end":return e.stop()}},e,this,[[6,26,30,38],[31,,33,37]])})},{key:"getFittedBox",value:function(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1];var t=performance.now(),n=new THREE.Box3,i=(new THREE.Matrix4).getInverse(e.matrixWorld),r=!0,o=!1,a=void 0;try{for(var s,l=this.visibleNodes[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value;if(u.sceneNode&&!(u.getLevel()>1/0))for(var c=u.geometryNode.buffer,h=c.offset("position"),d=c.stride,p=new DataView(c.data),v=(new THREE.Matrix4).multiplyMatrices(i,u.sceneNode.matrixWorld),f=new THREE.Vector4,m=0;m<c.numElements;m++){var g=p.getFloat32(m*d+h+0,!0),y=p.getFloat32(m*d+h+4,!0),E=p.getFloat32(m*d+h+8,!0);f.set(g,y,E,1),f.applyMatrix4(v),-.5<f.x&&f.x<.5&&-.5<f.y&&f.y<.5&&-.5<f.z&&f.z<.5&&n.expandByPoint(f)}}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}var T=n.getCenter().applyMatrix4(e.matrixWorld),P=new THREE.Object3D;P.position.copy(T),P.scale.copy(e.scale),P.rotation.copy(e.rotation);var b=(new THREE.Vector3).subVectors(n.max,n.min);P.scale.multiply(b);var w=performance.now()-t;return console.log("duration: ",w),P}},{key:"progress",get:function(){return this.visibleNodes.length/this.visibleGeometry.length}}]),a}(),Pt.PointCloudOctreeGeometry=function e(){_classCallCheck(this,e),this.url=null,this.octreeDir=null,this.spacing=0,this.boundingBox=null,this.root=null,this.nodes=null,this.pointAttributes=null,this.hierarchyStepSize=-1,this.loader=null},Pt.PointCloudOctreeGeometryNode=function(e){function r(e,t,n){_classCallCheck(this,r);var i=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return i.id=Pt.PointCloudOctreeGeometryNode.IDCount++,i.name=e,i.index=parseInt(e.charAt(e.length-1)),i.pcoGeometry=t,i.geometry=null,i.boundingBox=n,i.boundingSphere=n.getBoundingSphere(new THREE.Sphere),i.children={},i.numPoints=0,i.level=null,i.loaded=!1,i.oneTimeDisposeHandlers=[],i}return _inherits(r,Pt.PointCloudTreeNode),_createClass(r,[{key:"isGeometryNode",value:function(){return!0}},{key:"getLevel",value:function(){return this.level}},{key:"isTreeNode",value:function(){return!1}},{key:"isLoaded",value:function(){return this.loaded}},{key:"getBoundingSphere",value:function(){return this.boundingSphere}},{key:"getBoundingBox",value:function(){return this.boundingBox}},{key:"getChildren",value:function(){for(var e=[],t=0;t<8;t++)this.children[t]&&e.push(this.children[t]);return e}},{key:"getBoundingBox",value:function(){return this.boundingBox}},{key:"getURL",value:function(){var e="",t=this.pcoGeometry.loader.version;return t.equalOrHigher("1.5")?e=this.pcoGeometry.octreeDir+"/"+this.getHierarchyPath()+"/"+this.name:t.equalOrHigher("1.4")?e=this.pcoGeometry.octreeDir+"/"+this.name:t.upTo("1.3")&&(e=this.pcoGeometry.octreeDir+"/"+this.name),e}},{key:"getHierarchyPath",value:function(){for(var e="r/",t=this.pcoGeometry.hierarchyStepSize,n=this.name.substr(1),i=Math.floor(n.length/t),r=0;r<i;r++)e+=n.substr(r*t,t)+"/";return e=e.slice(0,-1)}},{key:"addChild",value:function(e){(this.children[e.index]=e).parent=this}},{key:"load",value:function(){!0===this.loading||!0===this.loaded||Pt.numNodesLoading>=Pt.maxNodesLoading||(this.loading=!0,Pt.numNodesLoading++,this.pcoGeometry.loader.version.equalOrHigher("1.5")&&this.level%this.pcoGeometry.hierarchyStepSize==0&&this.hasChildren?this.loadHierachyThenPoints():this.loadPoints())}},{key:"loadPoints",value:function(){this.pcoGeometry.loader.load(this)}},{key:"loadHierachyThenPoints",value:function(){var t=this;if(t.level%t.pcoGeometry.hierarchyStepSize==0){var n=t.pcoGeometry.octreeDir+"/"+t.getHierarchyPath()+"/"+t.name+".hrc",i=Pt.XHRFactory.createXMLHttpRequest();i.open("GET",n,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){var e=i.response;!function(e,t){var n=new DataView(t),i=[],r=n.getUint8(0),o=n.getUint32(1,!0);e.numPoints=o,i.push({children:r,numPoints:o,name:e.name});for(var a=[],s=5;0<i.length;){for(var l=i.shift(),u=1,c=0;c<8;c++){if(0!=(l.children&u)){var h=l.name+c,d=n.getUint8(s),p=n.getUint32(s+1,!0);i.push({children:d,numPoints:p,name:h}),a.push({children:d,numPoints:p,name:h}),s+=5}u*=2}if(s===t.byteLength)break}for(var v={},f=(v[e.name]=e).pcoGeometry,m=0;m<a.length;m++){var g=a[m].name,y=a[m].numPoints,E=parseInt(g.charAt(g.length-1)),T=v[g.substring(0,g.length-1)],P=g.length-1,b=Pt.POCLoader.createChildAABB(T.boundingBox,E),w=new Pt.PointCloudOctreeGeometryNode(g,f,b);w.level=P,w.numPoints=y,w.hasChildren=0<a[m].children,w.spacing=f.spacing/Math.pow(2,P),T.addChild(w),v[g]=w}e.loadPoints()}(t,e)}else console.log("Failed to load file! HTTP status: "+i.status+", file: "+n),Pt.numNodesLoading--};try{i.send(null)}catch(e){console.log("fehler beim laden der punktwolke: "+e)}}}},{key:"getNumPoints",value:function(){return this.numPoints}},{key:"dispose",value:function(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var e=0;e<this.oneTimeDisposeHandlers.length;e++){(0,this.oneTimeDisposeHandlers[e])()}this.oneTimeDisposeHandlers=[]}}}]),r}(),Pt.PointCloudOctreeGeometryNode.IDCount=0,Object.assign(Pt.PointCloudOctreeGeometryNode.prototype,THREE.EventDispatcher.prototype),Pt.utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"loadShapefileFeatures",value:function(e,i){var r=[];shapefile.open(e).then(function(n){n.read().then(function e(t){if(!t.done)return t.value&&"Feature"===t.value.type&&void 0!==t.value.geometry&&r.push(t.value),n.read().then(e);i(r)})})}},{key:"toString",value:function(e){return e instanceof THREE.Vector3?e.x.toFixed(2)+", "+e.y.toFixed(2)+", "+e.z.toFixed(2):""+e}},{key:"normalizeURL",value:function(e){var t=new URL(e);return t.protocol+"//"+t.hostname+t.pathname.replace(/\/+/g,"/")}},{key:"pathExists",value:function(e){var t=Pt.XHRFactory.createXMLHttpRequest();return t.open("GET",e,!1),t.send(null),200===t.status}},{key:"debugSphere",value:function(e,t,n,i){var r=new THREE.SphereGeometry(1,8,8),o=void 0;o=void 0!==i?new THREE.MeshBasicMaterial({color:i}):new THREE.MeshNormalMaterial;var a=new THREE.Mesh(r,o);a.position.copy(t),a.scale.set(n,n,n),e.add(a)}},{key:"debugLine",value:function(e,t,n,i){var r=new THREE.LineBasicMaterial({color:i}),o=new THREE.Geometry;o.vertices.push(t,n);var a=new THREE.Line(o,r);e.add(a)}},{key:"computeTransformedBoundingBox",value:function(e,t){var n=[new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.max.z).applyMatrix4(t)],i=new THREE.Box3;return i.setFromPoints(n),i}},{key:"addCommas",value:function(e){for(var t=(e+="").split("."),n=t[0],i=1<t.length?"."+t[1]:"",r=/(\d+)(\d{3})/;r.test(n);)n=n.replace(r,"$1,$2");return n+i}},{key:"removeCommas",value:function(e){return e.replace(/,/g,"")}},{key:"createWorker",value:function(e){var t=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(t))}},{key:"moveTo",value:function(e,t,n){var i=e.view,r=e.getActiveCamera(),o=TWEEN.Easing.Quartic.Out,a=new TWEEN.Tween(i.position).to(t,500);a.easing(o),a.start();var s=r.position.distanceTo(n),l=(new THREE.Vector3).addVectors(r.position,r.getWorldDirection(new THREE.Vector3).clone().multiplyScalar(s)),u=new TWEEN.Tween(l).to(n,500);u.easing(o),u.onUpdate(function(){i.lookAt(l)}),u.onComplete(function(){i.lookAt(l)}),u.start()}},{key:"loadSkybox",value:function(e){var t=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e5);t.up.set(0,0,1);for(var n=new THREE.Scene,i=".jpg",r=[e+"px"+i,e+"nx"+i,e+"py"+i,e+"ny"+i,e+"pz"+i,e+"nz"+i],o=[],a=function(e){var t=new THREE.MeshBasicMaterial({map:null,side:THREE.BackSide,depthTest:!1,depthWrite:!1,color:4343126});o.push(t),(new THREE.TextureLoader).load(r[e],function(e){t.map=e,t.needsUpdate=!0,t.color.setHex(16777215)},function(e){},function(e){console.log("An error happened",e)})},s=0;s<6;s++)a(s);var l=new THREE.CubeGeometry(5e3,5e3,5e3),u=new THREE.Mesh(l,o);return n.add(u),n.rotation.x=Math.PI/2,{camera:t,scene:n}}},{key:"createGrid",value:function(e,t,n,i){for(var r=new THREE.LineBasicMaterial({color:i||8947848}),o=new THREE.Geometry,a=0;a<=t;a++)o.vertices.push(new THREE.Vector3(-n*e/2,a*n-n*t/2,0)),o.vertices.push(new THREE.Vector3(+n*e/2,a*n-n*t/2,0));for(var s=0;s<=e;s++)o.vertices.push(new THREE.Vector3(s*n-n*e/2,-n*t/2,0)),o.vertices.push(new THREE.Vector3(s*n-n*e/2,+n*t/2,0));var l=new THREE.LineSegments(o,r,THREE.LinePieces);return l.receiveShadow=!0,l}},{key:"createBackgroundTexture",value:function(e,t){function n(e,t){return 1/(2*Math.PI)*Math.exp(-(e*e+t*t)/2)}for(var i=new Uint8Array(3*(e*t)),r=[1,1.5,1.7],o=n(0,0),a=0;a<e;a++)for(var s=0;s<t;s++){var l=a+e*s,u=n(2*(a/e*2-1),2*(s/t*2-1))/o,c=(Math.random()+Math.random()+Math.random())/3;c=(.5*u+.5)*c*.03,c*=.4,i[3*l+0]=255*(u/15+.05+c)*r[0],i[3*l+1]=255*(u/15+.05+c)*r[1],i[3*l+2]=255*(u/15+.05+c)*r[2]}var h=new THREE.DataTexture(i,e,t,THREE.RGBFormat);return h.needsUpdate=!0,h}},{key:"createSkyBackgroundTexture",value:function(e,t){var n=document.createElement("canvas");n.width=e,n.height=t;var i=n.getContext("2d"),r=i.createLinearGradient(0,0,0,t);r.addColorStop(0,"#98c8f6"),r.addColorStop(.4,"#cbebff"),r.addColorStop(1,"#f0f9ff"),i.fillStyle=r,i.fillRect(0,0,e,t);var o=new Image;o.onload=function(){i.drawImage(o,0,0,e,t)};var a=new THREE.CanvasTexture(n);return a.needsUpdate=!0,a}},{key:"getMousePointCloudIntersection",value:function(e,t,n,i){var r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{},o=n.renderer,a={x:e.x/o.domElement.clientWidth*2-1,y:-e.y/o.domElement.clientHeight*2+1},s={};r.pickClipped&&(s.pickClipped=r.pickClipped),s.x=e.x,s.y=o.domElement.clientHeight-e.y;var l=new THREE.Raycaster;l.setFromCamera(a,t);var u=l.ray,c=null,h=1/0,d=null,p=null,v=!0,f=!1,m=void 0;try{for(var g,y=i[Symbol.iterator]();!(v=(g=y.next()).done);v=!0){var E=g.value,T=E.pick(n,t,u,s);if(T){var P=t.position.distanceTo(T.position);P<h&&(h=P,c=E,d=T.position,p=T)}}}catch(e){f=!0,m=e}finally{try{!v&&y.return&&y.return()}finally{if(f)throw m}}return c?{location:d,distance:h,pointcloud:c,point:p}:null}},{key:"getMouseObjectIntersection",value:function(e,t,n,i){var r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{},o=n.renderer,a={x:e.x/o.domElement.clientWidth*2-1,y:-e.y/o.domElement.clientHeight*2+1},s={};r.pickClipped&&(s.pickClipped=r.pickClipped),s.x=e.x,s.y=o.domElement.clientHeight-e.y;var l=new THREE.Raycaster;l.setFromCamera(a,t);l.ray.clone();for(var u=[],c=1/0,h=null,d=null,p=null,v=0;v<i.length;v++){var f=i[v],m=[];if("DirectionalLight"!=f.type){if(!((m=l.intersectObjects(f.children,!0))&&0<m.length))continue;u.push(m[0])}}if(0==u.length)return null;for(var g=0,y=u.length;g<y;g++){var E=u[g].point,T=u[g].distance;T<c&&(c=T,p=E,h=u[g].object,d=E)}return h?{location:d,distance:c,pointcloud:h,point:p}:null}},{key:"pixelsArrayToImage",value:function(e,t,n){var i=document.createElement("canvas");i.width=t,i.height=n;var r=i.getContext("2d");e=new e.constructor(e);for(var o=0;o<e.length;o++)e[4*o+3]=255;var a=r.createImageData(t,n);a.data.set(e),r.putImageData(a,0,0);var s=new Image;return s.src=i.toDataURL(),s}},{key:"pixelsArrayToDataUrl",value:function(e,t,n){var i=document.createElement("canvas");i.width=t,i.height=n;var r=i.getContext("2d");e=new e.constructor(e);for(var o=0;o<e.length;o++)e[4*o+3]=255;var a=r.createImageData(t,n);return a.data.set(e),r.putImageData(a,0,0),i.toDataURL()}},{key:"pixelsArrayToCanvas",value:function(e,t,n){var i=document.createElement("canvas");i.width=t,i.height=n;var r=i.getContext("2d");e=new e.constructor(e);for(var o=4*t,a=0;a<parseInt(n/2);a++){var s=n-a-1,l=e.slice(a*o,a*o+o),u=e.slice(s*o,s*o+o);e.set(u,a*o),e.set(l,s*o)}var c=r.createImageData(t,n);return c.data.set(e),r.putImageData(c,0,0),i}},{key:"removeListeners",value:function(e,t){void 0!==e._listeners&&e._listeners[t]&&delete e._listeners[t]}},{key:"mouseToRay",value:function(e,t,n,i){var r={x:e.x/n*2-1,y:-e.y/i*2+1},o=new THREE.Vector3(r.x,r.y,.5),a=new THREE.Vector3(r.x,r.y,0);o.unproject(t),a.unproject(t);var s=(new THREE.Vector3).subVectors(o,a).normalize();return new THREE.Ray(a,s)}},{key:"projectedRadius",value:function(e,t,n,i,r){if(t instanceof THREE.OrthographicCamera)return Pt.utils.projectedRadiusOrtho(e,t.projectionMatrix,i,r);if(t instanceof THREE.PerspectiveCamera)return Pt.utils.projectedRadiusPerspective(e,t.fov*Math.PI/180,n,r);throw new Error("invalid parameters")}},{key:"projectedRadiusPerspective",value:function(e,t,n,i){var r=1/Math.tan(t/2)/n;return e*(r=r*i/2)}},{key:"projectedRadiusOrtho",value:function(e,t,n,i){var r=new THREE.Vector4(0),o=new THREE.Vector4(e);return r.applyMatrix4(t),o.applyMatrix4(t),r=new THREE.Vector3(r.x,r.y,r.z),o=new THREE.Vector3(o.x,o.y,o.z),r.x=.5*(r.x+1)*n,r.y=.5*(r.y+1)*i,o.x=.5*(o.x+1)*n,o.y=.5*(o.y+1)*i,r.distanceTo(o)}},{key:"topView",value:function(e,t){e.position.set(0,1,0),e.rotation.set(-Math.PI/2,0,0),e.zoomTo(t,1)}},{key:"frontView",value:function(e,t){e.position.set(0,0,1),e.rotation.set(0,0,0),e.zoomTo(t,1)}},{key:"leftView",value:function(e,t){e.position.set(-1,0,0),e.rotation.set(0,-Math.PI/2,0),e.zoomTo(t,1)}},{key:"rightView",value:function(e,t){e.position.set(1,0,0),e.rotation.set(0,Math.PI/2,0),e.zoomTo(t,1)}},{key:"frustumSphereIntersection",value:function(e,t){for(var n=e.planes,i=t.center,r=-t.radius,o=Number.MAX_VALUE,a=0;a<6;a++){var s=n[a].distanceToPoint(i);if(s<r)return 0;o=Math.min(o,s)}return o>=t.radius?2:1}},{key:"generateDataTexture",value:function(e,t,n){for(var i=e*t,r=new Uint8Array(4*e*t),o=Math.floor(255*n.r),a=Math.floor(255*n.g),s=Math.floor(255*n.b),l=0;l<i;l++)r[3*l]=o,r[3*l+1]=a,r[3*l+2]=s;var u=new THREE.DataTexture(r,e,t,THREE.RGBAFormat);return u.needsUpdate=!0,u.magFilter=THREE.NearestFilter,u}},{key:"getParameterByName",value:function(e){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(document.location.search);return null===t?null:decodeURIComponent(t[1].replace(/\+/g," "))}},{key:"setParameter",value:function(e,t){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("([\\?&])("+e+"=([^&#]*))").exec(document.location.search),i=window.location.href;if(null===n)0===window.location.search.length?i+="?":i+="&",i=i+e+"="+t;else{var r=e+"="+t;i=i.replace(n[2],r)}window.history.replaceState({},"",i)}},{key:"clipboardCopy",value:function(e){var t=document.createElement("textarea");t.style.position="fixed",t.style.top=0,t.style.left=0,t.style.width="2em",t.style.height="2em",t.style.padding=0,t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.select();try{document.execCommand("copy")?console.log("copied text to clipboard"):console.log("copy to clipboard failed")}catch(e){console.log("error while trying to copy to clipboard")}document.body.removeChild(t)}}]),e}(),Pt.utils.screenPass=new function(){this.screenScene=new THREE.Scene,this.screenQuad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2,0)),this.screenQuad.material.depthTest=!0,this.screenQuad.material.depthWrite=!0,this.screenQuad.material.transparent=!0,this.screenScene.add(this.screenQuad),this.camera=new THREE.Camera,this.render=function(e,t,n){this.screenQuad.material=t,void 0===n?e.render(this.screenScene,this.camera):e.render(this.screenScene,this.camera,n)}},Pt.Features=function(){var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(null===t)return null;var n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),o=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=0<n.precision&&0<r.precision,s=0<i.precision&&0<o.precision;return{SHADER_INTERPOLATION:{isSupported:function(){var e=!0;return e=(e=e&&t.getExtension("EXT_frag_depth"))&&8<=t.getParameter(t.MAX_VARYING_VECTORS)}},SHADER_SPLATS:{isSupported:function(){var e=!0;return e=(e=(e=e&&t.getExtension("EXT_frag_depth"))&&t.getExtension("OES_texture_float"))&&8<=t.getParameter(t.MAX_VARYING_VECTORS)}},SHADER_EDL:{isSupported:function(){var e=!0;return e=(e=e&&t.getExtension("OES_texture_float"))&&8<=t.getParameter(t.MAX_VARYING_VECTORS)}},precision:a?"highp":s?"mediump":"lowp"}}(),Pt.TextSprite=function(e){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this)),n=new THREE.Texture;n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter;var i=new THREE.SpriteMaterial({map:n,depthTest:!1,depthWrite:!1});return t.material=i,t.sprite=new THREE.Sprite(i),t.add(t.sprite),t.borderThickness=4,t.fontface="Arial",t.fontsize=28,t.borderColor={r:0,g:0,b:0,a:1},t.backgroundColor={r:255,g:255,b:255,a:1},t.textColor={r:255,g:255,b:255,a:1},t.text="",t.setText(e),t}return _inherits(r,THREE.Object3D),_createClass(r,[{key:"setText",value:function(e){this.text!==e&&(this.text=e,this.update())}},{key:"setTextColor",value:function(e){this.textColor=e,this.update()}},{key:"setBorderColor",value:function(e){this.borderColor=e,this.update()}},{key:"setBackgroundColor",value:function(e){this.backgroundColor=e,this.update()}},{key:"update",value:function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.font="Bold "+this.fontsize+"px "+this.fontface;var n=t.measureText(this.text).width,i=10+n+2*this.borderThickness,r=1.4*this.fontsize+2*this.borderThickness;t.canvas.width=i,t.canvas.height=r,t.font="Bold "+this.fontsize+"px "+this.fontface,t.fillStyle="rgba("+this.backgroundColor.r+","+this.backgroundColor.g+","+this.backgroundColor.b+","+this.backgroundColor.a+")",t.strokeStyle="rgba("+this.borderColor.r+","+this.borderColor.g+","+this.borderColor.b+","+this.borderColor.a+")",t.lineWidth=this.borderThickness,this.roundRect(t,this.borderThickness/2,this.borderThickness/2,n+this.borderThickness+10,1.4*this.fontsize+this.borderThickness,6),t.strokeStyle="rgba(0, 0, 0, 1.0)",t.strokeText(this.text,this.borderThickness+5,this.fontsize+this.borderThickness),t.fillStyle="rgba("+this.textColor.r+","+this.textColor.g+","+this.textColor.b+","+this.textColor.a+")",t.fillText(this.text,this.borderThickness+5,this.fontsize+this.borderThickness);var o=new THREE.Texture(e);o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.needsUpdate=!0,this.sprite.material.map=o,this.sprite.scale.set(.01*i,.01*r,1)}},{key:"roundRect",value:function(e,t,n,i,r,o){e.beginPath(),e.moveTo(t+o,n),e.lineTo(t+i-o,n),e.quadraticCurveTo(t+i,n,t+i,n+o),e.lineTo(t+i,n+r-o),e.quadraticCurveTo(t+i,n+r,t+i-o,n+r),e.lineTo(t+o,n+r),e.quadraticCurveTo(t,n+r,t,n+r-o),e.lineTo(t,n+o),e.quadraticCurveTo(t,n,t+o,n),e.closePath(),e.fill(),e.stroke()}}]),r}(),Pt.PathAnimation=function(){function o(e,t,n,i,r){_classCallCheck(this,o),this.path=e,this.length=this.path.spline.getLength(),this.speed=i,this.callback=r,this.tween=null,this.startPoint=Math.max(t,0),this.endPoint=Math.min(n,this.length),this.t=0}return _createClass(o,[{key:"start",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.tween&&(this.tween.stop(),this.tween=null);var n=void 0;n=e?this.t:this.startPoint/this.length;var i=this.endPoint/this.length,r=(i-n)*this.length*1e3/this.speed,o={t:n};this.tween=new TWEEN.Tween(o).to({t:i},r),this.tween.easing(TWEEN.Easing.Linear.None),this.tween.onUpdate(function(e){t.t=o.t,t.callback(o.t)}),this.tween.onComplete(function(){t.repeat&&t.start()}),setTimeout(function(){t.tween.start()},0)}},{key:"stop",value:function(){this.tween&&(this.tween.stop(),this.tween=null,this.t=0)}},{key:"pause",value:function(){this.tween&&(this.tween.stop(),TWEEN.remove(this.tween),this.tween=null)}},{key:"resume",value:function(){this.start(!0)}},{key:"getPoint",value:function(e){return this.path.spline.getPoint(e)}}]),o}(),Pt.AnimationPath=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];_classCallCheck(this,t),this.points=e,this.spline=new THREE.CatmullRomCurve3(e)}return _createClass(t,[{key:"get",value:function(e){return this.spline.getPoint(e)}},{key:"getLength",value:function(){return this.spline.getLength()}},{key:"animate",value:function(e,t,n,i){var r=new Pt.PathAnimation(this,e,t,n,i);return r.start(),r}},{key:"pause",value:function(){this.tween&&this.tween.stop()}},{key:"resume",value:function(){this.tween&&this.tween.start()}},{key:"getGeometry",value:function(){for(var e=new THREE.Geometry,t=0,n=0;n<=1;n+=.002){var i=this.spline.getPoint(n);e.vertices[t]=new THREE.Vector3(i.x,i.y,i.z),t++}if(this.closed){var r=this.spline.getPoint(0);e.vertices[t]=new THREE.Vector3(r.x,r.y,r.z)}return e}},{key:"closed",get:function(){return this.spline.closed},set:function(e){this.spline.closed=e}}]),t}(),Pt.Version=function(e){var t=-1===(this.version=e).indexOf(".")?e.length:e.indexOf(".");this.versionMajor=parseInt(e.substr(0,t)),this.versionMinor=parseInt(e.substr(t+1)),0===this.versionMinor.length&&(this.versionMinor=0)},Pt.Version.prototype.newerThan=function(e){var t=new Pt.Version(e);return this.versionMajor>t.versionMajor||this.versionMajor===t.versionMajor&&this.versionMinor>t.versionMinor},Pt.Version.prototype.equalOrHigher=function(e){var t=new Pt.Version(e);return this.versionMajor>t.versionMajor||this.versionMajor===t.versionMajor&&this.versionMinor>=t.versionMinor},Pt.Version.prototype.upTo=function(e){return!this.newerThan(e)},Pt.Measure=function(e){function i(){_classCallCheck(this,i);var e=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));e.constructor.counter=void 0===e.constructor.counter?0:e.constructor.counter+1,e.name="Measure_"+e.constructor.counter,e.points=[],e._showDistances=!0,e._showCoordinates=!1,e._showArea=!1,e._closed=!0,e._showAngles=!1,e._showHeight=!1,e.maxMarkers=Number.MAX_SAFE_INTEGER,e.sphereGeometry=new THREE.SphereGeometry(.4,10,10),e.color=new THREE.Color(16711680),e.lengthUnit={code:"m"},e.spheres=[],e.edges=[],e.sphereLabels=[],e.edgeLabels=[],e.angleLabels=[],e.coordinateLabels=[];var t=new THREE.Geometry;t.vertices.push(new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3),t.colors.push(e.color,e.color,e.color);var n=new THREE.LineDashedMaterial({color:16711680,dashSize:5,gapSize:2});return n.depthTest=!1,e.heightEdge=new THREE.Line(t,n),e.heightEdge.visible=!1,e.add(e.heightEdge),e.heightLabel=new Pt.TextSprite(""),e.heightLabel.setBorderColor({r:0,g:0,b:0,a:.8}),e.heightLabel.setBackgroundColor({r:0,g:0,b:0,a:.3}),e.heightLabel.setTextColor({r:180,g:220,b:180,a:1}),e.heightLabel.material.depthTest=!1,e.heightLabel.material.opacity=1,e.heightLabel.visible=!1,e.add(e.heightLabel),e.areaLabel=new Pt.TextSprite(""),e.areaLabel.setBorderColor({r:0,g:0,b:0,a:.8}),e.areaLabel.setBackgroundColor({r:0,g:0,b:0,a:.3}),e.areaLabel.setTextColor({r:180,g:220,b:180,a:1}),e.areaLabel.material.depthTest=!1,e.areaLabel.material.opacity=1,e.areaLabel.visible=!1,e.add(e.areaLabel),e}return _inherits(i,THREE.Object3D),_createClass(i,[{key:"createSphereMaterial",value:function(){return new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:this.color,depthTest:!1,depthWrite:!1})}},{key:"addMarker",value:function(e){var c=this;e instanceof THREE.Vector3?e={position:e}:e instanceof Array&&(e={position:new(Function.prototype.bind.apply(THREE.Vector3,[null].concat(_toConsumableArray(e))))}),this.points.push(e);var t=new THREE.Mesh(this.sphereGeometry,this.createSphereMaterial());this.add(t),this.spheres.push(t);var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3,new THREE.Vector3),n.colors.push(this.color,this.color,this.color);var i=new THREE.LineBasicMaterial({linewidth:1});i.depthTest=!1;var r=new THREE.Line(n,i);r.visible=!0,this.add(r),this.edges.push(r);var o=new Pt.TextSprite;o.setBorderColor({r:0,g:0,b:0,a:.8}),o.setBackgroundColor({r:0,g:0,b:0,a:.3}),o.material.depthTest=!1,o.visible=!1,this.edgeLabels.push(o),this.add(o);var a=new Pt.TextSprite;a.setBorderColor({r:0,g:0,b:0,a:.8}),a.setBackgroundColor({r:0,g:0,b:0,a:.3}),a.material.depthTest=!1,a.material.opacity=1,a.visible=!1,this.angleLabels.push(a),this.add(a);var s=new Pt.TextSprite;s.setBorderColor({r:0,g:0,b:0,a:.8}),s.setBackgroundColor({r:0,g:0,b:0,a:.3}),s.material.depthTest=!1,s.material.opacity=1,s.visible=!1,this.coordinateLabels.push(s),this.add(s);t.addEventListener("drag",function(e){var t=Pt.utils.getMousePointCloudIntersection(e.drag.end,e.viewer.scene.getActiveCamera(),e.viewer,e.viewer.scene.pointclouds,{pickClipped:!0});if(t){var n=c.spheres.indexOf(e.drag.object);if(-1!==n){var i=c.points[n],r=!0,o=!1,a=void 0;try{for(var s,l=Object.keys(t.point).filter(function(e){return"position"!==e})[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value;i[u]=t.point[u]}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}c.setPosition(n,t.location)}}}),t.addEventListener("drop",function(e){var t=c.spheres.indexOf(e.drag.object);-1!==t&&c.dispatchEvent({type:"marker_dropped",measurement:c,index:t})}),t.addEventListener("mouseover",function(e){return e.object.material.emissive.setHex(8947848)}),t.addEventListener("mouseleave",function(e){return e.object.material.emissive.setHex(0)});var l={type:"marker_added",measurement:this,sphere:t};this.dispatchEvent(l),this.setMarker(this.points.length-1,e)}},{key:"removeMarker",value:function(e){this.points.splice(e,1),this.remove(this.spheres[e]);var t=0===e?0:e-1;this.remove(this.edges[t]),this.edges.splice(t,1),this.remove(this.edgeLabels[t]),this.edgeLabels.splice(t,1),this.coordinateLabels.splice(e,1),this.spheres.splice(e,1),this.update(),this.dispatchEvent({type:"marker_removed",measurement:this})}},{key:"setMarker",value:function(e,t){this.points[e]=t;var n={type:"marker_moved",measure:this,index:e,position:t.position.clone()};this.dispatchEvent(n),this.update()}},{key:"setPosition",value:function(e,t){this.points[e].position.copy(t);var n={type:"marker_moved",measure:this,index:e,position:t.clone()};this.dispatchEvent(n),this.update()}},{key:"getArea",value:function(){for(var e=0,t=this.points.length-1,n=0;n<this.points.length;n++){var i=this.points[n].position,r=this.points[t].position;e+=(r.x+i.x)*(i.y-r.y),t=n}return Math.abs(e/2)}},{key:"getTotalDistance",value:function(){if(0===this.points.length)return 0;for(var e=0,t=1;t<this.points.length;t++){var n=this.points[t-1].position,i=this.points[t].position;e+=n.distanceTo(i)}if(this.closed&&1<this.points.length){var r=this.points[0].position;e+=this.points[this.points.length-1].position.distanceTo(r)}return e}},{key:"getAngleBetweenLines",value:function(e,t,n){var i=(new THREE.Vector3).subVectors(t.position,e.position),r=(new THREE.Vector3).subVectors(n.position,e.position);return i.angleTo(r)}},{key:"getAngle",value:function(e){if(this.points.length<3||e>=this.points.length)return 0;var t=0===e?this.points[this.points.length-1]:this.points[e-1],n=this.points[e],i=this.points[(e+1)%this.points.length];return this.getAngleBetweenLines(n,t,i)}},{key:"update",value:function(){if(0!==this.points.length){if(1===this.points.length){var e=this.points[0].position;this.spheres[0].position.copy(e);var t=this.coordinateLabels[0],n=e.toArray().map(function(e){return Pt.utils.addCommas(e.toFixed(2))}).join(", ");return t.setText(n),void(t.visible=this.showCoordinates)}for(var i=this.points.length-1,r=new THREE.Vector3,o=0;o<=i;o++){var a=this.points[o];r.add(a.position)}r.divideScalar(this.points.length);for(var s=0;s<=i;s++){var l=s,u=i<s+1?0:s+1,c=0===s?i:s-1,h=this.points[l],d=this.points[u],p=this.points[c],v=this.spheres[l];v.position.copy(h.position),v.material.color=this.color;var f=this.edges[l];f.material.color=this.color,f.position.copy(h.position),f.geometry.vertices[0].set(0,0,0),f.geometry.vertices[1].copy(d.position).sub(h.position),f.geometry.verticesNeedUpdate=!0,f.geometry.computeBoundingSphere(),f.visible=l<i||this.closed;var m=this.edgeLabels[s],g=(new THREE.Vector3).add(h.position);g.add(d.position),g=g.multiplyScalar(.5);var y=h.position.distanceTo(d.position);m.position.copy(g),m.setText(Pt.utils.addCommas(y.toFixed(2))+" "+this.lengthUnit.code),m.visible=this.showDistances&&(l<i||this.closed)&&2<=this.points.length&&0<y;var E=this.angleLabels[s],T=this.getAngleBetweenLines(h,p,d),P=d.position.clone().sub(p.position);P.multiplyScalar(.5),P=p.position.clone().add(P).sub(h.position).normalize();var b=Math.min(h.position.distanceTo(p.position),h.position.distanceTo(d.position));b/=9;var w=h.position.clone().add(P.multiplyScalar(b));E.position.copy(w);var x=Pt.utils.addCommas((T*(180/Math.PI)).toFixed(1))+"°";E.setText(x),E.visible=this.showAngles&&(l<i||this.closed)&&3<=this.points.length&&0<T}var _=this.heightEdge;if(_.visible=this.showHeight,this.heightLabel.visible=this.showHeight,this.showHeight){var R=this.points.slice().sort(function(e,t){return e.position.z-t.position.z}),C=R[0].position.clone(),S=R[R.length-1].position.clone(),A=C.z,H=S.z,k=H-A,L=new THREE.Vector3(S.x,S.y,A),M=new THREE.Vector3(S.x,S.y,H);_.position.copy(C),_.geometry.vertices[0].set(0,0,0),_.geometry.vertices[1].copy(L).sub(C),_.geometry.vertices[2].copy(L).sub(C),_.geometry.vertices[3].copy(M).sub(C),_.geometry.verticesNeedUpdate=!0,_.geometry.computeBoundingSphere();var D=L.clone().add(M).multiplyScalar(.5);this.heightLabel.position.copy(D);var B=Pt.utils.addCommas(k.toFixed(2))+" "+this.lengthUnit.code;this.heightLabel.setText(B)}this.areaLabel.position.copy(r),this.areaLabel.visible=this.showArea&&3<=this.points.length;var N=Pt.utils.addCommas(this.getArea().toFixed(1))+" "+this.lengthUnit.code+"²";this.areaLabel.setText(N)}}},{key:"raycast",value:function(e,t){for(var n=0;n<this.points.length;n++){this.spheres[n].raycast(e,t)}for(var i=0;i<t.length;i++){var r=t[i];r.distance=e.ray.origin.distanceTo(r.point)}t.sort(function(e,t){return e.distance-t.distance})}},{key:"showCoordinates",get:function(){return this._showCoordinates},set:function(e){this._showCoordinates=e,this.update()}},{key:"showAngles",get:function(){return this._showAngles},set:function(e){this._showAngles=e,this.update()}},{key:"showHeight",get:function(){return this._showHeight},set:function(e){this._showHeight=e,this.update()}},{key:"showArea",get:function(){return this._showArea},set:function(e){this._showArea=e,this.update()}},{key:"closed",get:function(){return this._closed},set:function(e){this._closed=e,this.update()}},{key:"showDistances",get:function(){return this._showDistances},set:function(e){this._showDistances=e,this.update()}}]),i}(),Pt.MeasuringTool=function(e){function l(e){_classCallCheck(this,l);var t=_possibleConstructorReturn(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));t.viewer=e,t.renderer=e.renderer,t.addEventListener("start_inserting_measurement",function(e){t.viewer.dispatchEvent({type:"cancel_insertions"})}),t.scene=new THREE.Scene,t.scene.name="scene_measurement",t.light=new THREE.PointLight(16777215,1),t.scene.add(t.light),t.viewer.inputHandler.registerInteractiveScene(t.scene),t.onRemove=function(e){t.scene.remove(e.measurement)};var n=!0,i=!(t.onAdd=function(e){t.scene.add(e.measurement)}),r=void 0;try{for(var o,a=e.scene.measurements[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;t.onAdd({measurement:s})}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return e.addEventListener("update",t.update.bind(t)),e.addEventListener("render.pass.perspective_overlay",t.render.bind(t)),e.addEventListener("scene_changed",t.onSceneChange.bind(t)),e.scene.addEventListener("measurement_added",t.onAdd),e.scene.addEventListener("measurement_removed",t.onRemove),t}return _inherits(l,THREE.EventDispatcher),_createClass(l,[{key:"onSceneChange",value:function(e){e.oldScene&&(e.oldScene.removeEventListener("measurement_added",this.onAdd),e.oldScene.removeEventListener("measurement_removed",this.onRemove)),e.scene.addEventListener("measurement_added",this.onAdd),e.scene.addEventListener("measurement_removed",this.onRemove)}},{key:"startInsertion",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=this.viewer.renderer.domElement,i=new Pt.Measure;this.dispatchEvent({type:"start_inserting_measurement",measure:i}),i.showDistances=null===e.showDistances||e.showDistances,i.showArea=e.showArea||!1,i.showAngles=e.showAngles||!1,i.showCoordinates=e.showCoordinates||!1,i.showHeight=e.showHeight||!1,i.closed=e.closed||!1,i.maxMarkers=e.maxMarkers||1/0,i.name=e.name||"Measurement",this.scene.add(i);var r={removeLastMarker:3<i.maxMarkers,callback:null},o=function(e){e.button===THREE.MOUSE.LEFT?(i.addMarker(i.points[i.points.length-1].position.clone()),i.points.length>=i.maxMarkers&&r.callback(),t.viewer.inputHandler.startDragging(i.spheres[i.spheres.length-1])):e.button===THREE.MOUSE.RIGHT&&r.callback()};return r.callback=function(e){r.removeLastMarker&&i.removeMarker(i.points.length-1),n.removeEventListener("mouseup",o,!0),t.viewer.removeEventListener("cancel_insertions",r.callback)},1<i.maxMarkers&&(this.viewer.addEventListener("cancel_insertions",r.callback),n.addEventListener("mouseup",o,!0)),i.addMarker(new THREE.Vector3(0,0,0)),this.viewer.inputHandler.startDragging(i.spheres[i.spheres.length-1]),this.viewer.scene.addMeasurement(i),i}},{key:"update",value:function(){var e=this.viewer.scene.getActiveCamera(),t=(this.renderer.domElement,this.viewer.scene.measurements),n=this.renderer.getSize().width,i=this.renderer.getSize().height;this.light.position.copy(e.position);var r=!0,o=!1,a=void 0;try{for(var s,l=t[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value;u.lengthUnit=this.viewer.lengthUnit,u.update();var c=!0,h=!1,d=void 0;try{for(var p,v=u.spheres[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){var f=p.value,m=e.position.distanceTo(f.getWorldPosition()),g=15/Pt.utils.projectedRadius(1,e,m,n,i);f.scale.set(g,g,g)}}catch(e){h=!0,d=e}finally{try{!c&&v.return&&v.return()}finally{if(h)throw d}}var y=u.edgeLabels.concat(u.angleLabels),E=!0,T=!1,P=void 0;try{for(var b,w=y[Symbol.iterator]();!(E=(b=w.next()).done);E=!0){var x=b.value,_=e.position.distanceTo(x.getWorldPosition()),R=70/Pt.utils.projectedRadius(1,e,_,n,i);x.scale.set(R,R,R)}}catch(e){T=!0,P=e}finally{try{!E&&w.return&&w.return()}finally{if(T)throw P}}for(var C=0;C<u.coordinateLabels.length;C++){var S=u.coordinateLabels[C],A=u.spheres[C],H=e.position.distanceTo(A.getWorldPosition()),k=A.getWorldPosition().clone().project(e);k.x=Math.round((k.x+1)*n/2),k.y=Math.round((1-k.y)*i/2),k.z=0,k.y-=30;var L=new THREE.Vector3(k.x/n*2-1,-k.y/i*2+1,.5);if(L.unproject(e),this.viewer.scene.cameraMode==Pt.CameraMode.PERSPECTIVE){var M=L.sub(e.position).normalize();L=(new THREE.Vector3).addVectors(e.position,M.multiplyScalar(H))}S.position.copy(L);var D=70/Pt.utils.projectedRadius(1,e,H,n,i);S.scale.set(D,D,D)}if(u.showHeight){var B=u.heightLabel,N=B.position.distanceTo(e.position),I=70/Pt.utils.projectedRadius(1,e,N,n,i);B.scale.set(I,I,I);var O=u.heightEdge,V=O.geometry.vertices[0].clone().add(O.position),z=O.geometry.vertices[2].clone().add(O.position),U=O.geometry.vertices[3].clone().add(O.position),F=V.clone().project(e),G=z.clone().project(e),j=U.clone().project(e),W=function(e){var t=e.clone().addScalar(1).divideScalar(2);return t.x=t.x*n,t.y=t.y*i,t.z=0,t},X=W(F),Y=W(G),q=W(j),Q=X.distanceTo(Y),K=Y.distanceTo(q);O.geometry.lineDistances=[0,Q,Q,Q+K],O.geometry.lineDistancesNeedUpdate=!0,O.material.dashSize=10,O.material.gapSize=10}var $=u.areaLabel,Z=$.position.distanceTo(e.position),J=70/Pt.utils.projectedRadius(1,e,Z,n,i);$.scale.set(J,J,J)}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}}},{key:"render",value:function(){this.viewer.renderer.render(this.scene,this.viewer.scene.getActiveCamera())}}]),l}(),Pt.Volume=function(e){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,r);var i=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));i.constructor.counter=void 0===i.constructor.counter?0:i.constructor.counter+1,i.name="volume_"+i.constructor.counter,i._clip=e.clip||!1,i._visible=!0,i.showVolumeLabel=!0,i._modifiable=e.modifiable||!0;var t=new THREE.BoxGeometry(1,1,1);t.computeBoundingBox();var n=new THREE.Geometry;return n.vertices.push(new THREE.Vector3(-.5,-.5,.5)),n.vertices.push(new THREE.Vector3(.5,-.5,.5)),n.vertices.push(new THREE.Vector3(.5,-.5,.5)),n.vertices.push(new THREE.Vector3(.5,-.5,-.5)),n.vertices.push(new THREE.Vector3(.5,-.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,-.5,.5)),n.vertices.push(new THREE.Vector3(-.5,.5,.5)),n.vertices.push(new THREE.Vector3(.5,.5,.5)),n.vertices.push(new THREE.Vector3(.5,.5,.5)),n.vertices.push(new THREE.Vector3(.5,.5,-.5)),n.vertices.push(new THREE.Vector3(.5,.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,.5,.5)),n.vertices.push(new THREE.Vector3(-.5,-.5,.5)),n.vertices.push(new THREE.Vector3(-.5,.5,.5)),n.vertices.push(new THREE.Vector3(.5,-.5,.5)),n.vertices.push(new THREE.Vector3(.5,.5,.5)),n.vertices.push(new THREE.Vector3(.5,-.5,-.5)),n.vertices.push(new THREE.Vector3(.5,.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),n.vertices.push(new THREE.Vector3(-.5,.5,-.5)),i.dimension=new THREE.Vector3(1,1,1),i.material=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:.3,depthTest:!0,depthWrite:!1}),i.box=new THREE.Mesh(t,i.material),i.box.geometry.computeBoundingBox(),i.boundingBox=i.box.geometry.boundingBox,i.add(i.box),i.frame=new THREE.LineSegments(n,new THREE.LineBasicMaterial({color:0})),i.add(i.frame),i.label=new Pt.TextSprite("0"),i.label.setBorderColor({r:0,g:255,b:0,a:0}),i.label.setBackgroundColor({r:0,g:255,b:0,a:0}),i.label.material.depthTest=!1,i.label.material.depthWrite=!1,i.label.material.transparent=!0,i.label.position.y-=.5,i.add(i.label),i.label.updateMatrixWorld=function(){var e=new THREE.Vector3;e.setFromMatrixPosition(i.matrixWorld),i.label.position.copy(e),i.label.updateMatrix(),i.label.matrixWorld.copy(i.label.matrix),i.label.matrixWorldNeedsUpdate=!1;for(var t=0,n=i.label.children.length;t<n;t++)i.label.children[t].updateMatrixWorld(!0)},i.addEventListener("select",function(e){}),i.addEventListener("deselect",function(e){}),i.update(),i}return _inherits(r,THREE.Object3D),_createClass(r,[{key:"getVolume",value:function(){return Math.abs(this.scale.x*this.scale.y*this.scale.z)}},{key:"update",value:function(){this.boundingBox=this.box.geometry.boundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(new THREE.Sphere),this._clip?(this.box.visible=!1,this.label.visible=!1):(this.box.visible=!0,this.label.visible=this.showVolumeLabel)}},{key:"raycast",value:function(e,t){var n=[];if(this.box.raycast(e,n),0<n.length){var i=n[0];t.push({distance:i.distance,object:this,point:i.point.clone()})}}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible!==e&&(this._visible=e,this.dispatchEvent({type:"visibility_changed",object:this}))}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip=e,this.update(),this.dispatchEvent({type:"clip_changed",object:this}))}},{key:"modifieable",get:function(){return this._modifiable},set:function(e){this._modifiable=e,this.update()}}]),r}(),Pt.VolumeTool=function(e){function l(e){_classCallCheck(this,l);var t=_possibleConstructorReturn(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));t.viewer=e,t.renderer=e.renderer,t.addEventListener("start_inserting_volume",function(e){t.viewer.dispatchEvent({type:"cancel_insertions"})}),t.scene=new THREE.Scene,t.scene.name="scene_volume",t.viewer.inputHandler.registerInteractiveScene(t.scene),t.onRemove=function(e){t.scene.remove(e.volume)};var n=!0,i=!(t.onAdd=function(e){t.scene.add(e.volume)}),r=void 0;try{for(var o,a=e.scene.volumes[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;t.onAdd({volume:s})}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return t.viewer.inputHandler.addEventListener("delete",function(e){e.selection.filter(function(e){return e instanceof Pt.Volume}).forEach(function(e){return t.viewer.scene.removeVolume(e)})}),e.addEventListener("update",t.update.bind(t)),e.addEventListener("render.pass.scene",function(e){return t.render(e)}),e.addEventListener("scene_changed",t.onSceneChange.bind(t)),e.scene.addEventListener("volume_added",t.onAdd),e.scene.addEventListener("volume_removed",t.onRemove),t}return _inherits(l,THREE.EventDispatcher),_createClass(l,[{key:"onSceneChange",value:function(e){e.oldScene&&(e.oldScene.removeEventListeners("volume_added",this.onAdd),e.oldScene.removeEventListeners("volume_removed",this.onRemove)),e.scene.addEventListener("volume_added",this.onAdd),e.scene.addEventListener("volume_removed",this.onRemove)}},{key:"startInsertion",value:function(){var o=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=new Pt.Volume;a.clip=e.clip||!1,a.name=e.name||"Volume",this.dispatchEvent({type:"start_inserting_volume",volume:a}),this.viewer.scene.addVolume(a),this.scene.add(a);var n={callback:null},i=function(e){var t=o.viewer.scene.getActiveCamera(),n=Pt.utils.getMousePointCloudIntersection(e.drag.end,o.viewer.scene.getActiveCamera(),o.viewer,o.viewer.scene.pointclouds);if(n){a.position.copy(n.location);var i=a.getWorldPosition().applyMatrix4(t.matrixWorldInverse),r=Math.abs(i.z/5);a.scale.set(r,r,r)}},t=function e(t){a.removeEventListener("drag",i),a.removeEventListener("drop",e),n.callback()};return n.callback=function(e){a.removeEventListener("drag",i),a.removeEventListener("drop",t),o.viewer.removeEventListener("cancel_insertions",n.callback)},a.addEventListener("drag",i),a.addEventListener("drop",t),this.viewer.addEventListener("cancel_insertions",n.callback),this.viewer.inputHandler.startDragging(a),a}},{key:"update",value:function(){if(this.viewer.scene){var e=this.viewer.scene.getActiveCamera(),t=this.viewer.renderer.getSize().width,n=this.viewer.renderer.getSize().height,i=this.viewer.scene.volumes,r=!0,o=!1,a=void 0;try{for(var s,l=i[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value,c=u.label,h=c.position.distanceTo(e.position),d=70/Pt.utils.projectedRadius(1,e,h,t,n);c.scale.set(d,d,d);var p=Pt.utils.addCommas(u.getVolume().toFixed(3))+"³";c.setText(p)}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}}}},{key:"render",value:function(e){this.viewer.renderer.render(this.scene,this.viewer.scene.getActiveCamera(),e.renderTarget)}}]),l}(),Pt.Box3Helper=function(e){function a(e,t){_classCallCheck(this,a),void 0===t&&(t=16776960);var n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array([e.min.x,e.min.y,e.min.z,e.max.x,e.min.y,e.min.z,e.max.x,e.min.y,e.max.z,e.min.x,e.min.y,e.max.z,e.min.x,e.max.y,e.min.z,e.max.x,e.max.y,e.min.z,e.max.x,e.max.y,e.max.z,e.min.x,e.max.y,e.max.z]),r=new THREE.BufferGeometry;r.setIndex(new THREE.BufferAttribute(n,1)),r.addAttribute("position",new THREE.BufferAttribute(i,3));var o=new THREE.LineBasicMaterial({color:t});return _possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,r,o))}return _inherits(a,THREE.LineSegments),a}(),Pt.PointCloudSM=function(){function t(e){_classCallCheck(this,t),this.potreeRenderer=e,this.threeRenderer=this.potreeRenderer.threeRenderer,this.target=new THREE.WebGLRenderTarget(2048,2048,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),this.target.depthTexture=new THREE.DepthTexture,this.target.depthTexture.type=THREE.UnsignedIntType,this.threeRenderer.setClearColor(0,1),this.threeRenderer.clearTarget(this.target,!0,!0,!0)}return _createClass(t,[{key:"setLight",value:function(e){var t=180*(this.light=e).angle/Math.PI,n=e.shadow.mapSize.width/e.shadow.mapSize.height,i=0===e.distance?1e4:e.distance;this.camera=new THREE.PerspectiveCamera(t,n,.1,i),this.camera.up.set(0,0,1),this.camera.position.copy(e.position);var r=(new THREE.Vector3).addVectors(e.position,e.getWorldDirection());this.camera.lookAt(r),this.camera.updateProjectionMatrix(),this.camera.updateMatrix(),this.camera.updateMatrixWorld(),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld)}},{key:"setSize",value:function(e,t){this.target.width===e&&this.target.height===t||this.target.dispose(),this.target.setSize(e,t)}},{key:"render",value:function(e,t){this.threeRenderer.clearTarget(this.target,!0,!0,!0),this.potreeRenderer.render(e,this.camera,this.target,{})}}]),t}(),Pt.Message=function(){function n(e){_classCallCheck(this,n),this.content=e;var t=Pt.resourcePath+"/icons/close.svg";this.element=$('\n\t\t\t<div class="potree_message">\n\t\t\t\t<span name="content_container" style="flex-grow: 1; padding: 5px"></span>\n\t\t\t\t<img name="close" src="'+t+'" class="button-icon" style="width: 16px; height: 16px;">\n\t\t\t</div>'),this.elClose=this.element.find("img[name=close]"),this.elContainer=this.element.find("span[name=content_container]"),"string"==typeof e?this.elContainer.append($("<span>"+e+"</span>")):this.elContainer.append(e)}return _createClass(n,[{key:"setMessage",value:function(e){this.elContainer.empty(),"string"==typeof e?this.elContainer.append($("<span>"+e+"</span>")):this.elContainer.append(e)}}]),n}(),Pt.SpotLightHelper=function(e){function l(e,t){_classCallCheck(this,l);var n=_possibleConstructorReturn(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));n.light=e,n.color=t,n.updateMatrix(),n.updateMatrixWorld();var i=new THREE.SphereGeometry(1,32,32),r=new THREE.MeshNormalMaterial;n.sphere=new THREE.Mesh(i,r),n.sphere.scale.set(.5,.5,.5),n.add(n.sphere);var o=new Float32Array([0,0,0,0,0,1,0,0,0,-1,-1,1,0,0,0,1,-1,1,0,0,0,1,1,1,0,0,0,-1,1,1,-1,-1,1,1,-1,1,1,-1,1,1,1,1,1,1,1,-1,1,1,-1,1,1,-1,-1,1]),a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.BufferAttribute(o,3));var s=new THREE.LineBasicMaterial;return n.frustum=new THREE.LineSegments(a,s),n.add(n.frustum),n.update(),n}return _inherits(l,THREE.Object3D),_createClass(l,[{key:"update",value:function(){this.light.updateMatrix(),this.light.updateMatrixWorld();var e=this.light.position,t=(new THREE.Vector3).addVectors(light.position,this.light.getWorldDirection().multiplyScalar(-1)),n=(new THREE.Quaternion).setFromRotationMatrix((new THREE.Matrix4).lookAt(e,t,new THREE.Vector3(0,0,1)));this.setRotationFromQuaternion(n),this.position.copy(e);var i=0<this.light.distance?this.light.distance:1e3,r=i*Math.tan(.5*this.light.angle);this.frustum.scale.set(r,r,i)}}]),l}(),Pt.GeoJSONExporter=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"measurementToFeatures",value:function(e){var t=e.points.map(function(e){return e.position.toArray()}),n=[];if(1===t.length){var i={type:"Feature",geometry:{type:"Point",coordinates:t[0]},properties:{name:e.name}};n.push(i)}else if(1<t.length&&!e.closed){var r={type:"Feature",geometry:{type:"LineString",coordinates:t},properties:{name:e.name}};n.push(r)}else if(1<t.length&&e.closed){var o={type:"Feature",geometry:{type:"Polygon",coordinates:[[].concat(_toConsumableArray(t),[t[0]])]},properties:{name:e.name}};n.push(o)}if(e.showDistances&&e.edgeLabels.forEach(function(e){var t={type:"Feature",geometry:{type:"Point",coordinates:e.position.toArray()},properties:{distance:e.text}};n.push(t)}),e.showArea){var a={type:"Feature",geometry:{type:"Point",coordinates:e.areaLabel.position.toArray()},properties:{area:e.areaLabel.text}};n.push(a)}return n}},{key:"toString",value:function(e){e instanceof Array||(e=[e]),e=e.filter(function(e){return e instanceof Pt.Measure});var t=[],n=!0,i=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value,l=Pt.GeoJSONExporter.measurementToFeatures(s);t=t.concat(l)}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}var u={type:"FeatureCollection",features:t};return JSON.stringify(u,null,"\t")}}]),e}(),Pt.CSVExporter=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"toString",value:function(e){var t="",n=Object.keys(e.data).filter(function(e){return"normal"!==e}).sort(function(e,t){return"position"===e?-1:"position"===t?1:"color"===e?-1:"color"===t?1:void 0}),i=[],r=!0,o=!1,a=void 0;try{for(var s,l=n[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value,c=e.data[u].length/e.numPoints;if("position"===u)i=i.concat(["x","y","z"]);else if("color"===u)i=i.concat(["r","g","b","a"]);else if(1<c)for(var h=0;h<c;h++)i.push(u+"_"+h);else i.push(u)}}catch(e){o=!0,a=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw a}}t=i.join(", ")+"\n";for(var d=0;d<e.numPoints;d++){var p=[],v=!0,f=!1,m=void 0;try{for(var g,y=n[Symbol.iterator]();!(v=(g=y.next()).done);v=!0){var E=g.value,T=e.data[E].length/e.numPoints,P=e.data[E].subarray(T*d,T*d+T).join(", ");p.push(P)}}catch(e){f=!0,m=e}finally{try{!v&&y.return&&y.return()}finally{if(f)throw m}}t+=p.join(", ")+"\n"}return t}}]),e}(),Pt.LASExporter=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"toLAS",value:function(e){var t=e.boundingBox,n=t.min.clone(),i=t.min.distanceTo(t.max),r=new THREE.Vector3(.001,.001,.001);r=1e6<i?new THREE.Vector3(.01,.01,.01):new THREE.Vector3(.001,.001,.001);var o=function(e,t,n){for(var i=new Uint8Array(n),r=0;r<e.length;r++){var o=e.charCodeAt(r);i[t+r]=o}},a=new ArrayBuffer(227+28*e.numPoints),s=new DataView(a),l=new Uint8Array(a);o("LASF",0,a),l[24]=1,l[25]=2,o("Pt 1.5",58,a),s.setUint16(94,227,!0),s.setUint32(96,227,!0),l[104]=2,s.setUint16(105,28,!0),s.setUint32(107,e.numPoints,!0),s.setFloat64(131,r.x,!0),s.setFloat64(139,r.y,!0),s.setFloat64(147,r.z,!0),s.setFloat64(155,n.x,!0),s.setFloat64(163,n.y,!0),s.setFloat64(171,n.z,!0),s.setFloat64(179,t.max.x,!0),s.setFloat64(187,t.min.x,!0),s.setFloat64(195,t.max.y,!0),s.setFloat64(203,t.min.y,!0),s.setFloat64(211,t.max.z,!0),s.setFloat64(219,t.min.z,!0);for(var u=227,c=0;c<e.numPoints;c++){var h=e.data.position[3*c+0],d=e.data.position[3*c+1],p=e.data.position[3*c+2],v=parseInt((h-n.x)/r.x),f=parseInt((d-n.y)/r.y),m=parseInt((p-n.z)/r.z);s.setUint32(u+0,v,!0),s.setUint32(u+4,f,!0),s.setUint32(u+8,m,!0),e.data.intensity&&s.setUint16(u+12,e.data.intensity[c],!0);var g=0;e.data.returnNumber&&(g+=e.data.returnNumber[c]),e.data.numberOfReturns&&(g+=e.data.numberOfReturns[c]<<3),s.setUint8(u+14,g),e.data.classification&&s.setUint8(u+15,e.data.classification[c]),e.data.pointSourceID&&s.setUint16(u+18,e.data.pointSourceID[c]),e.data.color&&(s.setUint16(u+20,255*e.data.color[4*c+0],!0),s.setUint16(u+22,255*e.data.color[4*c+1],!0),s.setUint16(u+24,255*e.data.color[4*c+2],!0)),u+=28}return a}}]),e}();var PotreeRenderer=function(){function t(e){_classCallCheck(this,t),this.viewer=e}return _createClass(t,[{key:"render",value:function(){var e=this.viewer,t=Pt.startQuery("render",e.renderer.getContext());e.dispatchEvent({type:"render.pass.begin",viewer:e}),"skybox"===e.background?(e.renderer.clear(!0,!0,!1),e.skybox.camera.rotation.copy(e.scene.cameraP.rotation),e.skybox.camera.fov=e.scene.cameraP.fov,e.skybox.camera.aspect=e.scene.cameraP.aspect,e.skybox.camera.updateProjectionMatrix(),e.renderer.render(e.skybox.scene,e.skybox.camera)):"gradient"===e.background?(e.renderer.clear(!0,!0,!1),e.renderer.render(e.scene.sceneBG,e.scene.cameraBG)):("black"===e.background?e.renderer.setClearColor(0,1):"white"===e.background?e.renderer.setClearColor(16777215,1):e.renderer.setClearColor(0,0),e.renderer.clear(!0,!0,!1));var n=!0,i=!1,r=void 0;try{for(var o,a=this.viewer.scene.pointclouds[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){o.value.material.useEDL=!1}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}var s=e.scene.getActiveCamera();e.pRenderer.render(e.scene.scenePointCloud,s),e.renderer.render(e.scene.scene,s),e.dispatchEvent({type:"render.pass.scene",viewer:e}),e.renderer.render(e.controls.sceneControls,s),e.renderer.clearDepth(),e.dispatchEvent({type:"render.pass.perspective_overlay",viewer:e}),e.renderer.setViewport(0,0,e.renderer.domElement.clientWidth,e.renderer.domElement.clientHeight),e.dispatchEvent({type:"render.pass.end",viewer:e}),Pt.endQuery(t,e.renderer.getContext())}}]),t}(),EDLRenderer=function(){function t(e){_classCallCheck(this,t),this.viewer=e,this.edlMaterial=null,this.rtRegular,this.rtEDL,this.gl=e.renderer.context,this.shadowMap=new Pt.PointCloudSM(this.viewer.pRenderer)}return _createClass(t,[{key:"initEDL",value:function(){null==this.edlMaterial&&(this.edlMaterial=new Pt.EyeDomeLightingMaterial,this.edlMaterial.depthTest=!0,this.edlMaterial.depthWrite=!0,this.edlMaterial.transparent=!0,this.rtEDL=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType,depthTexture:new THREE.DepthTexture(void 0,void 0,THREE.UnsignedIntType)}),this.rtRegular=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,depthTexture:new THREE.DepthTexture(void 0,void 0,THREE.UnsignedIntType)}))}},{key:"resize",value:function(){var e=this.viewer,t=e.renderer.getPixelRatio(),n=e.renderer.getSize(),i=n.width,r=n.height;this.screenshot&&(i=this.screenshot.target.width,r=this.screenshot.target.height),this.rtEDL.setSize(i*t,r*t),this.rtRegular.setSize(i*t,r*t)}},{key:"makeScreenshot",value:function(e,t,n){null==e&&(e=this.viewer.scene.getActiveCamera()),null==t&&(t=this.viewer.renderer.getSize());var i=t,r=i.width,o=i.height;r*=2,o*=2;var a=new THREE.WebGLRenderTarget(r,o,{format:THREE.RGBAFormat});this.screenshot={target:a},this.viewer.renderer.clearTarget(a,!0,!0,!0),this.render();var s=new Uint8Array(4*(r*o));this.viewer.renderer.readRenderTargetPixels(a,0,0,r,o,s);for(var l=4*r,u=0;u<parseInt(o/2);u++){var c=o-u-1,h=s.slice(u*l,u*l+l),d=s.slice(c*l,c*l+l);s.set(d,u*l),s.set(h,c*l)}return this.screenshot.target.dispose(),delete this.screenshot,{width:r,height:o,buffer:s}}},{key:"render",value:function(){this.initEDL();var e=this.viewer;if(e.dispatchEvent({type:"render.pass.begin",viewer:e}),this.resize(),this.screenshot){var t=Pt.pointBudget;Pt.pointBudget=Math.max(1e7,2*t);Pt.updatePointClouds(e.scene.pointclouds,e.scene.getActiveCamera(),e.renderer);Pt.pointBudget=t}var n=e.scene.getActiveCamera(),i=[];e.scene.scene.traverse(function(e){e instanceof THREE.SpotLight&&i.push(e)});var r=Pt.startQuery("EDL - Skybox",e.renderer.getContext());if("skybox"===e.background?(e.renderer.setClearColor(0,0),e.renderer.clear(),e.skybox.camera.rotation.copy(e.scene.cameraP.rotation),e.skybox.camera.fov=e.scene.cameraP.fov,e.skybox.camera.aspect=e.scene.cameraP.aspect,e.skybox.camera.updateProjectionMatrix(),e.renderer.render(e.skybox.scene,e.skybox.camera)):"gradient"===e.background?(e.renderer.setClearColor(0,0),e.renderer.clear(),e.renderer.render(e.scene.sceneBG,e.scene.cameraBG)):("black"===e.background?e.renderer.setClearColor(0,1):"white"===e.background?e.renderer.setClearColor(16777215,1):e.renderer.setClearColor(0,0),e.renderer.clear()),Pt.endQuery(r,e.renderer.getContext()),0<i.length&&!i[0].disableShadowUpdates){var o=i[0],a=Pt.startQuery("EDL - shadows",e.renderer.getContext());this.shadowMap.setLight(o);var s=new Map,l=!0,u=!1,c=void 0;try{for(var h,d=e.scene.pointclouds[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var p=h.value;s.set(p,p.material.pointColorType),p.material.disableEvents(),p.material.pointColorType=Pt.PointColorType.DEPTH}}catch(e){u=!0,c=e}finally{try{!l&&d.return&&d.return()}finally{if(u)throw c}}this.shadowMap.render(e.scene.scenePointCloud,n);var v=!0,f=!1,m=void 0;try{for(var g,y=e.scene.pointclouds[Symbol.iterator]();!(v=(g=y.next()).done);v=!0){var E=g.value,T=s.get(E);E.material.pointColorType=T,E.material.enableEvents()}}catch(e){f=!0,m=e}finally{try{!v&&y.return&&y.return()}finally{if(f)throw m}}e.shadowTestCam.updateMatrixWorld(),e.shadowTestCam.matrixWorldInverse.getInverse(e.shadowTestCam.matrixWorld),e.shadowTestCam.updateProjectionMatrix(),Pt.endQuery(a,e.renderer.getContext())}var P=Pt.startQuery("EDL - colorpass",e.renderer.getContext());e.renderer.render(e.scene.scene,n),e.renderer.clearTarget(this.rtEDL,!0,!0,!0),e.renderer.clearTarget(this.rtRegular,!0,!0,!1);var b=e.renderer.getSize().width,w=e.renderer.getSize().height,x=!0,_=!1,R=void 0;try{for(var C,S=e.scene.pointclouds[Symbol.iterator]();!(x=(C=S.next()).done);x=!0){var A=C.value,H=A.pcoGeometry.boundingBox.getSize(new THREE.Vector3).x,k=A.material;k.weighted=!1,k.useLogarithmicDepthBuffer=!1,k.useEDL=!0,k.screenWidth=b,k.screenHeight=w,k.uniforms.visibleNodes.value=A.material.visibleNodesTexture,k.uniforms.octreeSize.value=H,k.spacing=A.pcoGeometry.spacing*Math.max(A.scale.x,A.scale.y,A.scale.z)}}catch(e){_=!0,R=e}finally{try{!x&&S.return&&S.return()}finally{if(_)throw R}}0<i.length?e.pRenderer.render(e.scene.scenePointCloud,n,this.rtEDL,{shadowMaps:[this.shadowMap],transparent:!1}):e.pRenderer.render(e.scene.scenePointCloud,n,this.rtEDL,{transparent:!1}),e.renderer.render(e.scene.scene,n,this.rtRegular),e.dispatchEvent({type:"render.pass.scene",viewer:e,renderTarget:this.rtRegular}),Pt.endQuery(P,e.renderer.getContext());var L=Pt.startQuery("EDL - resolve",e.renderer.getContext());this.edlMaterial.uniforms.screenWidth.value=b,this.edlMaterial.uniforms.screenHeight.value=w,this.edlMaterial.uniforms.uRegularColor.value=this.rtRegular.texture,this.edlMaterial.uniforms.uEDLColor.value=this.rtEDL.texture,this.edlMaterial.uniforms.uRegularDepth.value=this.rtRegular.depthTexture,this.edlMaterial.uniforms.uEDLDepth.value=this.rtEDL.depthTexture,this.edlMaterial.uniforms.edlStrength.value=e.edlStrength,this.edlMaterial.uniforms.radius.value=e.edlRadius,this.edlMaterial.uniforms.opacity.value=1,Pt.utils.screenPass.render(e.renderer,this.edlMaterial),this.screenshot&&Pt.utils.screenPass.render(e.renderer,this.edlMaterial,this.screenshot.target),Pt.endQuery(L,e.renderer.getContext());var M=Pt.startQuery("EDL - rest",e.renderer.getContext());e.renderer.clearDepth(),e.dispatchEvent({type:"render.pass.perspective_overlay",viewer:e}),e.renderer.render(e.controls.sceneControls,n),e.renderer.setViewport(0,0,b,w),e.dispatchEvent({type:"render.pass.end",viewer:e}),Pt.endQuery(M,e.renderer.getContext())}}]),t}();Pt.View=function(){function e(){_classCallCheck(this,e),this.position=new THREE.Vector3(0,0,0),this.yaw=Math.PI/4,this._pitch=-Math.PI/4,this.radius=1,this.maxPitch=Math.PI/2,this.minPitch=-Math.PI/2,this.navigationMode=Pt.OrbitControls}return _createClass(e,[{key:"clone",value:function(){var e=new Pt.View;return e.yaw=this.yaw,e._pitch=this.pitch,e.radius=this.radius,e.maxPitch=this.maxPitch,e.minPitch=this.minPitch,e.navigationMode=this.navigationMode,e}},{key:"lookAt",value:function(e){var t=void 0;1===arguments.length?t=(new THREE.Vector3).subVectors(e,this.position):3===arguments.length&&(t=(new THREE.Vector3).subVectors(new(Function.prototype.bind.apply(THREE.Vector3,[null].concat(Array.prototype.slice.call(arguments)))),this.position));var n=t.length(),i=t.normalize();this.radius=n,this.direction=i}},{key:"getPivot",value:function(){return(new THREE.Vector3).addVectors(this.position,this.direction.multiplyScalar(this.radius))}},{key:"getSide",value:function(){var e=new THREE.Vector3(1,0,0);return e.applyAxisAngle(new THREE.Vector3(0,0,1),this.yaw),e}},{key:"pan",value:function(e,t){var n=new THREE.Vector3(0,1,0);n.applyAxisAngle(new THREE.Vector3(1,0,0),this.pitch),n.applyAxisAngle(new THREE.Vector3(0,0,1),this.yaw);var i=this.getSide(),r=i.clone().cross(n),o=i.multiplyScalar(e).add(r.multiplyScalar(t));this.position=this.position.add(o)}},{key:"translate",value:function(e,t,n){var i=new THREE.Vector3(0,1,0);i.applyAxisAngle(new THREE.Vector3(1,0,0),this.pitch),i.applyAxisAngle(new THREE.Vector3(0,0,1),this.yaw);var r=new THREE.Vector3(1,0,0);r.applyAxisAngle(new THREE.Vector3(0,0,1),this.yaw);var o=r.clone().cross(i),a=r.multiplyScalar(e).add(i.multiplyScalar(t)).add(o.multiplyScalar(n));this.position=this.position.add(a)}},{key:"translateWorld",value:function(e,t,n){this.position.x+=e,this.position.y+=t,this.position.z+=n}},{key:"pitch",get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Math.min(e,this.maxPitch),this.minPitch)}},{key:"direction",get:function(){var e=new THREE.Vector3(0,1,0);return e.applyAxisAngle(new THREE.Vector3(1,0,0),this.pitch),e.applyAxisAngle(new THREE.Vector3(0,0,1),this.yaw),e},set:function(e){if(0===e.x&&0===e.y)this.pitch=Math.PI/2*Math.sign(e.z);else{var t=Math.atan2(e.y,e.x)-Math.PI/2,n=Math.atan2(e.z,Math.sqrt(e.x*e.x+e.y*e.y));this.yaw=t,this.pitch=n}}}]),e}(),Pt.Scene=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.annotations=new Pt.Annotation,e.scene=new THREE.Scene,e.sceneBG=new THREE.Scene,e.scenePointCloud=new THREE.Scene,e.cameraP=new THREE.PerspectiveCamera(e.fov,1,.1,1e6),e.cameraO=new THREE.OrthographicCamera(-1,1,1,-1,.1,1e6),e.cameraBG=new THREE.Camera,e.cameraScreenSpace=new THREE.OrthographicCamera(-1,1,1,-1,.1,10),e.cameraMode=Pt.CameraMode.PERSPECTIVE,e.pointclouds=[],e.measurements=[],e.profiles=[],e.volumes=[],e.polygonClipVolumes=[],e.fpControls=null,e.orbitControls=null,e.earthControls=null,e.geoControls=null,e.inputHandler=null,e.view=new Pt.View,e.directionalLight=null,e.initialize(),e}return _inherits(t,THREE.EventDispatcher),_createClass(t,[{key:"estimateHeightAt",value:function(e){var t=null,n=1/0,i=!0,r=!1,o=void 0;try{for(var a,s=this.pointclouds[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value;if(void 0!==l.root.geometryNode){var u=null,c=1/0,h=e.clone().sub(l.position);h.z=0;for(var d=new THREE.Ray(h,new THREE.Vector3(0,0,1)),p=[l.root];0<p.length;){var v=p.pop(),f=v.getBoundingBox();if(d.intersectBox(f)){var m=v.geometryNode.mean.z+l.position.z+v.geometryNode.boundingBox.min.z;v.geometryNode.spacing<=c&&(u=m,c=v.geometryNode.spacing);var g=!0,y=!1,E=void 0;try{for(var T,P=Object.keys(v.children)[Symbol.iterator]();!(g=(T=P.next()).done);g=!0){var b=T.value;v.children[b].geometryNode&&p.push(v.children[b])}}catch(e){y=!0,E=e}finally{try{!g&&P.return&&P.return()}finally{if(y)throw E}}}}(null===t||c<n)&&(t=u,n=c)}}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}return t}},{key:"getBoundingBox",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.pointclouds,t=new THREE.Box3;this.scenePointCloud.updateMatrixWorld(!0),this.referenceFrame.updateMatrixWorld(!0);var n=!0,i=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;s.updateMatrixWorld(!0);var l=s.pcoGeometry.tightBoundingBox?s.pcoGeometry.tightBoundingBox:s.boundingBox,u=Pt.utils.computeTransformedBoundingBox(l,s.matrixWorld);t.union(u)}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return t}},{key:"addPointCloud",value:function(e){this.pointclouds.push(e),this.scenePointCloud.add(e),this.dispatchEvent({type:"pointcloud_added",pointcloud:e})}},{key:"addVolume",value:function(e){this.volumes.push(e),this.dispatchEvent({type:"volume_added",scene:this,volume:e})}},{key:"removeVolume",value:function(e){var t=this.volumes.indexOf(e);-1<t&&(this.volumes.splice(t,1),this.dispatchEvent({type:"volume_removed",scene:this,volume:e}))}},{key:"addPolygonClipVolume",value:function(e){this.polygonClipVolumes.push(e),this.dispatchEvent({type:"polygon_clip_volume_added",scene:this,volume:e})}},{key:"removePolygonClipVolume",value:function(e){var t=this.polygonClipVolumes.indexOf(e);-1<t&&(this.polygonClipVolumes.splice(t,1),this.dispatchEvent({type:"polygon_clip_volume_removed",scene:this,volume:e}))}},{key:"addMeasurement",value:function(e){e.lengthUnit=this.lengthUnit,this.measurements.push(e),this.dispatchEvent({type:"measurement_added",scene:this,measurement:e})}},{key:"removeMeasurement",value:function(e){var t=this.measurements.indexOf(e);-1<t&&(this.measurements.splice(t,1),this.dispatchEvent({type:"measurement_removed",scene:this,measurement:e}))}},{key:"addProfile",value:function(e){this.profiles.push(e),this.dispatchEvent({type:"profile_added",scene:this,profile:e})}},{key:"removeProfile",value:function(e){var t=this.profiles.indexOf(e);-1<t&&(this.profiles.splice(t,1),this.dispatchEvent({type:"profile_removed",scene:this,profile:e}))}},{key:"removeAllMeasurements",value:function(){for(;0<this.measurements.length;)this.removeMeasurement(this.measurements[0]);for(;0<this.profiles.length;)this.removeProfile(this.profiles[0]);for(;0<this.volumes.length;)this.removeVolume(this.volumes[0])}},{key:"removeAllClipVolumes",value:function(){var e=this.volumes.filter(function(e){return!0===e.clip}),t=!0,n=!1,i=void 0;try{for(var r,o=e[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;this.removeVolume(a)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}for(;0<this.polygonClipVolumes.length;)this.removePolygonClipVolume(this.polygonClipVolumes[0])}},{key:"getActiveCamera",value:function(){return this.cameraMode==Pt.CameraMode.PERSPECTIVE?this.cameraP:this.cameraO}},{key:"initialize",value:function(){this.referenceFrame=new THREE.Object3D,this.referenceFrame.matrixAutoUpdate=!1,this.scenePointCloud.add(this.referenceFrame),this.cameraP.up.set(0,0,1),this.cameraP.position.set(1e3,1e3,1e3),this.cameraO.up.set(0,0,1),this.cameraO.position.set(1e3,1e3,1e3),this.cameraScreenSpace.lookAt(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(0,1,0)),this.directionalLight=new THREE.DirectionalLight(16777215,.5),this.directionalLight.position.set(10,10,10),this.directionalLight.lookAt(new THREE.Vector3(0,0,0)),this.scenePointCloud.add(this.directionalLight);var e=new THREE.AmbientLight(5592405);this.scenePointCloud.add(e);var t=Pt.utils.createSkyBackgroundTexture(1024,1024);t.minFilter=t.magFilter=THREE.NearestFilter,t.minFilter=t.magFilter=THREE.LinearFilter;var n=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2,0),new THREE.MeshBasicMaterial({map:t}));n.material.depthTest=!1,n.material.depthWrite=!1,this.sceneBG.add(n);var i=new THREE.DirectionalLight(16777215);i.position.set(10,10,1),i.target.position.set(0,0,0),this.scene.add(i);var r=new THREE.DirectionalLight(16777215);r.position.set(-10,10,1),r.target.position.set(0,0,0),this.scene.add(r);var o=new THREE.DirectionalLight(16777215);o.position.set(0,-10,20),o.target.position.set(0,0,0),this.scene.add(o)}},{key:"addAnnotation",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};e instanceof Array?t.position=(new THREE.Vector3).fromArray(e):e instanceof THREE.Vector3&&(t.position=e);var n=new Pt.Annotation(t);return this.annotations.add(n),n}},{key:"getAnnotations",value:function(){return this.annotations}},{key:"removeAnnotation",value:function(e){this.annotations.remove(e)}}]),t}(),Pt.Viewer=function(e){function a(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));n.renderArea=e,n.guiLoaded=!1,n.guiLoadTasks=[],n.messages=[];try{n.pointCloudLoadedCallback=t.onPointCloudLoaded||function(){},n.server=null,n.fov=60,n.isFlipYZ=!1,n.useDEMCollisions=!1,n.generateDEM=!1,n.minNodeSize=30,n.edlStrength=1,n.edlRadius=1.4,n.useEDL=!1,n.classifications={0:{visible:!0,name:"never classified"},1:{visible:!0,name:"unclassified"},2:{visible:!0,name:"ground"},3:{visible:!0,name:"low vegetation"},4:{visible:!0,name:"medium vegetation"},5:{visible:!0,name:"high vegetation"},6:{visible:!0,name:"building"},7:{visible:!0,name:"low point(noise)"},8:{visible:!0,name:"key-point"},9:{visible:!0,name:"water"},12:{visible:!0,name:"overlap"}},n.moveSpeed=10,n.LENGTH_UNITS={METER:{code:"m"},FEET:{code:"ft"},INCH:{code:"″"}},n.lengthUnit=n.LENGTH_UNITS.METER,n.showBoundingBox=!1,n.showAnnotations=!1,n.freeze=!1,n.clipTask=Pt.ClipTask.HIGHLIGHT,n.clipMethod=Pt.ClipMethod.INSIDE_ANY,n.potreeRenderer=null,n.edlRenderer=null,n.renderer=null,n.pRenderer=null,n.scene=null,n.overlay=null,n.overlayCamera=null,n.inputHandler=null,n.skybox=null,n.clock=new THREE.Clock,n.background=null,n.initThree(),n.overlay=new THREE.Scene,n.overlayCamera=new THREE.OrthographicCamera(0,1,1,0,-1e3,1e3),n.pRenderer=new Pt.Renderer(n.renderer);n.shadowTestCam=new THREE.PerspectiveCamera(90,1,2.5,10),n.shadowTestCam.position.set(3.5,-2.8,8.561),n.shadowTestCam.lookAt(new THREE.Vector3(0,0,4.87));var i=new Pt.Scene(n.renderer);n.setScene(i),n.inputHandler=new Pt.InputHandler(n),n.inputHandler.setScene(n.scene),n.createControls();var r=function(e){if(1===n.scene.pointclouds.length){var t=e.pointcloud.boundingBox.getSize(new THREE.Vector3).length();t/=5,n.setMoveSpeed(t)}},o=function(e){n.inputHandler.deselect(e.volume)};n.addEventListener("scene_changed",function(e){n.inputHandler.setScene(e.scene),e.scene.hasEventListener("pointcloud_added",r)||e.scene.addEventListener("pointcloud_added",r),e.scene.hasEventListener("volume_removed",r)||e.scene.addEventListener("volume_removed",o)}),n.scene.addEventListener("volume_removed",o),n.scene.addEventListener("pointcloud_added",r),n.setFOV(60),n.setEDLEnabled(!1),n.setEDLRadius(1.4),n.setEDLStrength(.4),n.setPointBudget(1e6),n.setShowBoundingBox(!1),n.setFreeze(!1),n.setNavigationMode(Pt.OrbitControls),n.setBackground("gradient"),n.scaleFactor=1,n.loadSettingsFromURL(),void 0!==t.useDefaultRenderLoop&&!0!==t.useDefaultRenderLoop||requestAnimationFrame(n.loop.bind(n)),n.loadGUI=n.loadGUI.bind(n)}catch(e){n.onCrash(e)}return n}return _inherits(a,THREE.EventDispatcher),_createClass(a,[{key:"onCrash",value:function(e){if($(this.renderArea).empty(),0===$(this.renderArea).find("#pt_failpage").length){var t=$('\n\t\t\t<div id="#pt_failpage" class="pt_failpage"> \n\t\t\t\t\n\t\t\t\t<h1>发生了一个错误 </h1>\n\n\t\t\t\t<p>\n\t\t\t\t可能是因为您的机器不支持WEBGL的功能，优先检查您的显卡。\n\t\t\t\t<br>\n\t\t\t\t您可以访问以下浏览器\n\t\t\t\t<a href="https://www.google.com/chrome/browser" target="_blank" style="color:initial">Chrome</a>\n\t\t\t\t或者 \n\t\t\t\t<a href="https://www.mozilla.org/" target="_blank">Firefox</a>.\n\t\t\t\t</p>\n\n\t\t\t\t<p>\n\t\t\t\t访问网址 <a href="http://webglreport.com/" target="_blank">webglreport.com</a> 去检测您的机器是否支持WEBGL \n\t\t\t\t</p>\n\t\t\t\t<p>\n\t\t\t\t如果您已经使用了推荐的浏览器，并且您的机器也支持WEBGL，建议您发送邮件可以联系我们 \n\t\t\t\t <a href="support@dilutech.com" target="_blank">DILU TECH</a>,<br>\n\t\t\t\t邮件里要包含以下内容：操作系统、显卡类型、浏览器、浏览器版本信息、以及错误信息截图。<br>\t\t\t\t\n\t\t\t\t</p>\n\n\t\t\t\t<pre id="pt_error_console" style="width: 100%; height: 100%"></pre>\n\t\t\t\t\n\t\t\t</div>');t.find("#pt_error_console").html(e.stack),$(this.renderArea).append(t)}throw e}},{key:"setScene",value:function(e){if(e!==this.scene){var t=this.scene;this.scene=e,this.dispatchEvent({type:"scene_changed",oldScene:t,scene:e})}}},{key:"getControls",value:function(e){return e===Pt.OrbitControls?this.orbitControls:e===Pt.EarthControls?this.earthControls:null}},{key:"getMinNodeSize",value:function(){return this.minNodeSize}},{key:"setMinNodeSize",value:function(e){this.minNodeSize!==e&&(this.minNodeSize=e,this.dispatchEvent({type:"minnodesize_changed",viewer:this}))}},{key:"getBackground",value:function(){return this.background}},{key:"setBackground",value:function(e){this.background!==e&&("skybox"===e&&(this.skybox=Pt.utils.loadSkybox(new URL(Pt.resourcePath+"/textures/sunny/").href)),this.background=e,this.dispatchEvent({type:"background_changed",viewer:this}))}},{key:"setDescription",value:function(e){$("#potree_description")[0].innerHTML=e}},{key:"setNavigationMode",value:function(e){this.scene.view.navigationMode=e}},{key:"setShowBoundingBox",value:function(e){this.showBoundingBox!==e&&(this.showBoundingBox=e,this.dispatchEvent({type:"show_boundingbox_changed",viewer:this}))}},{key:"getShowBoundingBox",value:function(){return this.showBoundingBox}},{key:"setMoveSpeed",value:function(e){this.moveSpeed!==e&&(this.moveSpeed=e,this.dispatchEvent({type:"move_speed_changed",viewer:this,speed:e}))}},{key:"getMoveSpeed",value:function(){return this.moveSpeed}},{key:"setWeightClassification",value:function(e){for(var t=0;t<this.scene.pointclouds.length;t++)this.scene.pointclouds[t].material.weightClassification=e,this.dispatchEvent({type:"attribute_weights_changed"+t,viewer:this})}},{key:"setFreeze",value:function(e){e=Boolean(e),this.freeze!==e&&(this.freeze=e,this.dispatchEvent({type:"freeze_changed",viewer:this}))}},{key:"getFreeze",value:function(){return this.freeze}},{key:"setPointBudget",value:function(e){Pt.pointBudget!==e&&(Pt.pointBudget=parseInt(e),this.dispatchEvent({type:"point_budget_changed",viewer:this}))}},{key:"getPointBudget",value:function(){return Pt.pointBudget}},{key:"setShowAnnotations",value:function(e){this.showAnnotations!==e&&(this.showAnnotations=e,this.dispatchEvent({type:"show_annotations_changed",viewer:this}))}},{key:"getShowAnnotations",value:function(){return this.showAnnotations}},{key:"setDEMCollisionsEnabled",value:function(e){this.useDEMCollisions!==e&&(this.useDEMCollisions=e,this.dispatchEvent({type:"use_demcollisions_changed",viewer:this}))}},{key:"getDEMCollisionsEnabled",value:function(){return this.useDEMCollisions}},{key:"setEDLEnabled",value:function(e){e=Boolean(e),this.useEDL!==e&&(this.useEDL=e,this.dispatchEvent({type:"use_edl_changed",viewer:this}))}},{key:"getEDLEnabled",value:function(){return this.useEDL}},{key:"setEDLRadius",value:function(e){this.edlRadius!==e&&(this.edlRadius=e,this.dispatchEvent({type:"edl_radius_changed",viewer:this}))}},{key:"getEDLRadius",value:function(){return this.edlRadius}},{key:"setEDLStrength",value:function(e){this.edlStrength!==e&&(this.edlStrength=e,this.dispatchEvent({type:"edl_strength_changed",viewer:this}))}},{key:"getEDLStrength",value:function(){return this.edlStrength}},{key:"setFOV",value:function(e){this.fov!==e&&(this.fov=e,this.dispatchEvent({type:"fov_changed",viewer:this}))}},{key:"getFOV",value:function(){return this.fov}},{key:"disableAnnotations",value:function(){this.scene.annotations.traverse(function(e){e.domElement.css("pointer-events","none")})}},{key:"enableAnnotations",value:function(){this.scene.annotations.traverse(function(e){e.domElement.css("pointer-events","auto")})}},{key:"setClassificationVisibility",value:function(e,t){this.classifications[e]?this.classifications[e].visible!==t&&(this.classifications[e].visible=t,this.dispatchEvent({type:"classification_visibility_changed",viewer:this})):(this.classifications[e]={visible:t,name:"no name"},this.dispatchEvent({type:"classification_visibility_changed",viewer:this}))}},{key:"setLengthUnit",value:function(e){switch(e){case"m":this.lengthUnit=this.LENGTH_UNITS.METER;break;case"ft":this.lengthUnit=this.LENGTH_UNITS.FEET;break;case"in":this.lengthUnit=this.LENGTH_UNITS.INCH}this.dispatchEvent({type:"length_unit_changed",viewer:this,value:e})}},{key:"zoomTo",value:function(e,t){var n=this,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=this.scene.view,o=this.scene.cameraP.clone();o.rotation.copy(this.scene.cameraP.rotation),o.rotation.order="ZXY",o.rotation.x=Math.PI/2+r.pitch,o.rotation.z=r.yaw,o.updateMatrix(),o.updateMatrixWorld(),o.zoomTo(e,t);var a=void 0;a=(a=e.boundingSphere?e.boundingSphere:e.geometry&&e.geometry.boundingSphere?e.geometry.boundingSphere:e.boundingBox.getBoundingSphere(new THREE.Sphere)).clone().applyMatrix4(e.matrixWorld);var s=r.position.clone(),l=o.position.clone(),u=r.getPivot(),c=a.center,h=(r.radius,l.distanceTo(c),TWEEN.Easing.Quartic.Out),d=s.clone(),p=new TWEEN.Tween(d).to(l,i);p.easing(h),p.onUpdate(function(){r.position.copy(d)}),p.start();var v=u.clone(),f=new TWEEN.Tween(v).to(c,i);f.easing(h),f.onUpdate(function(){r.lookAt(v)}),f.onComplete(function(){r.lookAt(v),n.dispatchEvent({type:"focusing_finished",target:n})}),this.dispatchEvent({type:"focusing_started",target:this}),f.start()}},{key:"showAbout",value:function(){$(function(){$("#about-panel").dialog()})}},{key:"getBoundingBox",value:function(e){return this.scene.getBoundingBox(e)}},{key:"fitToScreen",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=this.getBoundingBox(this.scene.pointclouds),i=new THREE.Object3D;i.boundingBox=n,this.zoomTo(i,e,t),this.controls.stop()}},{key:"setView",value:function(e){if(e)switch(e){case"F":this.setFrontView();break;case"B":this.setBackView();break;case"L":this.setLeftView();break;case"R":this.setRightView();break;case"U":this.setTopView();break;case"D":this.setBottomView()}}},{key:"setTopView",value:function(){this.scene.view.yaw=0,this.scene.view.pitch=-Math.PI/2,this.fitToScreen()}},{key:"setBottomView",value:function(){this.scene.view.yaw=-Math.PI,this.scene.view.pitch=Math.PI/2,this.fitToScreen()}},{key:"setFrontView",value:function(){this.scene.view.yaw=0,this.scene.view.pitch=0,this.fitToScreen()}},{key:"setBackView",value:function(){this.scene.view.yaw=Math.PI,this.scene.view.pitch=0,this.fitToScreen()}},{key:"setLeftView",value:function(){this.scene.view.yaw=-Math.PI/2,this.scene.view.pitch=0,this.fitToScreen()}},{key:"setRightView",value:function(){this.scene.view.yaw=Math.PI/2,this.scene.view.pitch=0,this.fitToScreen()}},{key:"flipYZ",value:function(){this.isFlipYZ=!this.isFlipYZ,console.log("TODO")}},{key:"setCameraMode",value:function(e){this.scene.cameraMode=e;var t=!0,n=!1,i=void 0;try{for(var r,o=this.scene.pointclouds[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){r.value.material.useOrthographicCamera=e==Pt.CameraMode.ORTHOGRAPHIC}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"loadSettingsFromURL",value:function(){if(Pt.utils.getParameterByName("pointSize")&&this.setPointSize(parseFloat(Pt.utils.getParameterByName("pointSize"))),Pt.utils.getParameterByName("FOV")&&this.setFOV(parseFloat(Pt.utils.getParameterByName("FOV"))),Pt.utils.getParameterByName("opacity")&&this.setOpacity(parseFloat(Pt.utils.getParameterByName("opacity"))),Pt.utils.getParameterByName("edlEnabled")){var e="true"===Pt.utils.getParameterByName("edlEnabled");this.setEDLEnabled(e)}(Pt.utils.getParameterByName("edlRadius")&&this.setEDLRadius(parseFloat(Pt.utils.getParameterByName("edlRadius"))),Pt.utils.getParameterByName("edlStrength")&&this.setEDLStrength(parseFloat(Pt.utils.getParameterByName("edlStrength"))),Pt.utils.getParameterByName("pointBudget")&&this.setPointBudget(parseFloat(Pt.utils.getParameterByName("pointBudget"))),Pt.utils.getParameterByName("showBoundingBox"))&&("true"===Pt.utils.getParameterByName("showBoundingBox")?this.setShowBoundingBox(!0):this.setShowBoundingBox(!1));if(Pt.utils.getParameterByName("material")){var t=Pt.utils.getParameterByName("material");this.setMaterial(t)}if(Pt.utils.getParameterByName("pointSizing")){var n=Pt.utils.getParameterByName("pointSizing");this.setPointSizing(n)}if(Pt.utils.getParameterByName("quality")){var i=Pt.utils.getParameterByName("quality");this.setQuality(i)}if(Pt.utils.getParameterByName("position")){var r=Pt.utils.getParameterByName("position"),o=(r=r.replace("[","").replace("]","")).split(";"),a=parseFloat(o[0]),s=parseFloat(o[1]),l=parseFloat(o[2]);this.scene.view.position.set(a,s,l)}if(Pt.utils.getParameterByName("target")){var u=Pt.utils.getParameterByName("target"),c=(u=u.replace("[","").replace("]","")).split(";"),h=parseFloat(c[0]),d=parseFloat(c[1]),p=parseFloat(c[2]);this.scene.view.lookAt(new THREE.Vector3(h,d,p))}if(Pt.utils.getParameterByName("background")){var v=Pt.utils.getParameterByName("background");this.setBackground(v)}}},{key:"createControls",value:function(){this.orbitControls=new Pt.OrbitControls(this),this.orbitControls.enabled=!1,this.orbitControls.addEventListener("start",this.disableAnnotations.bind(this)),this.orbitControls.addEventListener("end",this.enableAnnotations.bind(this)),this.earthControls=new Pt.EarthControls(this),this.earthControls.enabled=!1,this.earthControls.addEventListener("start",this.disableAnnotations.bind(this)),this.earthControls.addEventListener("end",this.enableAnnotations.bind(this))}},{key:"onGUILoaded",value:function(e){this.guiLoaded?e():this.guiLoadTasks.push(e)}},{key:"loadGUI",value:function(e){var o=this;this.onGUILoaded(e);var n=this,i=$("#potree_sidebar_container");i.load(new URL(Pt.scriptPath+"/sidebar.html").href,function(){i.css("width","300px"),i.css("height","100%");var e=document.createElement("img");e.src=new URL(Pt.resourcePath+"/icons/menu_button.svg").href,e.onclick=o.toggleSidebar,e.classList.add("potree_menu_toggle");var t=document.createElement("img");t.src=new URL(Pt.resourcePath+"/icons/map_icon.png").href,t.style.display="none",t.onclick=function(e){o.toggleMap()},t.id="potree_map_toggle",n.renderArea.insertBefore(t,n.renderArea.children[0]),n.renderArea.insertBefore(e,n.renderArea.children[0]),o.mapView=new Pt.MapView(o),o.mapView.init(),i18n.init({lng:"en",resGetPath:Pt.resourcePath+"/lang/__lng__/__ns__.json",preload:["en","fr","de","jp"],getAsync:!0,debug:!1},function(e){$("body").i18n()}),$(function(){initSidebar(o);var e=$("<div>").load(new URL(Pt.scriptPath+"/profile.html").href,function(){$(document.body).append(e.children()),o.profileWindow=new Pt.ProfileWindow(o),o.profileWindowController=new Pt.ProfileWindowController(o),$("#profile_window").draggable({handle:$("#profile_titlebar"),containment:$(document.body)}),$("#profile_window").resizable({containment:$(document.body),handles:"n, e, s, w"}),$(function(){var e=o.guiLoaded=!0,t=!1,n=void 0;try{for(var i,r=o.guiLoadTasks[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){(0,i.value)()}}catch(e){t=!0,n=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw n}}})})})})}},{key:"setServer",value:function(e){this.server=e}},{key:"initThree",value:function(){var e=this,t=this.renderArea.clientWidth,n=this.renderArea.clientHeight;this.renderer=new THREE.WebGLRenderer({alpha:!0,premultipliedAlpha:!1}),this.renderer.sortObjects=!1,this.renderer.setSize(t,n),this.renderer.autoClear=!1,this.renderArea.appendChild(this.renderer.domElement),this.renderer.domElement.tabIndex="2222",this.renderer.domElement.style.position="relative",this.renderer.domElement.addEventListener("mousedown",function(){e.renderer.domElement.focus()});var i=this.renderer.context;i.getExtension("EXT_frag_depth"),i.getExtension("WEBGL_depth_texture");var r=i.getExtension("OES_vertex_array_object");i.createVertexArray=r.createVertexArrayOES.bind(r),i.bindVertexArray=r.bindVertexArrayOES.bind(r)}},{key:"updateAnnotations",value:function(){var h=this;this.visibleAnnotations||(this.visibleAnnotations=new Set),this.scene.annotations.updateBounds(),this.scene.cameraP.updateMatrixWorld(),this.scene.cameraO.updateMatrixWorld();var d=this.renderer.getSize().width,p=this.renderer.getSize().height,v=this,f=[];this.scene.annotations.traverse(function(e){if(e===h.scene.annotations)return!0;if(!e.visible)return!1;e.scene=h.scene;var t=e.domElement,n=e.position;n||(n=e.boundingBox.getCenter());var i=v.scene.cameraP.position.distanceTo(n),r=e.boundingBox.getBoundingSphere(new THREE.Sphere).radius,o=new THREE.Vector3,a=0;if(o.copy(n).project(h.scene.getActiveCamera()),o.x=d*(o.x+1)/2,o.y=p*(1-(o.y+1)/2),v.scene.cameraMode==Pt.CameraMode.PERSPECTIVE){var s=Math.PI*v.scene.cameraP.fov/180,l=Math.tan(s/2);a=r*(.5*p/(l*i))}else a=Pt.utils.projectedRadiusOrtho(r,v.scene.cameraO.projectionMatrix,d,p);t.css("left",o.x+"px"),t.css("top",o.y+"px");var u=1e7-i*(1e7/h.scene.cameraP.far);if(e.descriptionVisible&&(u+=1e7),t.css("z-index",parseInt(u)),0<e.children.length){var c=a>e.collapseThreshold||e.boundingBox.containsPoint(h.scene.getActiveCamera().position);if(!(e.expand=c))-1<=o.z&&o.z<=1&&f.push(e);return c}-1<=o.z&&o.z<=1&&f.push(e)});var e=new Set(this.visibleAnnotations),t=!0,n=!1,i=void 0;try{for(var r,o=f[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;a.display=!0,e.delete(a)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}this.visibleAnnotations=f;var s=!0,l=!1,u=void 0;try{for(var c,m=e[Symbol.iterator]();!(s=(c=m.next()).done);s=!0){c.value.display=!1}}catch(e){l=!0,u=e}finally{try{!s&&m.return&&m.return()}finally{if(l)throw u}}}},{key:"update",value:function(e,t){Pt.measureTimings&&performance.mark("update-start");var n=.5*Math.sin(5e-4*t)-.4,i=Math.cos(n),r=Math.sin(n);this.shadowTestCam.position.set(7*i,7*r,8.561),this.shadowTestCam.lookAt(new THREE.Vector3(0,0,0));var o=this.scene,a=o.getActiveCamera();Pt.pointLoadLimit=2*Pt.pointBudget,this.scene.directionalLight.position.copy(a.position),this.scene.directionalLight.lookAt((new THREE.Vector3).addVectors(a.position,a.getWorldDirection(new THREE.Vector3)));var s=!0,l=!1,u=void 0;try{for(var c,h=this.scene.pointclouds[Symbol.iterator]();!(s=(c=h.next()).done);s=!0){var d=c.value;if(!d.material._defaultIntensityRangeChanged){var p=d.pcoGeometry.root;if(null!=p&&p.loaded){var v=d.pcoGeometry.root.geometry.attributes;if(v.intensity){for(var f=v.intensity.array,m=[],g=0;g<f.length;g++)m.push(f[g]);m.sort();var y=m[parseInt(.75*(m.length-1))];d.material.intensityRange=y<=1?[0,1]:y<=256?[0,255]:[0,y]}}}d.showBoundingBox=this.showBoundingBox,d.generateDEM=this.generateDEM,d.minimumNodePixelSize=this.minNodeSize}}catch(e){l=!0,u=e}finally{try{!s&&h.return&&h.return()}finally{if(l)throw u}}var E=!0,T=!1,P=void 0;try{for(var b,w=this.scene.pointclouds[Symbol.iterator]();!(E=(b=w.next()).done);E=!0){var x=b.value,_=x.material.classification,R=!1,C=!0,S=!1,A=void 0;try{for(var H,k=Object.keys(this.classifications)[Symbol.iterator]();!(C=(H=k.next()).done);C=!0){var L=H.value,M=this.classifications[L].visible?1:0;_[L]?_[L].w!==M&&(_[L].w=M,R=!0):R=(_.DEFAULT?_[L]=_.DEFAULT:_[L]=new THREE.Vector4(.3,.6,.6,.5),!0)}}catch(e){S=!0,A=e}finally{try{!C&&k.return&&k.return()}finally{if(S)throw A}}R&&x.material.recomputeClassification()}}catch(e){T=!0,P=e}finally{try{!E&&w.return&&w.return()}finally{if(T)throw P}}if(this.showBoundingBox){var D=this.scene.scene.getObjectByName("potree_bounding_box_root");if(!D){var B=new THREE.Object3D;B.name="potree_bounding_box_root",this.scene.scene.add(B),D=B}var N=[],I=!0,O=!1,V=void 0;try{for(var z,U=this.scene.pointclouds[Symbol.iterator]();!(I=(z=U.next()).done);I=!0){var F=z.value,G=!0,j=!1,W=void 0;try{for(var X,Y=F.visibleNodes.filter(function(e){return void 0!==e.boundingBoxNode})[Symbol.iterator]();!(G=(X=Y.next()).done);G=!0){var q=X.value.boundingBoxNode;N.push(q)}}catch(e){j=!0,W=e}finally{try{!G&&Y.return&&Y.return()}finally{if(j)throw W}}}}catch(e){O=!0,V=e}finally{try{!I&&U.return&&U.return()}finally{if(O)throw V}}D.children=N}if(!this.freeze){var Q=Pt.updatePointClouds(o.pointclouds,a,this.renderer);if(Q.lowestSpacing!==1/0){var K=10*Q.lowestSpacing,$=-this.getBoundingBox().applyMatrix4(a.matrixWorldInverse).min.z;$=Math.max(1.5*$,1e3),K=Math.min(100,Math.max(.01,K)),$=Math.max($,K+1e3),K===1/0&&(K=.1),a.near=K,a.far=$}this.scene.cameraMode==Pt.CameraMode.ORTHOGRAPHIC&&(a.near=-a.far)}this.scene.cameraP.fov=this.fov,this.getControls(o.view.navigationMode)!==this.controls&&(this.controls&&(this.controls.enabled=!1,this.inputHandler.removeInputListener(this.controls)),this.controls=this.getControls(o.view.navigationMode),this.controls.enabled=!0,this.inputHandler.addInputListener(this.controls)),null!==this.controls&&(this.controls.setScene(o),this.controls.update(e),this.scene.cameraP.position.copy(o.view.position),this.scene.cameraP.rotation.order="ZXY",this.scene.cameraP.rotation.x=Math.PI/2+this.scene.view.pitch,this.scene.cameraP.rotation.z=this.scene.view.yaw,this.scene.cameraO.position.copy(o.view.position),this.scene.cameraO.rotation.order="ZXY",this.scene.cameraO.rotation.x=Math.PI/2+this.scene.view.pitch,this.scene.cameraO.rotation.z=this.scene.view.yaw),a.updateMatrix(),a.updateMatrixWorld(),a.matrixWorldInverse.getInverse(a.matrixWorld),void 0===this._previousCamera&&(this._previousCamera=this.scene.getActiveCamera().clone(),this._previousCamera.rotation.copy(this.scene.getActiveCamera())),this._previousCamera.matrixWorld.equals(a.matrixWorld)&&this._previousCamera.projectionMatrix.equals(a.projectionMatrix)||this.dispatchEvent({type:"camera_changed",previous:this._previousCamera,camera:a}),this._previousCamera=this.scene.getActiveCamera().clone(),this._previousCamera.rotation.copy(this.scene.getActiveCamera()),TWEEN.update(t),this.dispatchEvent({type:"update",delta:e,timestamp:t}),Pt.measureTimings&&(performance.mark("update-end"),performance.measure("update","update-start","update-end"))}},{key:"render",value:function(){Pt.measureTimings&&performance.mark("render-start");var e=this.scaleFactor*this.renderArea.clientWidth,t=this.scaleFactor*this.renderArea.clientHeight,n=(this.renderer.getPixelRatio(),e/t);this.scene.cameraP.aspect=n,this.scene.cameraP.updateProjectionMatrix();var i=this.scene.view.radius;this.scene.cameraO.left=-i,this.scene.cameraO.right=i,this.scene.cameraO.top=1*i/n,this.scene.cameraO.bottom=1*-i/n,this.scene.cameraO.updateProjectionMatrix(),this.scene.cameraScreenSpace.top=1/n,this.scene.cameraScreenSpace.bottom=-1/n,this.scene.cameraScreenSpace.updateProjectionMatrix(),this.renderer.setSize(e,t);try{this.useRep?(this.repRenderer||(this.repRenderer=new RepRenderer(this)),this.repRenderer.render(this.renderer)):this.useHQ?(this.hqRenderer||(this.hqRenderer=new HQSplatRenderer(this)),this.hqRenderer.useEDL=this.useEDL,this.hqRenderer.render(this.renderer)):this.useEDL&&Pt.Features.SHADER_EDL.isSupported()?(this.edlRenderer||(this.edlRenderer=new EDLRenderer(this)),this.edlRenderer.render(this.renderer)):(this.potreeRenderer||(this.potreeRenderer=new PotreeRenderer(this)),this.potreeRenderer.render()),this.renderer.render(this.overlay,this.overlayCamera)}catch(e){this.onCrash(e)}Pt.measureTimings&&(performance.mark("render-end"),performance.measure("render","render-start","render-end"))}},{key:"resolveTimings",value:function(e){if(Pt.measureTimings&&(this.toggle||(this.toggle=e),1e3<e-this.toggle)){var t=performance.getEntriesByType("measure"),n=new Set,i=!0,r=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value;n.add(l.name)}}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}var u=new Map,c=!0,h=!1,d=void 0;try{for(var p,v=n[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){var f=p.value;u.set(f,{measures:[],sum:0,n:0,min:1/0,max:-1/0})}}catch(e){h=!0,d=e}finally{try{!c&&v.return&&v.return()}finally{if(h)throw d}}var m=!0,g=!1,y=void 0;try{for(var E,T=t[Symbol.iterator]();!(m=(E=T.next()).done);m=!0){var P=E.value,b=u.get(P.name);b.measures.push(P),b.sum+=P.duration,b.n++,b.min=Math.min(b.min,P.duration),b.max=Math.max(b.max,P.duration)}}catch(e){g=!0,y=e}finally{try{!m&&T.return&&T.return()}finally{if(g)throw y}}var w=Pt.resolveQueries(this.renderer.getContext()),x=!0,_=!1,R=void 0;try{for(var C,S=w[Symbol.iterator]();!(x=(C=S.next()).done);x=!0){var A=_slicedToArray(C.value,2),H=A[0],k=A[1],L={measures:k.map(function(e){return{duration:e}}),sum:k.reduce(function(e,t){return e+t},0),n:k.length,min:Math.min.apply(Math,_toConsumableArray(k)),max:Math.max.apply(Math,_toConsumableArray(k))},M="[tq] "+H;u.set(M,L),n.add(M)}}catch(e){_=!0,R=e}finally{try{!x&&S.return&&S.return()}finally{if(_)throw R}}var D=!0,B=!1,N=void 0;try{for(var I,O=u[Symbol.iterator]();!(D=(I=O.next()).done);D=!0){var V=_slicedToArray(I.value,2),z=(V[0],V[1]);z.mean=z.sum/z.n,z.measures.sort(function(e,t){return e.duration-t.duration}),1===z.n?z.median=z.measures[0].duration:1<z.n&&(z.median=z.measures[parseInt(z.n/2)].duration)}}catch(e){B=!0,N=e}finally{try{!D&&O.return&&O.return()}finally{if(B)throw N}}var U=Array.from(n).reduce(function(e,t){return Math.max(e,t.length)},0)+5,F=" "+"NAME".padEnd(U)+" | "+"MIN".padStart(10)+" | "+"MEDIAN".padStart(10)+" | "+"MAX".padStart(10)+" | "+"SAMPLES".padStart(6)+" \n";F+=" "+"-".repeat(F.length)+"\n",n=Array.from(n).sort();var G=!0,j=!1,W=void 0;try{for(var X,Y=n[Symbol.iterator]();!(G=(X=Y.next()).done);G=!0){var q=X.value,Q=u.get(q),K=Q.min.toFixed(3),$=Q.median.toFixed(3),Z=Q.max.toFixed(3),J=Q.n;F+=" "+q.padEnd(U)+" | "+K.padStart(10)+" | "+$.padStart(10)+" | "+Z.padStart(10)+" | "+J.toString().padStart(6)+"\n"}}catch(e){j=!0,W=e}finally{try{!G&&Y.return&&Y.return()}finally{if(j)throw W}}F+="\n",console.log(F),performance.clearMarks(),performance.clearMeasures(),this.toggle=e}}},{key:"loop",value:function(e){requestAnimationFrame(this.loop.bind(this));Pt.measureTimings&&performance.mark("loop-start"),this.update(this.clock.getDelta(),e),this.render(),Pt.measureTimings&&(performance.mark("loop-end"),performance.measure("loop","loop-start","loop-end")),this.resolveTimings(e),Pt.framenumber++}},{key:"postError",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this.postMessage(e,t);return n.element.addClass("potree_message_error"),n}},{key:"postMessage",value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=new Pt.Message(e);if(i.element.css("display","none"),i.elClose.click(function(){i.element.slideToggle(100);var e=t.messages.indexOf(i);0<=e&&t.messages.splice(e,1)}),this.elMessages.prepend(i.element),i.element.slideToggle(100),this.messages.push(i),void 0!==n.duration){setTimeout(function(){i.element.animate({opacity:0},500),i.element.slideToggle(200)},n.duration)}return i}}]),a}(),Pt.GLProgram=function(){function n(e,t){_classCallCheck(this,n),this.gl=e,this.material=t,this.program=e.createProgram(),this.recompile()}return _createClass(n,[{key:"compileShader",value:function(e,t){var n=this.gl,i=n.createShader(e);if(n.shaderSource(i,t),n.compileShader(i),n.getShaderParameter(i,n.COMPILE_STATUS))return i;console.error("could not compile shader:");var r=n.getShaderInfoLog(i);return console.error(r,t),null}},{key:"recompile",value:function(){var e=this.gl,t=this.compileShader(e.VERTEX_SHADER,this.material.vertexShader),n=this.compileShader(e.FRAGMENT_SHADER,this.material.fragmentShader);if(null!==t&&null!==n){var i=this.program;if(e.attachShader(i,t),e.attachShader(i,n),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))return console.error("could not compile/link program:"),console.error(this.material.vertexShader),void console.error(this.material.fragmentShader);e.detachShader(i,t),e.detachShader(i,n),e.deleteShader(t),e.deleteShader(n),e.useProgram(i);for(var r={},o=e.getProgramParameter(i,e.ACTIVE_UNIFORMS),a=0;a<o;a++){var s=e.getActiveUniform(i,a).name,l=e.getUniformLocation(i,s);r[s]=l}this.uniforms=r}}}]),n}(),Pt.InterleavedBufferAttribute=function e(t,n,i,r,o){_classCallCheck(this,e),this.name=t,this.bytes=n,this.numElements=i,this.normalized=o,this.type=r},Pt.InterleavedBuffer=function(){function i(e,t,n){_classCallCheck(this,i),this.data=e,this.attributes=t,this.stride=t.reduce(function(e,t){return e+t.bytes},0),this.stride=4*Math.ceil(this.stride/4),this.numElements=n}return _createClass(i,[{key:"offset",value:function(e){var t=0,n=!0,i=!1,r=void 0;try{for(var o,a=this.attributes[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;if(s.name===e)return t;t+=s.bytes}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return null}}]),i}(),Pt.toInterleavedBufferAttribute=function(e){var t=null;return e.name===Pt.PointAttribute.POSITION_CARTESIAN.name?t=new Pt.InterleavedBufferAttribute("position",12,3,"FLOAT",!1):e.name===Pt.PointAttribute.COLOR_PACKED.name?t=new Pt.InterleavedBufferAttribute("color",4,4,"UNSIGNED_BYTE",!0):e.name===Pt.PointAttribute.INTENSITY.name?t=new Pt.InterleavedBufferAttribute("intensity",4,1,"FLOAT",!1):e.name===Pt.PointAttribute.CLASSIFICATION.name?t=new Pt.InterleavedBufferAttribute("classification",4,1,"FLOAT",!1):e.name===Pt.PointAttribute.RETURN_NUMBER.name?t=new Pt.InterleavedBufferAttribute("returnNumber",4,1,"FLOAT",!1):e.name===Pt.PointAttribute.NUMBER_OF_RETURNS.name?t=new Pt.InterleavedBufferAttribute("numberOfReturns",4,1,"FLOAT",!1):e.name===Pt.PointAttribute.SOURCE_ID.name?t=new Pt.InterleavedBufferAttribute("pointSourceID",4,1,"FLOAT",!1):e.name===Pt.PointAttribute.NORMAL_SPHEREMAPPED.name?t=new Pt.InterleavedBufferAttribute("normal",12,3,"FLOAT",!1):e.name===Pt.PointAttribute.NORMAL_OCT16.name?t=new Pt.InterleavedBufferAttribute("normal",12,3,"FLOAT",!1):e.name===Pt.PointAttribute.NORMAL.name&&(t=new Pt.InterleavedBufferAttribute("normal",12,3,"FLOAT",!1)),t};